"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationSecurityCheck = void 0;
const path = require("path");
const codebuild = require("../../../aws-codebuild");
const iam = require("../../../aws-iam");
const lambda = require("../../../aws-lambda");
const core_1 = require("../../../core");
const constructs_1 = require("constructs");
const default_codebuild_image_1 = require("./default-codebuild-image");
const custom_resources_1 = require("../../../custom-resources");
/**
 * A construct containing both the Lambda and CodeBuild Project
 * needed to conduct a security check on any given application stage.
 *
 * The Lambda acts as an auto approving mechanism that should only be
 * triggered when the CodeBuild Project registers no security changes.
 *
 * The CodeBuild Project runs a security diff on the application stage,
 * and exports the link to the console of the project.
 */
class ApplicationSecurityCheck extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        core_1.Tags.of(props.codePipeline).add('SECURITY_CHECK', 'ALLOW_APPROVE', {
            includeResourceTypes: ['AWS::CodePipeline::Pipeline'],
        });
        this.preApproveLambda = new lambda.Function(this, 'CDKPipelinesAutoApprove', {
            handler: 'index.handler',
            runtime: (0, custom_resources_1.builtInCustomResourceNodeRuntime)(this),
            code: lambda.Code.fromAsset(path.resolve(__dirname, 'approve-lambda')),
            timeout: core_1.Duration.minutes(5),
        });
        this.preApproveLambda.addToRolePolicy(new iam.PolicyStatement({
            actions: ['codepipeline:GetPipelineState', 'codepipeline:PutApprovalResult'],
            conditions: {
                StringEquals: {
                    'aws:ResourceTag/SECURITY_CHECK': 'ALLOW_APPROVE',
                },
            },
            resources: ['*'],
        }));
        const invokeLambda = 'aws lambda invoke' +
            ` --function-name ${this.preApproveLambda.functionName}` +
            ' --invocation-type Event' +
            ' --cli-binary-format raw-in-base64-out' +
            ' --payload "$payload"' +
            ' lambda.out';
        const message = [
            'An upcoming change would broaden security changes in $PIPELINE_NAME.',
            'Review and approve the changes in CodePipeline to proceed with the deployment.',
            '',
            'Review the changes in CodeBuild:',
            '',
            '$LINK',
            '',
            'Approve the changes in CodePipeline (stage $STAGE_NAME, action $ACTION_NAME):',
            '',
            '$PIPELINE_LINK',
        ];
        const publishNotification = 'aws sns publish' +
            ' --topic-arn $NOTIFICATION_ARN' +
            ' --subject "$NOTIFICATION_SUBJECT"' +
            ` --message "${message.join('\n')}"`;
        this.cdkDiffProject = new codebuild.Project(this, 'CDKSecurityCheck', {
            environment: {
                buildImage: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE,
            },
            buildSpec: codebuild.BuildSpec.fromObject({
                version: 0.2,
                phases: {
                    build: {
                        commands: [
                            'npm install -g aws-cdk',
                            // $CODEBUILD_INITIATOR will always be Code Pipeline and in the form of:
                            // "codepipeline/example-pipeline-name-Xxx"
                            'export PIPELINE_NAME="$(node -pe \'`${process.env.CODEBUILD_INITIATOR}`.split("/")[1]\')"',
                            'payload="$(node -pe \'JSON.stringify({ "PipelineName": process.env.PIPELINE_NAME, "StageName": process.env.STAGE_NAME, "ActionName": process.env.ACTION_NAME })\' )"',
                            // ARN: "arn:aws:codebuild:$region:$account_id:build/$project_name:$project_execution_id$"
                            'ARN=$CODEBUILD_BUILD_ARN',
                            'REGION="$(node -pe \'`${process.env.ARN}`.split(":")[3]\')"',
                            'ACCOUNT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[4]\')"',
                            'PROJECT_NAME="$(node -pe \'`${process.env.ARN}`.split(":")[5].split("/")[1]\')"',
                            'PROJECT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[6]\')"',
                            // Manual Approval adds 'http/https' to the resolved link
                            'export LINK="https://$REGION.console.aws.amazon.com/codesuite/codebuild/$ACCOUNT_ID/projects/$PROJECT_NAME/build/$PROJECT_NAME:$PROJECT_ID/?region=$REGION"',
                            'export PIPELINE_LINK="https://$REGION.console.aws.amazon.com/codesuite/codepipeline/pipelines/$PIPELINE_NAME/view?region=$REGION"',
                            // Run invoke only if cdk diff passes (returns exit code 0)
                            // 0 -> true, 1 -> false
                            ifElse({
                                condition: 'cdk diff -a . --security-only --fail $STAGE_PATH/\\*',
                                thenStatements: [
                                    invokeLambda,
                                    'export MESSAGE="No security-impacting changes detected."',
                                ],
                                elseStatements: [
                                    `[ -z "\${NOTIFICATION_ARN}" ] || ${publishNotification}`,
                                    'export MESSAGE="Deployment would make security-impacting changes. Click the link below to inspect them, then click Approve if all changes are expected."',
                                ],
                            }),
                        ],
                    },
                },
                env: {
                    'exported-variables': [
                        'LINK',
                        'MESSAGE',
                    ],
                },
            }),
        });
        // this is needed to check the status the stacks when doing `cdk diff`
        this.cdkDiffProject.addToRolePolicy(new iam.PolicyStatement({
            actions: ['sts:AssumeRole'],
            resources: ['*'],
            conditions: {
                'ForAnyValue:StringEquals': {
                    'iam:ResourceTag/aws-cdk:bootstrap-role': ['deploy'],
                },
            },
        }));
        this.preApproveLambda.grantInvoke(this.cdkDiffProject);
    }
}
exports.ApplicationSecurityCheck = ApplicationSecurityCheck;
const ifElse = ({ condition, thenStatements, elseStatements }) => {
    let statement = thenStatements.reduce((acc, ifTrue) => {
        return `${acc} ${ifTrue};`;
    }, `if ${condition}; then`);
    if (elseStatements) {
        statement = elseStatements.reduce((acc, ifFalse) => {
            return `${acc} ${ifFalse};`;
        }, `${statement} else`);
    }
    return `${statement} fi`;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tc2VjdXJpdHktY2hlY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi1zZWN1cml0eS1jaGVjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBNkI7QUFDN0Isb0RBQW9EO0FBRXBELHdDQUF3QztBQUN4Qyw4Q0FBOEM7QUFDOUMsd0NBQStDO0FBQy9DLDJDQUF1QztBQUN2Qyx1RUFBeUU7QUFDekUsZ0VBQTZFO0FBYzdFOzs7Ozs7Ozs7R0FTRztBQUNILE1BQWEsd0JBQXlCLFNBQVEsc0JBQVM7SUFxQnJELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBb0M7UUFDNUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixXQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFO1lBQ2pFLG9CQUFvQixFQUFFLENBQUMsNkJBQTZCLENBQUM7U0FDdEQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUseUJBQXlCLEVBQUU7WUFDM0UsT0FBTyxFQUFFLGVBQWU7WUFDeEIsT0FBTyxFQUFFLElBQUEsbURBQWdDLEVBQUMsSUFBSSxDQUFDO1lBQy9DLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sRUFBRSxlQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUM3QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUM1RCxPQUFPLEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxnQ0FBZ0MsQ0FB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Q2xCLFNBQVMsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ2pELE9BQU8sR0FBRyxHQUFHLElBQUksT0FBTyxHQUFHLENBQUM7UUFDOUIsQ0FBQyxFQUFFLEdBQUcsU0FBUyxPQUFPLENBQUMsQ0FBQztLQUN6QjtJQUVELE9BQU8sR0FBRyxTQUFTLEtBQUssQ0FBQztBQUMzQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgY29kZWJ1aWxkIGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0ICogYXMgY3AgZnJvbSAnLi4vLi4vLi4vYXdzLWNvZGVwaXBlbGluZSc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnLi4vLi4vLi4vYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgVGFncyB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBDREtQX0RFRkFVTFRfQ09ERUJVSUxEX0lNQUdFIH0gZnJvbSAnLi9kZWZhdWx0LWNvZGVidWlsZC1pbWFnZSc7XG5pbXBvcnQgeyBidWlsdEluQ3VzdG9tUmVzb3VyY2VOb2RlUnVudGltZSB9IGZyb20gJy4uLy4uLy4uL2N1c3RvbS1yZXNvdXJjZXMnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGFuIEFwcGxpY2F0aW9uU2VjdXJpdHlDaGVja1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcGxpY2F0aW9uU2VjdXJpdHlDaGVja1Byb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBwaXBlbGluZSB0aGF0IHdpbGwgYmUgYXV0b21hdGljYWxseSBhcHByb3ZlZFxuICAgKlxuICAgKiBXaWxsIGhhdmUgYSB0YWcgYWRkZWQgdG8gaXQuXG4gICAqL1xuICByZWFkb25seSBjb2RlUGlwZWxpbmU6IGNwLlBpcGVsaW5lO1xufVxuXG4vKipcbiAqIEEgY29uc3RydWN0IGNvbnRhaW5pbmcgYm90aCB0aGUgTGFtYmRhIGFuZCBDb2RlQnVpbGQgUHJvamVjdFxuICogbmVlZGVkIHRvIGNvbmR1Y3QgYSBzZWN1cml0eSBjaGVjayBvbiBhbnkgZ2l2ZW4gYXBwbGljYXRpb24gc3RhZ2UuXG4gKlxuICogVGhlIExhbWJkYSBhY3RzIGFzIGFuIGF1dG8gYXBwcm92aW5nIG1lY2hhbmlzbSB0aGF0IHNob3VsZCBvbmx5IGJlXG4gKiB0cmlnZ2VyZWQgd2hlbiB0aGUgQ29kZUJ1aWxkIFByb2plY3QgcmVnaXN0ZXJzIG5vIHNlY3VyaXR5IGNoYW5nZXMuXG4gKlxuICogVGhlIENvZGVCdWlsZCBQcm9qZWN0IHJ1bnMgYSBzZWN1cml0eSBkaWZmIG9uIHRoZSBhcHBsaWNhdGlvbiBzdGFnZSxcbiAqIGFuZCBleHBvcnRzIHRoZSBsaW5rIHRvIHRoZSBjb25zb2xlIG9mIHRoZSBwcm9qZWN0LlxuICovXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25TZWN1cml0eUNoZWNrIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgLyoqXG4gICAqIEEgbGFtYmRhIGZ1bmN0aW9uIHRoYXQgYXBwcm92ZXMgYSBNYW51YWwgQXBwcm92YWwgQWN0aW9uLCBnaXZlblxuICAgKiB0aGUgZm9sbG93aW5nIHBheWxvYWQ6XG4gICAqXG4gICAqIHtcbiAgICogIFwiUGlwZWxpbmVOYW1lXCI6IFtDb2RlUGlwZWxpbmVOYW1lXSxcbiAgICogIFwiU3RhZ2VOYW1lXCI6IFtDb2RlUGlwZWxpbmVTdGFnZU5hbWVdLFxuICAgKiAgXCJBY3Rpb25OYW1lXCI6IFtNYW51YWxBcHByb3ZhbEFjdGlvbk5hbWVdXG4gICAqIH1cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBwcmVBcHByb3ZlTGFtYmRhOiBsYW1iZGEuRnVuY3Rpb247XG4gIC8qKlxuICAgKiBBIENvZGVCdWlsZCBQcm9qZWN0IHRoYXQgcnVucyBhIHNlY3VyaXR5IGRpZmYgb24gdGhlIGFwcGxpY2F0aW9uIHN0YWdlLlxuICAgKlxuICAgKiAtIElmIHRoZSBkaWZmIHJlZ2lzdGVycyBubyBzZWN1cml0eSBjaGFuZ2VzLCBDb2RlQnVpbGQgd2lsbCBpbnZva2UgdGhlXG4gICAqICAgcHJlLWFwcHJvdmFsIGxhbWJkYSBhbmQgYXBwcm92ZSB0aGUgTWFudWFsQXBwcm92YWxBY3Rpb24uXG4gICAqIC0gSWYgY2hhbmdlcyBhcmUgZGV0ZWN0ZWQsIENvZGVCdWlsZCB3aWxsIGV4aXQgaW50byBhIE1hbnVhbEFwcHJvdmFsQWN0aW9uXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY2RrRGlmZlByb2plY3Q6IGNvZGVidWlsZC5Qcm9qZWN0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBcHBsaWNhdGlvblNlY3VyaXR5Q2hlY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBUYWdzLm9mKHByb3BzLmNvZGVQaXBlbGluZSkuYWRkKCdTRUNVUklUWV9DSEVDSycsICdBTExPV19BUFBST1ZFJywge1xuICAgICAgaW5jbHVkZVJlc291cmNlVHlwZXM6IFsnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJ10sXG4gICAgfSk7XG5cbiAgICB0aGlzLnByZUFwcHJvdmVMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdDREtQaXBlbGluZXNBdXRvQXBwcm92ZScsIHtcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IGJ1aWx0SW5DdXN0b21SZXNvdXJjZU5vZGVSdW50aW1lKHRoaXMpLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdhcHByb3ZlLWxhbWJkYScpKSxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgfSk7XG5cbiAgICB0aGlzLnByZUFwcHJvdmVMYW1iZGEuYWRkVG9Sb2xlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgIGFjdGlvbnM6IFsnY29kZXBpcGVsaW5lOkdldFBpcGVsaW5lU3RhdGUnLCAnY29kZXBpcGVsaW5lOlB1dEFwcHJvdmFsUmVzdWx0J10sXG4gICAgICBjb25kaXRpb25zOiB7XG4gICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICdhd3M6UmVzb3VyY2VUYWcvU0VDVVJJVFlfQ0hFQ0snOiAnQUxMT1dfQVBQUk9WRScsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICB9KSk7XG5cbiAgICBjb25zdCBpbnZva2VMYW1iZGEgPVxuICAgICAgJ2F3cyBsYW1iZGEgaW52b2tlJyArXG4gICAgICBgIC0tZnVuY3Rpb24tbmFtZSAke3RoaXMucHJlQXBwcm92ZUxhbWJkYS5mdW5jdGlvbk5hbWV9YCArXG4gICAgICAnIC0taW52b2NhdGlvbi10eXBlIEV2ZW50JyArXG4gICAgICAnIC0tY2xpLWJpbmFyeS1mb3JtYXQgcmF3LWluLWJhc2U2NC1vdXQnICtcbiAgICAgICcgLS1wYXlsb2FkIFwiJHBheWxvYWRcIicgK1xuICAgICAgJyBsYW1iZGEub3V0JztcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBbXG4gICAgICAnQW4gdXBjb21pbmcgY2hhbmdlIHdvdWxkIGJyb2FkZW4gc2VjdXJpdHkgY2hhbmdlcyBpbiAkUElQRUxJTkVfTkFNRS4nLFxuICAgICAgJ1JldmlldyBhbmQgYXBwcm92ZSB0aGUgY2hhbmdlcyBpbiBDb2RlUGlwZWxpbmUgdG8gcHJvY2VlZCB3aXRoIHRoZSBkZXBsb3ltZW50LicsXG4gICAgICAnJyxcbiAgICAgICdSZXZpZXcgdGhlIGNoYW5nZXMgaW4gQ29kZUJ1aWxkOicsXG4gICAgICAnJyxcbiAgICAgICckTElOSycsXG4gICAgICAnJyxcbiAgICAgICdBcHByb3ZlIHRoZSBjaGFuZ2VzIGluIENvZGVQaXBlbGluZSAoc3RhZ2UgJFNUQUdFX05BTUUsIGFjdGlvbiAkQUNUSU9OX05BTUUpOicsXG4gICAgICAnJyxcbiAgICAgICckUElQRUxJTkVfTElOSycsXG4gICAgXTtcbiAgICBjb25zdCBwdWJsaXNoTm90aWZpY2F0aW9uID1cbiAgICAgICdhd3Mgc25zIHB1Ymxpc2gnICtcbiAgICAgICcgLS10b3BpYy1hcm4gJE5PVElGSUNBVElPTl9BUk4nICtcbiAgICAgICcgLS1zdWJqZWN0IFwiJE5PVElGSUNBVElPTl9TVUJKRUNUXCInICtcbiAgICAgIGAgLS1tZXNzYWdlIFwiJHttZXNzYWdlLmpvaW4oJ1xcbicpfVwiYDtcblxuICAgIHRoaXMuY2RrRGlmZlByb2plY3QgPSBuZXcgY29kZWJ1aWxkLlByb2plY3QodGhpcywgJ0NES1NlY3VyaXR5Q2hlY2snLCB7XG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBidWlsZEltYWdlOiBDREtQX0RFRkFVTFRfQ09ERUJVSUxEX0lNQUdFLFxuICAgICAgfSxcbiAgICAgIGJ1aWxkU3BlYzogY29kZWJ1aWxkLkJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgICAgdmVyc2lvbjogMC4yLFxuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgY29tbWFuZHM6IFtcbiAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsIC1nIGF3cy1jZGsnLFxuICAgICAgICAgICAgICAvLyAkQ09ERUJVSUxEX0lOSVRJQVRPUiB3aWxsIGFsd2F5cyBiZSBDb2RlIFBpcGVsaW5lIGFuZCBpbiB0aGUgZm9ybSBvZjpcbiAgICAgICAgICAgICAgLy8gXCJjb2RlcGlwZWxpbmUvZXhhbXBsZS1waXBlbGluZS1uYW1lLVh4eFwiXG4gICAgICAgICAgICAgICdleHBvcnQgUElQRUxJTkVfTkFNRT1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQ09ERUJVSUxEX0lOSVRJQVRPUn1gLnNwbGl0KFwiL1wiKVsxXVxcJylcIicsXG4gICAgICAgICAgICAgICdwYXlsb2FkPVwiJChub2RlIC1wZSBcXCdKU09OLnN0cmluZ2lmeSh7IFwiUGlwZWxpbmVOYW1lXCI6IHByb2Nlc3MuZW52LlBJUEVMSU5FX05BTUUsIFwiU3RhZ2VOYW1lXCI6IHByb2Nlc3MuZW52LlNUQUdFX05BTUUsIFwiQWN0aW9uTmFtZVwiOiBwcm9jZXNzLmVudi5BQ1RJT05fTkFNRSB9KVxcJyApXCInLFxuICAgICAgICAgICAgICAvLyBBUk46IFwiYXJuOmF3czpjb2RlYnVpbGQ6JHJlZ2lvbjokYWNjb3VudF9pZDpidWlsZC8kcHJvamVjdF9uYW1lOiRwcm9qZWN0X2V4ZWN1dGlvbl9pZCRcIlxuICAgICAgICAgICAgICAnQVJOPSRDT0RFQlVJTERfQlVJTERfQVJOJyxcbiAgICAgICAgICAgICAgJ1JFR0lPTj1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzNdXFwnKVwiJyxcbiAgICAgICAgICAgICAgJ0FDQ09VTlRfSUQ9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs0XVxcJylcIicsXG4gICAgICAgICAgICAgICdQUk9KRUNUX05BTUU9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs1XS5zcGxpdChcIi9cIilbMV1cXCcpXCInLFxuICAgICAgICAgICAgICAnUFJPSkVDVF9JRD1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzZdXFwnKVwiJyxcbiAgICAgICAgICAgICAgLy8gTWFudWFsIEFwcHJvdmFsIGFkZHMgJ2h0dHAvaHR0cHMnIHRvIHRoZSByZXNvbHZlZCBsaW5rXG4gICAgICAgICAgICAgICdleHBvcnQgTElOSz1cImh0dHBzOi8vJFJFR0lPTi5jb25zb2xlLmF3cy5hbWF6b24uY29tL2NvZGVzdWl0ZS9jb2RlYnVpbGQvJEFDQ09VTlRfSUQvcHJvamVjdHMvJFBST0pFQ1RfTkFNRS9idWlsZC8kUFJPSkVDVF9OQU1FOiRQUk9KRUNUX0lELz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgJ2V4cG9ydCBQSVBFTElORV9MSU5LPVwiaHR0cHM6Ly8kUkVHSU9OLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vY29kZXN1aXRlL2NvZGVwaXBlbGluZS9waXBlbGluZXMvJFBJUEVMSU5FX05BTUUvdmlldz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgLy8gUnVuIGludm9rZSBvbmx5IGlmIGNkayBkaWZmIHBhc3NlcyAocmV0dXJucyBleGl0IGNvZGUgMClcbiAgICAgICAgICAgICAgLy8gMCAtPiB0cnVlLCAxIC0+IGZhbHNlXG4gICAgICAgICAgICAgIGlmRWxzZSh7XG4gICAgICAgICAgICAgICAgY29uZGl0aW9uOiAnY2RrIGRpZmYgLWEgLiAtLXNlY3VyaXR5LW9ubHkgLS1mYWlsICRTVEFHRV9QQVRIL1xcXFwqJyxcbiAgICAgICAgICAgICAgICB0aGVuU3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgICAgaW52b2tlTGFtYmRhLFxuICAgICAgICAgICAgICAgICAgJ2V4cG9ydCBNRVNTQUdFPVwiTm8gc2VjdXJpdHktaW1wYWN0aW5nIGNoYW5nZXMgZGV0ZWN0ZWQuXCInLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgZWxzZVN0YXRlbWVudHM6IFtcbiAgICAgICAgICAgICAgICAgIGBbIC16IFwiXFwke05PVElGSUNBVElPTl9BUk59XCIgXSB8fCAke3B1Ymxpc2hOb3RpZmljYXRpb259YCxcbiAgICAgICAgICAgICAgICAgICdleHBvcnQgTUVTU0FHRT1cIkRlcGxveW1lbnQgd291bGQgbWFrZSBzZWN1cml0eS1pbXBhY3RpbmcgY2hhbmdlcy4gQ2xpY2sgdGhlIGxpbmsgYmVsb3cgdG8gaW5zcGVjdCB0aGVtLCB0aGVuIGNsaWNrIEFwcHJvdmUgaWYgYWxsIGNoYW5nZXMgYXJlIGV4cGVjdGVkLlwiJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgZW52OiB7XG4gICAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IFtcbiAgICAgICAgICAgICdMSU5LJyxcbiAgICAgICAgICAgICdNRVNTQUdFJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICAvLyB0aGlzIGlzIG5lZWRlZCB0byBjaGVjayB0aGUgc3RhdHVzIHRoZSBzdGFja3Mgd2hlbiBkb2luZyBgY2RrIGRpZmZgXG4gICAgdGhpcy5jZGtEaWZmUHJvamVjdC5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0VxdWFscyc6IHtcbiAgICAgICAgICAnaWFtOlJlc291cmNlVGFnL2F3cy1jZGs6Ym9vdHN0cmFwLXJvbGUnOiBbJ2RlcGxveSddLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB0aGlzLnByZUFwcHJvdmVMYW1iZGEuZ3JhbnRJbnZva2UodGhpcy5jZGtEaWZmUHJvamVjdCk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIGlmRWxzZU9wdGlvbnMge1xuICByZWFkb25seSBjb25kaXRpb246IHN0cmluZyxcbiAgcmVhZG9ubHkgdGhlblN0YXRlbWVudHM6IHN0cmluZ1tdLFxuICByZWFkb25seSBlbHNlU3RhdGVtZW50cz86IHN0cmluZ1tdXG59XG5cbmNvbnN0IGlmRWxzZSA9ICh7IGNvbmRpdGlvbiwgdGhlblN0YXRlbWVudHMsIGVsc2VTdGF0ZW1lbnRzIH06IGlmRWxzZU9wdGlvbnMpOiBzdHJpbmcgPT4ge1xuICBsZXQgc3RhdGVtZW50ID0gdGhlblN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmVHJ1ZSkgPT4ge1xuICAgIHJldHVybiBgJHthY2N9ICR7aWZUcnVlfTtgO1xuICB9LCBgaWYgJHtjb25kaXRpb259OyB0aGVuYCk7XG5cbiAgaWYgKGVsc2VTdGF0ZW1lbnRzKSB7XG4gICAgc3RhdGVtZW50ID0gZWxzZVN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmRmFsc2UpID0+IHtcbiAgICAgIHJldHVybiBgJHthY2N9ICR7aWZGYWxzZX07YDtcbiAgICB9LCBgJHtzdGF0ZW1lbnR9IGVsc2VgKTtcbiAgfVxuXG4gIHJldHVybiBgJHtzdGF0ZW1lbnR9IGZpYDtcbn07XG4iXX0=