"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExportWriter = void 0;
const path = require("path");
const constructs_1 = require("constructs");
const export_reader_provider_1 = require("./export-reader-provider");
const types_1 = require("./types");
const cfn_dynamic_reference_1 = require("../../cfn-dynamic-reference");
const custom_resource_1 = require("../../custom-resource");
const lazy_1 = require("../../lazy");
const uniqueid_1 = require("../../private/uniqueid");
const stack_1 = require("../../stack");
const custom_resource_provider_1 = require("../custom-resource-provider");
const token_1 = require("../../token");
/**
 * Creates a custom resource that will return a list of stack exports from a given
 * AWS region. The export can then be referenced by the export name.
 *
 *
 * @example
 * declare const app: App;
 * const stack1 = new Stack(app, 'East1Stack', { env: { region: 'us-east-1' } });
 * new CfnOutput(stack1, 'Output', { value: 'someValue', exportName: 'someName' });
 *
 * const stack2 = new Stack(app, 'East2Stack', { env: { region: 'us-east-2' } });
 * const exportReader = new ExportReader(stack2, 'ExportReader', { region: 'us-east-1' });
 * const anotherResource = new CfnResource(stack2, 'AnotherResource', {
 *   Parameters: {
 *     SomeParam: exportReader.importValue('someName'),
 *   },
 * });
 *
 * @internal - this is intentionally not exported from core
 */
class ExportWriter extends constructs_1.Construct {
    static getOrCreate(scope, uniqueId, props) {
        const stack = stack_1.Stack.of(scope);
        const existing = stack.node.tryFindChild(uniqueId);
        return existing
            ? existing
            : new ExportWriter(stack, uniqueId, {
                region: props.region,
            });
    }
    constructor(scope, id, props) {
        super(scope, id);
        this._references = {};
        this.resourceArns = new Set;
        const stack = stack_1.Stack.of(this);
        const region = props.region ?? stack.region;
        this.addRegionToPolicy(region);
        const resourceType = 'Custom::CrossRegionExportWriter';
        this.provider = custom_resource_provider_1.CustomResourceProvider.getOrCreateProvider(this, resourceType, {
            codeDirectory: path.join(__dirname, 'cross-region-ssm-writer-handler'),
            runtime: (0, custom_resource_provider_1.builtInCustomResourceProviderNodeRuntime)(this),
            policyStatements: [{
                    Effect: 'Allow',
                    Resource: lazy_1.Lazy.list({
                        produce: () => [
                            ...Array.from(this.resourceArns),
                        ],
                    }),
                    Action: [
                        'ssm:DeleteParameters',
                        'ssm:ListTagsForResource',
                        'ssm:GetParameters',
                        'ssm:PutParameter',
                    ],
                }],
        });
        const properties = {
            region: region,
            exports: lazy_1.Lazy.any({ produce: () => this._references }),
        };
        new custom_resource_1.CustomResource(this, 'Resource', {
            resourceType: resourceType,
            serviceToken: this.provider.serviceToken,
            properties: {
                WriterProps: properties,
            },
        });
    }
    /**
     * Register a reference with the writer and returns a CloudFormation Stack export by name
     *
     * The value will be "exported" via the ExportWriter. It will perform
     * the export by creating an SSM parameter in the region that the consuming
     * stack is created.
     *
     * @param exportName the unique name associated with the export
     * @param reference the value that will be exported
     * @returns a reference to the reader custom resource
     */
    exportValue(exportName, reference, importStack) {
        const stack = stack_1.Stack.of(this);
        const parameterName = `/${types_1.SSM_EXPORT_PATH_PREFIX}${exportName}`;
        const ref = new cfn_dynamic_reference_1.CfnDynamicReference(cfn_dynamic_reference_1.CfnDynamicReferenceService.SSM, parameterName);
        this._references[parameterName] = stack.resolve(reference.toString());
        return this.addToExportReader(parameterName, ref, importStack);
    }
    /**
     * Add a resource arn for the consuming stack region
     * Each writer could be writing to multiple regions and needs
     * permissions to each region.
     *
     * If the region is not resolved then do not add anything.
     */
    addRegionToPolicy(region) {
        if (!token_1.Token.isUnresolved(region)) {
            this.resourceArns.add(stack_1.Stack.of(this).formatArn({
                service: 'ssm',
                resource: 'parameter',
                region,
                resourceName: `${types_1.SSM_EXPORT_PATH_PREFIX}*`,
            }));
        }
    }
    /**
     * Add the export to the export reader which is created in the importing stack
     */
    addToExportReader(exportName, exportValueRef, importStack) {
        const readerConstructName = (0, uniqueid_1.makeUniqueId)(['ExportsReader']);
        const exportReader = export_reader_provider_1.ExportReader.getOrCreate(importStack.nestedStackParent ?? importStack, readerConstructName);
        this.addRegionToPolicy(importStack.region);
        return exportReader.importValue(exportName, exportValueRef);
    }
}
exports.ExportWriter = ExportWriter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LXdyaXRlci1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4cG9ydC13cml0ZXItcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkJBQTZCO0FBQzdCLDJDQUF1QztBQUN2QyxxRUFBd0Q7QUFDeEQsbUNBQTBGO0FBQzFGLHVFQUE4RjtBQUM5RiwyREFBdUQ7QUFDdkQscUNBQWtDO0FBRWxDLHFEQUFzRDtBQUV0RCx1Q0FBb0M7QUFDcEMsMEVBQStHO0FBQy9HLHVDQUFvQztBQWNwQzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUNILE1BQWEsWUFBYSxTQUFRLHNCQUFTO0lBQ2xDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBZ0IsRUFBRSxRQUFnQixFQUFFLEtBQXdCO1FBQ3BGLE1BQU0sS0FBSyxHQUFHLGFBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkQsT0FBTyxRQUFRO1lBQ2IsQ0FBQyxDQUFDLFFBQXdCO1lBQzFCLENBQUMsQ0FBQyxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO2dCQUNsQyxNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07YUFDckIsQ0FBQyxDQUFDO0tBQ047SUFJRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXdCO1FBQ2hFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFKRixnQkFBVyxHQUF1QixFQUFFLENBQUM7UUFFckMsaUJBQVksR0FBRyxJQUFJLEdBQVcsQ0FBQztRQUc5QyxNQUFNLEtBQUssR0FBRyxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQztR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Q0FBQztRQUUzQyxPQUFPLFlBQVksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0tBQzdEO0NBQ0Y7QUF2R0Qsb0NBdUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgRXhwb3J0UmVhZGVyIH0gZnJvbSAnLi9leHBvcnQtcmVhZGVyLXByb3ZpZGVyJztcbmltcG9ydCB7IENyb3NzUmVnaW9uRXhwb3J0cywgU1NNX0VYUE9SVF9QQVRIX1BSRUZJWCwgRXhwb3J0V3JpdGVyQ1JQcm9wcyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQ2ZuRHluYW1pY1JlZmVyZW5jZSwgQ2ZuRHluYW1pY1JlZmVyZW5jZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jZm4tZHluYW1pYy1yZWZlcmVuY2UnO1xuaW1wb3J0IHsgQ3VzdG9tUmVzb3VyY2UgfSBmcm9tICcuLi8uLi9jdXN0b20tcmVzb3VyY2UnO1xuaW1wb3J0IHsgTGF6eSB9IGZyb20gJy4uLy4uL2xhenknO1xuaW1wb3J0IHsgSW50cmluc2ljIH0gZnJvbSAnLi4vLi4vcHJpdmF0ZS9pbnRyaW5zaWMnO1xuaW1wb3J0IHsgbWFrZVVuaXF1ZUlkIH0gZnJvbSAnLi4vLi4vcHJpdmF0ZS91bmlxdWVpZCc7XG5pbXBvcnQgeyBSZWZlcmVuY2UgfSBmcm9tICcuLi8uLi9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tICcuLi8uLi9zdGFjayc7XG5pbXBvcnQgeyBidWlsdEluQ3VzdG9tUmVzb3VyY2VQcm92aWRlck5vZGVSdW50aW1lLCBDdXN0b21SZXNvdXJjZVByb3ZpZGVyIH0gZnJvbSAnLi4vY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyJztcbmltcG9ydCB7IFRva2VuIH0gZnJvbSAnLi4vLi4vdG9rZW4nO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGFuIEV4cG9ydFJlYWRlclxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV4cG9ydFdyaXRlclByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBBV1MgcmVnaW9uIHRvIHJlYWQgU3RhY2sgZXhwb3J0cyBmcm9tXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gdGhlIHN0YWNrIHJlZ2lvblxuICAgKi9cbiAgcmVhZG9ubHkgcmVnaW9uPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBjdXN0b20gcmVzb3VyY2UgdGhhdCB3aWxsIHJldHVybiBhIGxpc3Qgb2Ygc3RhY2sgZXhwb3J0cyBmcm9tIGEgZ2l2ZW5cbiAqIEFXUyByZWdpb24uIFRoZSBleHBvcnQgY2FuIHRoZW4gYmUgcmVmZXJlbmNlZCBieSB0aGUgZXhwb3J0IG5hbWUuXG4gKlxuICpcbiAqIEBleGFtcGxlXG4gKiBkZWNsYXJlIGNvbnN0IGFwcDogQXBwO1xuICogY29uc3Qgc3RhY2sxID0gbmV3IFN0YWNrKGFwcCwgJ0Vhc3QxU3RhY2snLCB7IGVudjogeyByZWdpb246ICd1cy1lYXN0LTEnIH0gfSk7XG4gKiBuZXcgQ2ZuT3V0cHV0KHN0YWNrMSwgJ091dHB1dCcsIHsgdmFsdWU6ICdzb21lVmFsdWUnLCBleHBvcnROYW1lOiAnc29tZU5hbWUnIH0pO1xuICpcbiAqIGNvbnN0IHN0YWNrMiA9IG5ldyBTdGFjayhhcHAsICdFYXN0MlN0YWNrJywgeyBlbnY6IHsgcmVnaW9uOiAndXMtZWFzdC0yJyB9IH0pO1xuICogY29uc3QgZXhwb3J0UmVhZGVyID0gbmV3IEV4cG9ydFJlYWRlcihzdGFjazIsICdFeHBvcnRSZWFkZXInLCB7IHJlZ2lvbjogJ3VzLWVhc3QtMScgfSk7XG4gKiBjb25zdCBhbm90aGVyUmVzb3VyY2UgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2syLCAnQW5vdGhlclJlc291cmNlJywge1xuICogICBQYXJhbWV0ZXJzOiB7XG4gKiAgICAgU29tZVBhcmFtOiBleHBvcnRSZWFkZXIuaW1wb3J0VmFsdWUoJ3NvbWVOYW1lJyksXG4gKiAgIH0sXG4gKiB9KTtcbiAqXG4gKiBAaW50ZXJuYWwgLSB0aGlzIGlzIGludGVudGlvbmFsbHkgbm90IGV4cG9ydGVkIGZyb20gY29yZVxuICovXG5leHBvcnQgY2xhc3MgRXhwb3J0V3JpdGVyIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHN0YXRpYyBnZXRPckNyZWF0ZShzY29wZTogQ29uc3RydWN0LCB1bmlxdWVJZDogc3RyaW5nLCBwcm9wczogRXhwb3J0V3JpdGVyUHJvcHMpOiBFeHBvcnRXcml0ZXIge1xuICAgIGNvbnN0IHN0YWNrID0gU3RhY2sub2Yoc2NvcGUpO1xuICAgIGNvbnN0IGV4aXN0aW5nID0gc3RhY2subm9kZS50cnlGaW5kQ2hpbGQodW5pcXVlSWQpO1xuICAgIHJldHVybiBleGlzdGluZ1xuICAgICAgPyBleGlzdGluZyBhcyBFeHBvcnRXcml0ZXJcbiAgICAgIDogbmV3IEV4cG9ydFdyaXRlcihzdGFjaywgdW5pcXVlSWQsIHtcbiAgICAgICAgcmVnaW9uOiBwcm9wcy5yZWdpb24sXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWZlcmVuY2VzOiBDcm9zc1JlZ2lvbkV4cG9ydHMgPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlcjogQ3VzdG9tUmVzb3VyY2VQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNvdXJjZUFybnMgPSBuZXcgU2V0PHN0cmluZz47XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFeHBvcnRXcml0ZXJQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZih0aGlzKTtcbiAgICBjb25zdCByZWdpb24gPSBwcm9wcy5yZWdpb24gPz8gc3RhY2sucmVnaW9uO1xuICAgIHRoaXMuYWRkUmVnaW9uVG9Qb2xpY3kocmVnaW9uKTtcblxuICAgIGNvbnN0IHJlc291cmNlVHlwZSA9ICdDdXN0b206OkNyb3NzUmVnaW9uRXhwb3J0V3JpdGVyJztcbiAgICB0aGlzLnByb3ZpZGVyID0gQ3VzdG9tUmVzb3VyY2VQcm92aWRlci5nZXRPckNyZWF0ZVByb3ZpZGVyKHRoaXMsIHJlc291cmNlVHlwZSwge1xuICAgICAgY29kZURpcmVjdG9yeTogcGF0aC5qb2luKF9fZGlybmFtZSwgJ2Nyb3NzLXJlZ2lvbi1zc20td3JpdGVyLWhhbmRsZXInKSxcbiAgICAgIHJ1bnRpbWU6IGJ1aWx0SW5DdXN0b21SZXNvdXJjZVByb3ZpZGVyTm9kZVJ1bnRpbWUodGhpcyksXG4gICAgICBwb2xpY3lTdGF0ZW1lbnRzOiBbe1xuICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgIFJlc291cmNlOiBMYXp5Lmxpc3Qoe1xuICAgICAgICAgIHByb2R1Y2U6ICgpID0+IFtcbiAgICAgICAgICAgIC4uLkFycmF5LmZyb20odGhpcy5yZXNvdXJjZUFybnMpLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pLFxuICAgICAgICBBY3Rpb246IFtcbiAgICAgICAgICAnc3NtOkRlbGV0ZVBhcmFtZXRlcnMnLFxuICAgICAgICAgICdzc206TGlzdFRhZ3NGb3JSZXNvdXJjZScsXG4gICAgICAgICAgJ3NzbTpHZXRQYXJhbWV0ZXJzJyxcbiAgICAgICAgICAnc3NtOlB1dFBhcmFtZXRlcicsXG4gICAgICAgIF0sXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHByb3BlcnRpZXM6IEV4cG9ydFdyaXRlckNSUHJvcHMgPSB7XG4gICAgICByZWdpb246IHJlZ2lvbixcbiAgICAgIGV4cG9ydHM6IExhenkuYW55KHsgcHJvZHVjZTogKCkgPT4gdGhpcy5fcmVmZXJlbmNlcyB9KSxcbiAgICB9O1xuICAgIG5ldyBDdXN0b21SZXNvdXJjZSh0aGlzLCAnUmVzb3VyY2UnLCB7XG4gICAgICByZXNvdXJjZVR5cGU6IHJlc291cmNlVHlwZSxcbiAgICAgIHNlcnZpY2VUb2tlbjogdGhpcy5wcm92aWRlci5zZXJ2aWNlVG9rZW4sXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFdyaXRlclByb3BzOiBwcm9wZXJ0aWVzLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIHJlZmVyZW5jZSB3aXRoIHRoZSB3cml0ZXIgYW5kIHJldHVybnMgYSBDbG91ZEZvcm1hdGlvbiBTdGFjayBleHBvcnQgYnkgbmFtZVxuICAgKlxuICAgKiBUaGUgdmFsdWUgd2lsbCBiZSBcImV4cG9ydGVkXCIgdmlhIHRoZSBFeHBvcnRXcml0ZXIuIEl0IHdpbGwgcGVyZm9ybVxuICAgKiB0aGUgZXhwb3J0IGJ5IGNyZWF0aW5nIGFuIFNTTSBwYXJhbWV0ZXIgaW4gdGhlIHJlZ2lvbiB0aGF0IHRoZSBjb25zdW1pbmdcbiAgICogc3RhY2sgaXMgY3JlYXRlZC5cbiAgICpcbiAgICogQHBhcmFtIGV4cG9ydE5hbWUgdGhlIHVuaXF1ZSBuYW1lIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXhwb3J0XG4gICAqIEBwYXJhbSByZWZlcmVuY2UgdGhlIHZhbHVlIHRoYXQgd2lsbCBiZSBleHBvcnRlZFxuICAgKiBAcmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgcmVhZGVyIGN1c3RvbSByZXNvdXJjZVxuICAgKi9cbiAgcHVibGljIGV4cG9ydFZhbHVlKGV4cG9ydE5hbWU6IHN0cmluZywgcmVmZXJlbmNlOiBSZWZlcmVuY2UsIGltcG9ydFN0YWNrOiBTdGFjayk6IEludHJpbnNpYyB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZih0aGlzKTtcbiAgICBjb25zdCBwYXJhbWV0ZXJOYW1lID0gYC8ke1NTTV9FWFBPUlRfUEFUSF9QUkVGSVh9JHtleHBvcnROYW1lfWA7XG5cbiAgICBjb25zdCByZWYgPSBuZXcgQ2ZuRHluYW1pY1JlZmVyZW5jZShDZm5EeW5hbWljUmVmZXJlbmNlU2VydmljZS5TU00sIHBhcmFtZXRlck5hbWUpO1xuXG4gICAgdGhpcy5fcmVmZXJlbmNlc1twYXJhbWV0ZXJOYW1lXSA9IHN0YWNrLnJlc29sdmUocmVmZXJlbmNlLnRvU3RyaW5nKCkpO1xuICAgIHJldHVybiB0aGlzLmFkZFRvRXhwb3J0UmVhZGVyKHBhcmFtZXRlck5hbWUsIHJlZiwgaW1wb3J0U3RhY2spO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIHJlc291cmNlIGFybiBmb3IgdGhlIGNvbnN1bWluZyBzdGFjayByZWdpb25cbiAgICogRWFjaCB3cml0ZXIgY291bGQgYmUgd3JpdGluZyB0byBtdWx0aXBsZSByZWdpb25zIGFuZCBuZWVkc1xuICAgKiBwZXJtaXNzaW9ucyB0byBlYWNoIHJlZ2lvbi5cbiAgICpcbiAgICogSWYgdGhlIHJlZ2lvbiBpcyBub3QgcmVzb2x2ZWQgdGhlbiBkbyBub3QgYWRkIGFueXRoaW5nLlxuICAgKi9cbiAgcHJpdmF0ZSBhZGRSZWdpb25Ub1BvbGljeShyZWdpb246IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghVG9rZW4uaXNVbnJlc29sdmVkKHJlZ2lvbikpIHtcbiAgICAgIHRoaXMucmVzb3VyY2VBcm5zLmFkZChcbiAgICAgICAgU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICBzZXJ2aWNlOiAnc3NtJyxcbiAgICAgICAgICByZXNvdXJjZTogJ3BhcmFtZXRlcicsXG4gICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgIHJlc291cmNlTmFtZTogYCR7U1NNX0VYUE9SVF9QQVRIX1BSRUZJWH0qYCxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgdGhlIGV4cG9ydCB0byB0aGUgZXhwb3J0IHJlYWRlciB3aGljaCBpcyBjcmVhdGVkIGluIHRoZSBpbXBvcnRpbmcgc3RhY2tcbiAgICovXG4gIHByaXZhdGUgYWRkVG9FeHBvcnRSZWFkZXIoZXhwb3J0TmFtZTogc3RyaW5nLCBleHBvcnRWYWx1ZVJlZjogSW50cmluc2ljLCBpbXBvcnRTdGFjazogU3RhY2spOiBJbnRyaW5zaWMge1xuICAgIGNvbnN0IHJlYWRlckNvbnN0cnVjdE5hbWUgPSBtYWtlVW5pcXVlSWQoWydFeHBvcnRzUmVhZGVyJ10pO1xuICAgIGNvbnN0IGV4cG9ydFJlYWRlciA9IEV4cG9ydFJlYWRlci5nZXRPckNyZWF0ZShpbXBvcnRTdGFjay5uZXN0ZWRTdGFja1BhcmVudCA/PyBpbXBvcnRTdGFjaywgcmVhZGVyQ29uc3RydWN0TmFtZSk7XG4gICAgdGhpcy5hZGRSZWdpb25Ub1BvbGljeShpbXBvcnRTdGFjay5yZWdpb24pO1xuXG4gICAgcmV0dXJuIGV4cG9ydFJlYWRlci5pbXBvcnRWYWx1ZShleHBvcnROYW1lLCBleHBvcnRWYWx1ZVJlZik7XG4gIH1cbn1cbiJdfQ==