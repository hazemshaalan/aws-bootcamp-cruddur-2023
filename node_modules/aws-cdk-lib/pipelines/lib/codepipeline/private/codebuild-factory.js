"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mergeCodeBuildOptions = exports.CodeBuildFactory = void 0;
const fs = require("fs");
const path = require("path");
const constructs_1 = require("constructs");
const buildspecs_1 = require("./buildspecs");
const codebuild = require("../../../../aws-codebuild");
const codepipeline_actions = require("../../../../aws-codepipeline-actions");
const ec2 = require("../../../../aws-ec2");
const iam = require("../../../../aws-iam");
const core_1 = require("../../../../core");
const step_output_1 = require("../../helpers-internal/step-output");
const construct_internals_1 = require("../../private/construct-internals");
const identifiers_1 = require("../../private/identifiers");
const javascript_1 = require("../../private/javascript");
/**
 * Produce a CodeBuild project from a ShellStep and some CodeBuild-specific customizations
 *
 * The functionality here is shared between the `CodePipeline` translating a `ShellStep` into
 * a CodeBuild project, as well as the `CodeBuildStep` straight up.
 */
class CodeBuildFactory {
    // eslint-disable-next-line max-len
    static fromShellStep(constructId, shellStep, additional) {
        return new CodeBuildFactory(constructId, {
            commands: shellStep.commands,
            env: shellStep.env,
            envFromCfnOutputs: shellStep.envFromCfnOutputs,
            inputs: shellStep.inputs,
            outputs: shellStep.outputs,
            stepId: shellStep.id,
            installCommands: shellStep.installCommands,
            producedStepOutputs: step_output_1.StepOutput.producedStepOutputs(shellStep),
            ...additional,
        });
    }
    static fromCodeBuildStep(constructId, step, additional) {
        const factory = CodeBuildFactory.fromShellStep(constructId, step, {
            projectName: step.projectName,
            role: step.role,
            actionRole: step.actionRole,
            ...additional,
            projectOptions: mergeCodeBuildOptions(additional?.projectOptions, {
                buildEnvironment: step.buildEnvironment,
                rolePolicy: step.rolePolicyStatements,
                securityGroups: step.securityGroups,
                partialBuildSpec: step.partialBuildSpec,
                vpc: step.vpc,
                subnetSelection: step.subnetSelection,
                cache: step.cache,
                timeout: step.timeout,
                fileSystemLocations: step.fileSystemLocations,
                logging: step.logging,
            }),
        });
        return {
            produceAction: (stage, options) => {
                const result = factory.produceAction(stage, options);
                if (result.project) {
                    step._setProject(result.project);
                }
                return result;
            },
        };
    }
    constructor(constructId, props) {
        this.constructId = constructId;
        this.props = props;
        this.stepId = props.stepId ?? constructId;
    }
    get project() {
        if (!this._project) {
            throw new Error('Project becomes available after produce() has been called');
        }
        return this._project;
    }
    produceAction(stage, options) {
        const projectOptions = mergeCodeBuildOptions(options.codeBuildDefaults, this.props.projectOptions);
        if ((!projectOptions.buildEnvironment?.privileged || projectOptions.vpc === undefined) &&
            (projectOptions.fileSystemLocations !== undefined && projectOptions.fileSystemLocations.length != 0)) {
            throw new Error('Setting fileSystemLocations requires a vpc to be set and privileged to be set to true.');
        }
        const inputs = this.props.inputs ?? [];
        const outputs = this.props.outputs ?? [];
        const mainInput = inputs.find(x => x.directory === '.');
        const extraInputs = inputs.filter(x => x.directory !== '.');
        const inputArtifact = mainInput
            ? options.artifacts.toCodePipeline(mainInput.fileSet)
            : options.fallbackArtifact;
        const extraInputArtifacts = extraInputs.map(x => options.artifacts.toCodePipeline(x.fileSet));
        const outputArtifacts = outputs.map(x => options.artifacts.toCodePipeline(x.fileSet));
        if (!inputArtifact) {
            // This should actually never happen because CodeBuild projects shouldn't be added before the
            // Source, which always produces at least an artifact.
            throw new Error(`CodeBuild action '${this.stepId}' requires an input (and the pipeline doesn't have a Source to fall back to). Add an input or a pipeline source.`);
        }
        const installCommands = [
            ...generateInputArtifactLinkCommands(options.artifacts, extraInputs),
            ...this.props.installCommands ?? [],
        ];
        const buildSpecHere = codebuild.BuildSpec.fromObject({
            version: '0.2',
            phases: {
                install: (installCommands.length ?? 0) > 0 ? { commands: installCommands } : undefined,
                build: this.props.commands.length > 0 ? { commands: this.props.commands } : undefined,
            },
            artifacts: (0, javascript_1.noEmptyObject)(renderArtifactsBuildSpec(options.artifacts, this.props.outputs ?? [])),
        });
        // Partition environment variables into environment variables that can go on the project
        // and environment variables that MUST go in the pipeline (those that reference CodePipeline variables)
        const env = (0, javascript_1.noUndefined)(this.props.env ?? {});
        const [actionEnvs, projectEnvs] = (0, javascript_1.partition)(Object.entries(env ?? {}), ([, v]) => containsPipelineVariable(v));
        const environment = mergeBuildEnvironments(projectOptions?.buildEnvironment ?? {}, {
            environmentVariables: (0, javascript_1.noEmptyObject)((0, javascript_1.mapValues)((0, javascript_1.mkdict)(projectEnvs), value => ({ value }))),
        });
        const fullBuildSpec = projectOptions?.partialBuildSpec
            ? codebuild.mergeBuildSpecs(projectOptions.partialBuildSpec, buildSpecHere)
            : buildSpecHere;
        const osFromEnvironment = environment.buildImage && environment.buildImage instanceof codebuild.WindowsBuildImage
            ? ec2.OperatingSystemType.WINDOWS
            : ec2.OperatingSystemType.LINUX;
        const actualBuildSpec = filterBuildSpecCommands(fullBuildSpec, osFromEnvironment);
        const scope = this.props.scope ?? options.scope;
        let projectBuildSpec;
        if (this.props.passBuildSpecViaCloudAssembly) {
            // Write to disk and replace with a reference
            const relativeSpecFile = `buildspec-${constructs_1.Node.of(scope).addr}-${this.constructId}.yaml`;
            const absSpecFile = path.join((0, construct_internals_1.cloudAssemblyBuildSpecDir)(scope), relativeSpecFile);
            // This should resolve to a pure JSON string. If it resolves to an object, it's a CFN
            // expression, and we can't support that yet. Maybe someday if we think really hard about it.
            const fileContents = core_1.Stack.of(scope).resolve(actualBuildSpec.toBuildSpec());
            if (typeof fileContents !== 'string') {
                throw new Error(`This BuildSpec contains CloudFormation references and is supported by publishInParallel=false: ${JSON.stringify(fileContents, undefined, 2)}`);
            }
            fs.writeFileSync(absSpecFile, fileContents, { encoding: 'utf-8' });
            projectBuildSpec = codebuild.BuildSpec.fromSourceFilename(relativeSpecFile);
        }
        else {
            projectBuildSpec = actualBuildSpec;
        }
        // A hash over the values that make the CodeBuild Project unique (and necessary
        // to restart the pipeline if one of them changes). projectName is not necessary to include
        // here because the pipeline will definitely restart if projectName changes.
        // (Resolve tokens)
        const projectConfigHash = (0, identifiers_1.hash)(core_1.Stack.of(scope).resolve({
            environment: serializeBuildEnvironment(environment),
            buildSpecString: actualBuildSpec.toBuildSpec(),
        }));
        const actionName = options.actionName ?? this.stepId;
        let projectScope = scope;
        if (this.props.additionalConstructLevel ?? true) {
            projectScope = (0, construct_internals_1.obtainScope)(scope, actionName);
        }
        const safePipelineName = core_1.Token.isUnresolved(options.pipeline.pipeline.pipelineName)
            ? `${core_1.Stack.of(options.pipeline).stackName}/${constructs_1.Node.of(options.pipeline.pipeline).id}`
            : options.pipeline.pipeline.pipelineName;
        const project = new codebuild.PipelineProject(projectScope, this.constructId, {
            projectName: this.props.projectName,
            description: `Pipeline step ${safePipelineName}/${stage.stageName}/${actionName}`.substring(0, 255),
            environment,
            vpc: projectOptions.vpc,
            subnetSelection: projectOptions.subnetSelection,
            securityGroups: projectOptions.securityGroups,
            cache: projectOptions.cache,
            buildSpec: projectBuildSpec,
            role: this.props.role,
            timeout: projectOptions.timeout,
            fileSystemLocations: projectOptions.fileSystemLocations,
            logging: projectOptions.logging,
        });
        if (this.props.additionalDependable) {
            project.node.addDependency(this.props.additionalDependable);
        }
        if (projectOptions.rolePolicy !== undefined) {
            projectOptions.rolePolicy.forEach(policyStatement => {
                project.addToRolePolicy(policyStatement);
            });
        }
        const stackOutputEnv = (0, javascript_1.mapValues)(this.props.envFromCfnOutputs ?? {}, outputRef => options.stackOutputsMap.toCodePipeline(outputRef));
        const configHashEnv = options.beforeSelfMutation
            ? { _PROJECT_CONFIG_HASH: projectConfigHash }
            : {};
        // Start all CodeBuild projects from a single (shared) Action Role, so that we don't have to generate an Action Role for each
        // individual CodeBuild Project and blow out the pipeline policy size (and potentially # of resources in the stack).
        const actionRoleCid = 'CodeBuildActionRole';
        const actionRole = this.props.actionRole
            ?? options.pipeline.node.tryFindChild(actionRoleCid)
            ?? new iam.Role(options.pipeline, actionRoleCid, {
                assumedBy: options.pipeline.pipeline.role,
            });
        stage.addAction(new codepipeline_actions.CodeBuildAction({
            actionName: actionName,
            input: inputArtifact,
            extraInputs: extraInputArtifacts,
            outputs: outputArtifacts,
            project,
            runOrder: options.runOrder,
            variablesNamespace: options.variablesNamespace,
            role: actionRole,
            // Inclusion of the hash here will lead to the pipeline structure for any changes
            // made the config of the underlying CodeBuild Project.
            // Hence, the pipeline will be restarted. This is necessary if the users
            // adds (for example) build or test commands to the buildspec.
            environmentVariables: (0, javascript_1.noEmptyObject)(cbEnv({
                ...(0, javascript_1.mkdict)(actionEnvs),
                ...configHashEnv,
                ...stackOutputEnv,
            })),
        }));
        this._project = project;
        return { runOrdersConsumed: 1, project };
    }
}
exports.CodeBuildFactory = CodeBuildFactory;
/**
 * Generate commands to move additional input artifacts into the right place
 */
function generateInputArtifactLinkCommands(artifacts, inputs) {
    return inputs.map(input => {
        const fragments = [];
        fragments.push(`[ ! -d "${input.directory}" ] || { echo 'additionalInputs: "${input.directory}" must not exist yet. If you want to merge multiple artifacts, use a "cp" command.'; exit 1; }`);
        const parentDirectory = path.dirname(input.directory);
        if (!['.', '..'].includes(parentDirectory)) {
            fragments.push(`mkdir -p -- "${parentDirectory}"`);
        }
        const artifact = artifacts.toCodePipeline(input.fileSet);
        fragments.push(`ln -s -- "$CODEBUILD_SRC_DIR_${artifact.artifactName}" "${input.directory}"`);
        return fragments.join(' && ');
    });
}
function renderArtifactsBuildSpec(artifactMap, outputs) {
    // save the generated files in the output artifact
    // This part of the buildspec has to look completely different depending on whether we're
    // using secondary artifacts or not.
    if (outputs.length === 0) {
        return {};
    }
    if (outputs.length === 1) {
        return {
            'base-directory': outputs[0].directory,
            'files': '**/*',
        };
    }
    const secondary = {};
    for (const output of outputs) {
        const art = artifactMap.toCodePipeline(output.fileSet);
        if (!art.artifactName) {
            throw new Error('You must give the output artifact a name');
        }
        secondary[art.artifactName] = {
            'base-directory': output.directory,
            'files': '**/*',
        };
    }
    return { 'secondary-artifacts': secondary };
}
function mergeCodeBuildOptions(...opts) {
    const xs = [{}, ...opts.filter(isDefined)];
    while (xs.length > 1) {
        const [a, b] = xs.splice(xs.length - 2, 2);
        xs.push(merge2(a, b));
    }
    return xs[0];
    function merge2(a, b) {
        return {
            buildEnvironment: mergeBuildEnvironments(a.buildEnvironment, b.buildEnvironment),
            rolePolicy: definedArray([...a.rolePolicy ?? [], ...b.rolePolicy ?? []]),
            securityGroups: definedArray([...a.securityGroups ?? [], ...b.securityGroups ?? []]),
            partialBuildSpec: (0, buildspecs_1.mergeBuildSpecs)(a.partialBuildSpec, b.partialBuildSpec),
            vpc: b.vpc ?? a.vpc,
            subnetSelection: b.subnetSelection ?? a.subnetSelection,
            timeout: b.timeout ?? a.timeout,
            cache: b.cache ?? a.cache,
            fileSystemLocations: definedArray([...a.fileSystemLocations ?? [], ...b.fileSystemLocations ?? []]),
            logging: b.logging ?? a.logging,
        };
    }
}
exports.mergeCodeBuildOptions = mergeCodeBuildOptions;
function mergeBuildEnvironments(a, b) {
    if (!a || !b) {
        return a ?? b;
    }
    return {
        buildImage: b.buildImage ?? a.buildImage,
        computeType: b.computeType ?? a.computeType,
        environmentVariables: {
            ...a.environmentVariables,
            ...b.environmentVariables,
        },
        privileged: b.privileged ?? a.privileged,
    };
}
function isDefined(x) {
    return x !== undefined;
}
/**
 * Serialize a build environment to data (get rid of constructs & objects), so we can JSON.stringify it
 */
function serializeBuildEnvironment(env) {
    return {
        privileged: env.privileged,
        environmentVariables: env.environmentVariables,
        type: env.buildImage?.type,
        imageId: env.buildImage?.imageId,
        computeType: env.computeType,
        imagePullPrincipalType: env.buildImage?.imagePullPrincipalType,
        secretsManagerArn: env.buildImage?.secretsManagerCredentials?.secretArn,
    };
}
/**
 * Whether the given string contains a reference to a CodePipeline variable
 */
function containsPipelineVariable(s) {
    return !!s.match(/#\{[^}]+\}/) || step_output_1.StepOutput.findAll(s).length > 0;
}
/**
 * Turn a collection into a collection of CodePipeline environment variables
 */
function cbEnv(xs) {
    return (0, javascript_1.mkdict)(Object.entries(xs)
        .filter(([, v]) => v !== undefined)
        .map(([k, v]) => [k, { value: v }]));
}
function definedArray(xs) {
    return xs.length > 0 ? xs : undefined;
}
/**
 * If lines in the buildspec start with '!WINDOWS!' or '!LINUX!', only render them on that platform.
 *
 * Very private protocol for now, but may come in handy in other libraries as well.
 */
function filterBuildSpecCommands(buildSpec, osType) {
    if (!buildSpec.isImmediate) {
        return buildSpec;
    }
    const spec = buildSpec.spec;
    const winTag = '!WINDOWS!';
    const linuxTag = '!LINUX!';
    const expectedTag = osType === ec2.OperatingSystemType.WINDOWS ? winTag : linuxTag;
    return codebuild.BuildSpec.fromObject(recurse(spec));
    function recurse(x) {
        if (Array.isArray(x)) {
            const ret = [];
            for (const el of x) {
                const [tag, payload] = extractTag(el);
                if (tag === undefined || tag === expectedTag) {
                    ret.push(payload);
                }
            }
            return ret;
        }
        if (x && typeof x === 'object') {
            return (0, javascript_1.mapValues)(x, recurse);
        }
        return x;
    }
    function extractTag(x) {
        if (typeof x !== 'string') {
            return [undefined, x];
        }
        for (const tag of [winTag, linuxTag]) {
            if (x.startsWith(tag)) {
                return [tag, x.slice(tag.length)];
            }
        }
        return [undefined, x];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWJ1aWxkLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2RlYnVpbGQtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDJDQUEwRDtBQUMxRCw2Q0FBK0M7QUFDL0MsdURBQXVEO0FBRXZELDZFQUE2RTtBQUM3RSwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzNDLDJDQUFnRDtBQUVoRCxvRUFBZ0U7QUFDaEUsMkVBQTJGO0FBQzNGLDJEQUFpRDtBQUNqRCx5REFBb0c7QUFpSHBHOzs7OztHQUtHO0FBQ0gsTUFBYSxnQkFBZ0I7SUFDM0IsbUNBQW1DO0lBQzVCLE1BQU0sQ0FBQyxhQUFhLENBQUMsV0FBbUIsRUFBRSxTQUFvQixFQUFFLFVBQTJDO1FBQ2hILE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUU7WUFDdkMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRO1lBQzVCLEdBQUcsRUFBRSxTQUFTLENBQUMsR0FBRztZQUNsQixpQkFBaUIsRUFBRSxTQUFTLENBQUMsaUJBQWlCO1lBQzlDLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTtZQUN4QixPQUFPLEVBQUUsU0FBUyxDQUFDLE9BQU87WUFDMUIsTUFBTSxFQUFFLFNBQVMsQ0FBQyxFQUFFO1lBQ3BCLGVBQWUsRUFBRSxTQUFTLENBQUMsZUFBZTtZQUMxQyxtQkFBbUIsRUFBRSx3QkFBVSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQztZQUM5RCxHQUFHLFVBQVU7U0FDZCxDQUFDLENBQUM7S0FDSjtJQUVNLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxXQUFtQixFQUFFLElBQW1CLEVBQUUsVUFBMkM7UUFDbkgsTUFBTSxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUU7WUFDaEUsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUMzQixHQUFHLFVBQVU7WUFDYixjQUFjLEVBQUUscUJBQXFCLENBQUMsVUFBVSxFQUFFLGNBQWMsRUFBRTtnQkFDaEUsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtnQkFDdkMsVUFBVSxFQUFFLElBQUksQ0FBQyxvQkFBb0I7Z0JBQ3JDLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztnQkFDbkMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtnQkFDdkMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO2dCQUNiLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZTtnQkFDckMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNqQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxtQkFBbUI7Z0JBQzdDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTzthQUN0QixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLGFBQWEsRUFBRSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRTtnQkFDaEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3JELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ2xDO2dCQUNELE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUM7U0FDRixDQUFDO0tBQ0g7SUFLRCxZQUNtQixXQUFtQixFQUNuQixLQUE0QjtRQUQ1QixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNuQixVQUFLLEdBQUwsS0FBSyxDQUF1QjtRQUU3QyxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDO0tBQzNDO0lBRUQsSUFBVyxPQUFPO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkRBQTJELENBQUMsQ0FBQztTQUM5RTtRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztLQUN0QjtJQUVNLGFBQWEsQ0FBQyxLQUEwQixFQUFFLE9BQTZCO1FBQzVFLE1BQU0sY0FBYyxHQUFHLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRW5HLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxVQUFVLElBQUksY0FBYyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUM7WUFDcEYsQ0FBQyxjQUFjLENBQUMsbUJBQW1CLEtBQUssU0FBUyxJQUFJLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDdEcsTUFBTSxJQUFJLEtBQUssQ0FBQyx3RkFBd0YsQ0FBQyxDQUFDO1NBQzNHO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUV6QyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUN4RCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUU1RCxNQUFNLGFBQWEsR0FBRyxTQUFTO1lBQzdCLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO1lBQ3JELENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7UUFDN0IsTUFBTSxtQkFBbUIsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDOUYsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBRXRGLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsNkZBQTZGO1lBQzdGLHNEQUFzRDtZQUN0RCxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixJQUFJLENBQUMsTUFBTSxrSEFBa0gsQ0FBQyxDQUFDO1NBQ3JLO1FBRUQsTUFBTSxlQUFlLEdBQUc7WUFDdEIsR0FBRyxpQ0FBaUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQztZQUNwRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxJQUFJLEVBQUU7U0FDcEMsQ0FBQztRQUVGLE1BQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQ25ELE9BQU8sRUFBRSxLQUFLO1lBQ2QsTUFBTSxFQUFFO2dCQUNOLE9BQU8sRUFBRSxDQUFDLGVBQWUsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztnQkFDdEYsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7YUFDdEY7WUFDRCxTQUFTLEVBQUUsSUFBQSwwQkFBYSxFQUFNLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUM7U0FDckcsQ0FBQyxDQUFDO1FBRUgsd0ZBQXdGO1FBQ3hGLHVHQUF1RztRQUN2RyxNQUFNLEdBQUcsR0FBRyxJQUFBLHdCQUFXLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLENBQUM7UUFFOUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsR0FBRyxJQUFBLHNCQUFTLEVBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFL0csTUFBTSxXQUFXLEdBQUcsc0JBQXNCLENBQ3hDLGNBQWMsRUFBRSxnQkFBZ0IsSUFBSSxFQUFFLEVBQ3RDO1lBQ0Usb0JBQW9CLEVBQUUsSUFBQSwwQkFBYSxFQUFDLElBQUEsc0JBQVMsRUFBQyxJQUFBLG1CQUFNLEVBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzFGLENBQUMsQ0FBQztRQUVMLE1BQU0sYUFBYSxHQUFHLGNBQWMsRUFBRSxnQkFBZ0I7WUFDcEQsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsQ0FBQztZQUMzRSxDQUFDLENBQUMsYUFBYSxDQUFDO1FBRWxCLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLFVBQVUsSUFBSSxXQUFXLENBQUMsVUFBVSxZQUFZLFNBQVMsQ0FBQyxpQkFBaUI7WUFDL0csQ0FBQyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPO1lBQ2pDLENBQUMsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDO1FBRWxDLE1BQU0sZUFBZSxHQUFHLHVCQUF1QixDQUFDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBRWxGLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFFaEQsSUFBSSxnQkFBZ0IsQ0FBQztRQUNyQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUU7WUFDNUMsNkNBQTZDO1lBQzdDLE1BQU0sZ0JBQWdCLEdBQUcsYUFBYSxpQkFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsT0FBTyxDQUFDO1lBQ3JGLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBQSwrQ0FBeUIsRUFBQyxLQUFLLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBRWxGLHFGQUFxRjtZQUNyRiw2RkFBNkY7WUFDN0YsTUFBTSxZQUFZLEdBQUcsWUFBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFFNUUsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7Z0JBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsa0dBQWtHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDaks7WUFDRCxFQUFFLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxZQUFZLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUNuRSxnQkFBZ0IsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDN0U7YUFBTTtZQUNMLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztTQUNwQztRQUVELCtFQUErRTtRQUMvRSwyRkFBMkY7UUFDM0YsNEVBQTRFO1FBQzVFLG1CQUFtQjtRQUNuQixNQUFNLGlCQUFpQixHQUFHLElBQUEsa0JBQUksRUFBQyxZQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUNyRCxXQUFXLEVBQUUseUJBQXlCLENBQUMsV0FBVyxDQUFDO1lBQ25ELGVBQWUsRUFBRSxlQUFlLENBQUMsV0FBVyxFQUFFO1NBQy9DLENBQUMsQ0FBQyxDQUFDO1FBRUosTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDO1FBRXJELElBQUksWUFBWSxHQUFHLEtBQUssQ0FBQztRQUN6QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsd0JBQXdCLElBQUksSUFBSSxFQUFFO1lBQy9DLFlBQVksR0FBRyxJQUFBLGlDQUFXLEVBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQy9DO1FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxZQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztZQUNqRixDQUFDLENBQUMsR0FBRyxZQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLElBQUksaUJBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDcEYsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztRQUUzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFNBQVMsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDNUUsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVztZQUNuQyxXQUFXLEVBQUUsaUJBQWlCLGdCQUFnQixJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUM7WUFDbkcsV0FBVztZQUNYLEdBQUcsRUFBRSxjQUFjLENBQUMsR0FBRztZQUN2QixlQUFlLEVBQUUsY0FBYyxDQUFDLGVBQWU7WUFDL0MsY0FBYyxFQUFFLGNBQWMsQ0FBQyxjQUFjO1lBQzdDLEtBQUssRUFBRSxjQUFjLENBQUMsS0FBSztZQUMzQixTQUFTLEVBQUUsZ0JBQWdCO1lBQzNCLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDckIsT0FBTyxFQUFFLGNBQWMsQ0FBQyxPQUFPO1lBQy9CLG1CQUFtQixFQUFFLGNBQWMsQ0FBQyxtQkFBbUI7WUFDdkQsT0FBTyxFQUFFLGNBQWMsQ0FBQyxPQUFPO1NBQ2hDLENBQUMsQ0FBQztRQUVILElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRTtZQUNuQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7U0FDN0Q7UUFFRCxJQUFJLGNBQWMsQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFO1lBQzNDLGNBQWMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFO2dCQUNsRCxPQUFPLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFBLHNCQUFTLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsSUFBSSxFQUFFLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FDL0UsT0FBTyxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQ2xELENBQUM7UUFFRixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsa0JBQWtCO1lBQzlDLENBQUMsQ0FBQyxFQUFFLG9CQUFvQixFQUFFLGlCQUFpQixFQUFFO1lBQzdDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFHUCw2SEFBNkg7UUFDN0gsb0hBQW9IO1FBQ3BILE1BQU0sYUFBYSxHQUFHLHFCQUFxQixDQUFDO1FBQzVDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVTtlQUNuQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFjO2VBQzlELElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRTtnQkFDL0MsU0FBUyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUk7YUFDMUMsQ0FBQyxDQUFDO1FBRUwsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLG9CQUFvQixDQUFDLGVBQWUsQ0FBQztZQUN2RCxVQUFVLEVBQUUsVUFBVTtZQUN0QixLQUFLLEVBQUUsYUFBYTtZQUNwQixXQUFXLEVBQUUsbUJBQW1CO1lBQ2hDLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU87WUFDUCxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLGtCQUFrQjtZQUM5QyxJQUFJLEVBQUUsVUFBVTtZQUVoQixpRkFBaUY7WUFDakYsdURBQXVEO1lBQ3ZELHdFQUF3RTtZQUN4RSw4REFBOEQ7WUFDOUQsb0JBQW9CLEVBQUUsSUFBQSwwQkFBYSxFQUFDLEtBQUssQ0FBQztnQkFDeEMsR0FBRyxJQUFBLG1CQUFNLEVBQUMsVUFBVSxDQUFDO2dCQUNyQixHQUFHLGFBQWE7Z0JBQ2hCLEdBQUcsY0FBYzthQUNsQixDQUFDLENBQUM7U0FDSixDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBRXhCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUM7S0FDMUM7Q0FDRjtBQTNPRCw0Q0EyT0M7QUFFRDs7R0FFRztBQUNILFNBQVMsaUNBQWlDLENBQUMsU0FBc0IsRUFBRSxNQUF5QjtJQUMxRixPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDeEIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBRXJCLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxLQUFLLENBQUMsU0FBUyxxQ0FBcUMsS0FBSyxDQUFDLFNBQVMsZ0dBQWdHLENBQUMsQ0FBQztRQUUvTCxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQzFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLGVBQWUsR0FBRyxDQUFDLENBQUM7U0FDcEQ7UUFFRCxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV6RCxTQUFTLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxRQUFRLENBQUMsWUFBWSxNQUFNLEtBQUssQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRTlGLE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLHdCQUF3QixDQUFDLFdBQXdCLEVBQUUsT0FBMEI7SUFDcEYsa0RBQWtEO0lBQ2xELHlGQUF5RjtJQUN6RixvQ0FBb0M7SUFDcEMsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUFFLE9BQU8sRUFBRSxDQUFDO0tBQUU7SUFFeEMsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUN4QixPQUFPO1lBQ0wsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDdEMsT0FBTyxFQUFFLE1BQU07U0FDaEIsQ0FBQztLQUNIO0lBRUQsTUFBTSxTQUFTLEdBQXdCLEVBQUUsQ0FBQztJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRTtRQUM1QixNQUFNLEdBQUcsR0FBRyxXQUFXLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV2RCxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUNyQixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7U0FDN0Q7UUFDRCxTQUFTLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHO1lBQzVCLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxTQUFTO1lBQ2xDLE9BQU8sRUFBRSxNQUFNO1NBQ2hCLENBQUM7S0FDSDtJQUVELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUM5QyxDQUFDO0FBRUQsU0FBZ0IscUJBQXFCLENBQUMsR0FBRyxJQUF5QztJQUNoRixNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUMzQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3BCLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN2QjtJQUNELE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWIsU0FBUyxNQUFNLENBQUMsQ0FBbUIsRUFBRSxDQUFtQjtRQUN0RCxPQUFPO1lBQ0wsZ0JBQWdCLEVBQUUsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNoRixVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxJQUFJLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDLENBQUM7WUFDeEUsY0FBYyxFQUFFLFlBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGNBQWMsSUFBSSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3BGLGdCQUFnQixFQUFFLElBQUEsNEJBQWUsRUFBQyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO1lBQ3pFLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHO1lBQ25CLGVBQWUsRUFBRSxDQUFDLENBQUMsZUFBZSxJQUFJLENBQUMsQ0FBQyxlQUFlO1lBQ3ZELE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxPQUFPO1lBQy9CLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLO1lBQ3pCLG1CQUFtQixFQUFFLFlBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNuRyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTztTQUNoQyxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUM7QUF0QkQsc0RBc0JDO0FBS0QsU0FBUyxzQkFBc0IsQ0FBQyxDQUE4QixFQUFFLENBQThCO0lBQzVGLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7UUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FBRTtJQUVoQyxPQUFPO1FBQ0wsVUFBVSxFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLFVBQVU7UUFDeEMsV0FBVyxFQUFFLENBQUMsQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLFdBQVc7UUFDM0Msb0JBQW9CLEVBQUU7WUFDcEIsR0FBRyxDQUFDLENBQUMsb0JBQW9CO1lBQ3pCLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQjtTQUMxQjtRQUNELFVBQVUsRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQyxVQUFVO0tBQ3pDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUksQ0FBZ0I7SUFDcEMsT0FBTyxDQUFDLEtBQUssU0FBUyxDQUFDO0FBQ3pCLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMseUJBQXlCLENBQUMsR0FBK0I7SUFDaEUsT0FBTztRQUNMLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTtRQUMxQixvQkFBb0IsRUFBRSxHQUFHLENBQUMsb0JBQW9CO1FBQzlDLElBQUksRUFBRSxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUk7UUFDMUIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUUsT0FBTztRQUNoQyxXQUFXLEVBQUUsR0FBRyxDQUFDLFdBQVc7UUFDNUIsc0JBQXNCLEVBQUUsR0FBRyxDQUFDLFVBQVUsRUFBRSxzQkFBc0I7UUFDOUQsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLFVBQVUsRUFBRSx5QkFBeUIsRUFBRSxTQUFTO0tBQ3hFLENBQUM7QUFDSixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLHdCQUF3QixDQUFDLENBQVM7SUFDekMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSx3QkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3JFLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsS0FBSyxDQUFDLEVBQXNDO0lBQ25ELE9BQU8sSUFBQSxtQkFBTSxFQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1NBQzdCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQztTQUNsQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQVUsQ0FBQyxDQUFDLENBQUM7QUFDbEQsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFJLEVBQU87SUFDOUIsT0FBTyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7QUFDeEMsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLHVCQUF1QixDQUFDLFNBQThCLEVBQUUsTUFBK0I7SUFDOUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7UUFBRSxPQUFPLFNBQVMsQ0FBQztLQUFFO0lBQ2pELE1BQU0sSUFBSSxHQUFJLFNBQWlCLENBQUMsSUFBSSxDQUFDO0lBRXJDLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQztJQUMzQixNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUM7SUFDM0IsTUFBTSxXQUFXLEdBQUcsTUFBTSxLQUFLLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO0lBRW5GLE9BQU8sU0FBUyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFckQsU0FBUyxPQUFPLENBQUMsQ0FBTTtRQUNyQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDcEIsTUFBTSxHQUFHLEdBQVUsRUFBRSxDQUFDO1lBQ3RCLEtBQUssTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNsQixNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxHQUFHLEtBQUssU0FBUyxJQUFJLEdBQUcsS0FBSyxXQUFXLEVBQUU7b0JBQzVDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ25CO2FBQ0Y7WUFDRCxPQUFPLEdBQUcsQ0FBQztTQUNaO1FBQ0QsSUFBSSxDQUFDLElBQUksT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFFO1lBQzlCLE9BQU8sSUFBQSxzQkFBUyxFQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM5QjtRQUNELE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELFNBQVMsVUFBVSxDQUFDLENBQU07UUFDeEIsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFBRSxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQUU7UUFDckQsS0FBSyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQUU7U0FDOUQ7UUFDRCxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IENvbnN0cnVjdCwgSURlcGVuZGFibGUsIE5vZGUgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IG1lcmdlQnVpbGRTcGVjcyB9IGZyb20gJy4vYnVpbGRzcGVjcyc7XG5pbXBvcnQgKiBhcyBjb2RlYnVpbGQgZnJvbSAnLi4vLi4vLi4vLi4vYXdzLWNvZGVidWlsZCc7XG5pbXBvcnQgKiBhcyBjb2RlcGlwZWxpbmUgZnJvbSAnLi4vLi4vLi4vLi4vYXdzLWNvZGVwaXBlbGluZSc7XG5pbXBvcnQgKiBhcyBjb2RlcGlwZWxpbmVfYWN0aW9ucyBmcm9tICcuLi8uLi8uLi8uLi9hd3MtY29kZXBpcGVsaW5lLWFjdGlvbnMnO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJy4uLy4uLy4uLy4uL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJy4uLy4uLy4uLy4uL2F3cy1pYW0nO1xuaW1wb3J0IHsgU3RhY2ssIFRva2VuIH0gZnJvbSAnLi4vLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBGaWxlU2V0TG9jYXRpb24sIFNoZWxsU3RlcCwgU3RhY2tPdXRwdXRSZWZlcmVuY2UgfSBmcm9tICcuLi8uLi9ibHVlcHJpbnQnO1xuaW1wb3J0IHsgU3RlcE91dHB1dCB9IGZyb20gJy4uLy4uL2hlbHBlcnMtaW50ZXJuYWwvc3RlcC1vdXRwdXQnO1xuaW1wb3J0IHsgY2xvdWRBc3NlbWJseUJ1aWxkU3BlY0Rpciwgb2J0YWluU2NvcGUgfSBmcm9tICcuLi8uLi9wcml2YXRlL2NvbnN0cnVjdC1pbnRlcm5hbHMnO1xuaW1wb3J0IHsgaGFzaCB9IGZyb20gJy4uLy4uL3ByaXZhdGUvaWRlbnRpZmllcnMnO1xuaW1wb3J0IHsgbWFwVmFsdWVzLCBta2RpY3QsIG5vRW1wdHlPYmplY3QsIG5vVW5kZWZpbmVkLCBwYXJ0aXRpb24gfSBmcm9tICcuLi8uLi9wcml2YXRlL2phdmFzY3JpcHQnO1xuaW1wb3J0IHsgQXJ0aWZhY3RNYXAgfSBmcm9tICcuLi9hcnRpZmFjdC1tYXAnO1xuaW1wb3J0IHsgQ29kZUJ1aWxkU3RlcCB9IGZyb20gJy4uL2NvZGVidWlsZC1zdGVwJztcbmltcG9ydCB7IENvZGVCdWlsZE9wdGlvbnMgfSBmcm9tICcuLi9jb2RlcGlwZWxpbmUnO1xuaW1wb3J0IHsgSUNvZGVQaXBlbGluZUFjdGlvbkZhY3RvcnksIFByb2R1Y2VBY3Rpb25PcHRpb25zLCBDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5UmVzdWx0IH0gZnJvbSAnLi4vY29kZXBpcGVsaW5lLWFjdGlvbi1mYWN0b3J5JztcblxuZXhwb3J0IGludGVyZmFjZSBDb2RlQnVpbGRGYWN0b3J5UHJvcHMge1xuICAvKipcbiAgICogTmFtZSBmb3IgdGhlIGdlbmVyYXRlZCBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkXG4gICAqL1xuICByZWFkb25seSBwcm9qZWN0TmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogQ3VzdG9taXphdGlvbiBvcHRpb25zIGZvciB0aGUgcHJvamVjdFxuICAgKlxuICAgKiBXaWxsIGF0IENvZGVCdWlsZCBwcm9kdWN0aW9uIHRpbWUgYmUgY29tYmluZWQgd2l0aCB0aGUgb3B0aW9uXG4gICAqIGRlZmF1bHRzIGNvbmZpZ3VyZWQgb24gdGhlIHBpcGVsaW5lLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHNwZWNpYWwgdmFsdWVzXG4gICAqL1xuICByZWFkb25seSBwcm9qZWN0T3B0aW9ucz86IENvZGVCdWlsZE9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBleGVjdXRpb24gcm9sZSB0byBiZSB1c2VkIGZvciB0aGUgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBBIHJvbGUgaXMgYXV0b21hdGljYWxseSBjcmVhdGVkXG4gICAqL1xuICByZWFkb25seSByb2xlPzogaWFtLklSb2xlO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gZXhlY3V0aW9uIHJvbGUgdG8gYmUgdXNlZCBmb3IgdGhlIENvZGUgQnVpbGQgQWN0aW9uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQSByb2xlIGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlZFxuICAgKi9cbiAgcmVhZG9ubHkgYWN0aW9uUm9sZT86IGlhbS5JUm9sZTtcblxuICAvKipcbiAgICogSWYgdHJ1ZSwgdGhlIGJ1aWxkIHNwZWMgd2lsbCBiZSBwYXNzZWQgdmlhIHRoZSBDbG91ZCBBc3NlbWJseSBpbnN0ZWFkIG9mIHJlbmRlcmVkIG9udG8gdGhlIFByb2plY3RcbiAgICpcbiAgICogRG9pbmcgdGhpcyBoYXMgdHdvIGFkdmFudGFnZXM6XG4gICAqXG4gICAqIC0gQnlwYXNzIHNpemUgcmVzdHJpY3Rpb25zOiB0aGUgYnVpbGRzcGVjIG9uIHRoZSBwcm9qZWN0IGlzIHJlc3RyaWN0ZWRcbiAgICogICBpbiBzaXplLCB3aGlsZSBidWlsZHNwZWNzIGNvbWluZyBmcm9tIGFuIGlucHV0IGFydGlmYWN0IGFyZSBub3QgcmVzdHJpY3RlZFxuICAgKiAgIGluIHN1Y2ggYSB3YXkuXG4gICAqIC0gQnlwYXNzIHBpcGVsaW5lIHVwZGF0ZTogaWYgdGhlIFNlbGZVcGRhdGUgc3RlcCBoYXMgdG8gY2hhbmdlIHRoZSBidWlsZHNwZWMsXG4gICAqICAgdGhhdCBqdXN0IHRha2VzIHRpbWUuIE9uIHRoZSBvdGhlciBoYW5kLCBpZiB0aGUgYnVpbGRzcGVjIGNvbWVzIGZyb20gdGhlXG4gICAqICAgcGlwZWxpbmUgYXJ0aWZhY3QsIG5vIHN1Y2ggdXBkYXRlIGhhcyB0byB0YWtlIHBsYWNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgcmVhZG9ubHkgcGFzc0J1aWxkU3BlY1ZpYUNsb3VkQXNzZW1ibHk/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBPdmVycmlkZSB0aGUgY29uc3RydWN0IHRyZWUgd2hlcmUgdGhlIENvZGVCdWlsZCBwcm9qZWN0IGlzIGNyZWF0ZWQuXG4gICAqXG4gICAqIE5vcm1hbGx5LCB0aGUgY29uc3RydWN0IHRyZWUgd2lsbCBsb29rIGxpa2UgdGhpczpcbiAgICpcbiAgICogIOKUgOKUgCBQaXBlbGluZVxuICAgKiAgICAgIOKUlOKUgOKUgCAnTXlTdGFnZScgICAgICAgICA8LSBvcHRpb25zLnNjb3BlXG4gICAqICAgICAgICAgICDilJTilIDilIAgJ015QWN0aW9uJyAgIDwtIHRoaXMgaXMgdGhlIENvZGVCdWlsZCBwcm9qZWN0XG4gICAqXG4gICAqIElmIHRoaXMgZmxhZyBpcyBzZXQsIHRoZSBjb25zdHJ1Y3QgdHJlZSB3aWxsIGxvb2sgbGlrZSB0aGlzOlxuICAgKlxuICAgKiAg4pSA4pSAIFBpcGVsaW5lXG4gICAqICAgICAg4pSU4pSA4pSAICdNeVN0YWdlJyAgICAgICAgICAgICAgICAgICAgICAgICA8LSBvcHRpb25zLnNjb3BlXG4gICAqICAgICAgICAgICDilJTilIDilIAgJ015QWN0aW9uJyAgICAgICAgICAgICAgICAgICA8LSBqdXN0IGEgc2NvcGVcbiAgICogICAgICAgICAgICAgICAgICDilJTilIDilIAgJ0JhY2t3YXJkc0NvbXBhdE5hbWUnIDwtIENvZGVCdWlsZCBwcm9qZWN0XG4gICAqXG4gICAqIFRoaXMgaXMgdG8gbWFpbnRhaW4gbG9naWNhbElEIGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgcHJldmlvdXMgaXRlcmF0aW9uXG4gICAqIG9mIHBpcGVsaW5lcyAod2hlcmUgdGhlIEFjdGlvbiB3YXMgYSBjb25zdHJ1Y3QgdGhhdCB3b3VsZCBjcmVhdGUgdGhlIFByb2plY3QpLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBhZGRpdGlvbmFsQ29uc3RydWN0TGV2ZWw/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIGRlcGVuZGVuY3kgdGhhdCB0aGUgQ29kZUJ1aWxkIHByb2plY3Qgc2hvdWxkIHRha2VcbiAgICpcbiAgICogQGRlZmF1bHQgLVxuICAgKi9cbiAgcmVhZG9ubHkgYWRkaXRpb25hbERlcGVuZGFibGU/OiBJRGVwZW5kYWJsZTtcblxuICByZWFkb25seSBpbnB1dHM/OiBGaWxlU2V0TG9jYXRpb25bXTtcbiAgcmVhZG9ubHkgb3V0cHV0cz86IEZpbGVTZXRMb2NhdGlvbltdO1xuXG4gIHJlYWRvbmx5IHN0ZXBJZD86IHN0cmluZztcblxuICByZWFkb25seSBjb21tYW5kczogc3RyaW5nW107XG4gIHJlYWRvbmx5IGluc3RhbGxDb21tYW5kcz86IHN0cmluZ1tdO1xuXG4gIHJlYWRvbmx5IGVudj86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHJlYWRvbmx5IGVudkZyb21DZm5PdXRwdXRzPzogUmVjb3JkPHN0cmluZywgU3RhY2tPdXRwdXRSZWZlcmVuY2U+O1xuXG4gIC8qKlxuICAgKiBJZiBnaXZlbiwgb3ZlcnJpZGUgdGhlIHNjb3BlIGZyb20gdGhlIHByb2R1Y2UgY2FsbCB3aXRoIHRoaXMgc2NvcGUuXG4gICAqL1xuICByZWFkb25seSBzY29wZT86IENvbnN0cnVjdDtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhlIGdpdmVuIENvZGVCdWlsZCBwcm9qZWN0IGlzIGdvaW5nIHRvIGJlIHRoZSBzeW50aCBzdGVwXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBpc1N5bnRoPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogU3RlcE91dHB1dHMgcHJvZHVjZWQgYnkgdGhpcyBDb2RlQnVpbGQgc3RlcFxuICAgKi9cbiAgcmVhZG9ubHkgcHJvZHVjZWRTdGVwT3V0cHV0cz86IFN0ZXBPdXRwdXRbXTtcbn1cblxuLyoqXG4gKiBQcm9kdWNlIGEgQ29kZUJ1aWxkIHByb2plY3QgZnJvbSBhIFNoZWxsU3RlcCBhbmQgc29tZSBDb2RlQnVpbGQtc3BlY2lmaWMgY3VzdG9taXphdGlvbnNcbiAqXG4gKiBUaGUgZnVuY3Rpb25hbGl0eSBoZXJlIGlzIHNoYXJlZCBiZXR3ZWVuIHRoZSBgQ29kZVBpcGVsaW5lYCB0cmFuc2xhdGluZyBhIGBTaGVsbFN0ZXBgIGludG9cbiAqIGEgQ29kZUJ1aWxkIHByb2plY3QsIGFzIHdlbGwgYXMgdGhlIGBDb2RlQnVpbGRTdGVwYCBzdHJhaWdodCB1cC5cbiAqL1xuZXhwb3J0IGNsYXNzIENvZGVCdWlsZEZhY3RvcnkgaW1wbGVtZW50cyBJQ29kZVBpcGVsaW5lQWN0aW9uRmFjdG9yeSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gIHB1YmxpYyBzdGF0aWMgZnJvbVNoZWxsU3RlcChjb25zdHJ1Y3RJZDogc3RyaW5nLCBzaGVsbFN0ZXA6IFNoZWxsU3RlcCwgYWRkaXRpb25hbD86IFBhcnRpYWw8Q29kZUJ1aWxkRmFjdG9yeVByb3BzPik6IElDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5IHtcbiAgICByZXR1cm4gbmV3IENvZGVCdWlsZEZhY3RvcnkoY29uc3RydWN0SWQsIHtcbiAgICAgIGNvbW1hbmRzOiBzaGVsbFN0ZXAuY29tbWFuZHMsXG4gICAgICBlbnY6IHNoZWxsU3RlcC5lbnYsXG4gICAgICBlbnZGcm9tQ2ZuT3V0cHV0czogc2hlbGxTdGVwLmVudkZyb21DZm5PdXRwdXRzLFxuICAgICAgaW5wdXRzOiBzaGVsbFN0ZXAuaW5wdXRzLFxuICAgICAgb3V0cHV0czogc2hlbGxTdGVwLm91dHB1dHMsXG4gICAgICBzdGVwSWQ6IHNoZWxsU3RlcC5pZCxcbiAgICAgIGluc3RhbGxDb21tYW5kczogc2hlbGxTdGVwLmluc3RhbGxDb21tYW5kcyxcbiAgICAgIHByb2R1Y2VkU3RlcE91dHB1dHM6IFN0ZXBPdXRwdXQucHJvZHVjZWRTdGVwT3V0cHV0cyhzaGVsbFN0ZXApLFxuICAgICAgLi4uYWRkaXRpb25hbCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUNvZGVCdWlsZFN0ZXAoY29uc3RydWN0SWQ6IHN0cmluZywgc3RlcDogQ29kZUJ1aWxkU3RlcCwgYWRkaXRpb25hbD86IFBhcnRpYWw8Q29kZUJ1aWxkRmFjdG9yeVByb3BzPik6IElDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5IHtcbiAgICBjb25zdCBmYWN0b3J5ID0gQ29kZUJ1aWxkRmFjdG9yeS5mcm9tU2hlbGxTdGVwKGNvbnN0cnVjdElkLCBzdGVwLCB7XG4gICAgICBwcm9qZWN0TmFtZTogc3RlcC5wcm9qZWN0TmFtZSxcbiAgICAgIHJvbGU6IHN0ZXAucm9sZSxcbiAgICAgIGFjdGlvblJvbGU6IHN0ZXAuYWN0aW9uUm9sZSxcbiAgICAgIC4uLmFkZGl0aW9uYWwsXG4gICAgICBwcm9qZWN0T3B0aW9uczogbWVyZ2VDb2RlQnVpbGRPcHRpb25zKGFkZGl0aW9uYWw/LnByb2plY3RPcHRpb25zLCB7XG4gICAgICAgIGJ1aWxkRW52aXJvbm1lbnQ6IHN0ZXAuYnVpbGRFbnZpcm9ubWVudCxcbiAgICAgICAgcm9sZVBvbGljeTogc3RlcC5yb2xlUG9saWN5U3RhdGVtZW50cyxcbiAgICAgICAgc2VjdXJpdHlHcm91cHM6IHN0ZXAuc2VjdXJpdHlHcm91cHMsXG4gICAgICAgIHBhcnRpYWxCdWlsZFNwZWM6IHN0ZXAucGFydGlhbEJ1aWxkU3BlYyxcbiAgICAgICAgdnBjOiBzdGVwLnZwYyxcbiAgICAgICAgc3VibmV0U2VsZWN0aW9uOiBzdGVwLnN1Ym5ldFNlbGVjdGlvbixcbiAgICAgICAgY2FjaGU6IHN0ZXAuY2FjaGUsXG4gICAgICAgIHRpbWVvdXQ6IHN0ZXAudGltZW91dCxcbiAgICAgICAgZmlsZVN5c3RlbUxvY2F0aW9uczogc3RlcC5maWxlU3lzdGVtTG9jYXRpb25zLFxuICAgICAgICBsb2dnaW5nOiBzdGVwLmxvZ2dpbmcsXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBwcm9kdWNlQWN0aW9uOiAoc3RhZ2UsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZmFjdG9yeS5wcm9kdWNlQWN0aW9uKHN0YWdlLCBvcHRpb25zKTtcbiAgICAgICAgaWYgKHJlc3VsdC5wcm9qZWN0KSB7XG4gICAgICAgICAgc3RlcC5fc2V0UHJvamVjdChyZXN1bHQucHJvamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgX3Byb2plY3Q/OiBjb2RlYnVpbGQuSVByb2plY3Q7XG4gIHByaXZhdGUgc3RlcElkOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnN0cnVjdElkOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQ29kZUJ1aWxkRmFjdG9yeVByb3BzKSB7XG5cbiAgICB0aGlzLnN0ZXBJZCA9IHByb3BzLnN0ZXBJZCA/PyBjb25zdHJ1Y3RJZDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcHJvamVjdCgpOiBjb2RlYnVpbGQuSVByb2plY3Qge1xuICAgIGlmICghdGhpcy5fcHJvamVjdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm9qZWN0IGJlY29tZXMgYXZhaWxhYmxlIGFmdGVyIHByb2R1Y2UoKSBoYXMgYmVlbiBjYWxsZWQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3Byb2plY3Q7XG4gIH1cblxuICBwdWJsaWMgcHJvZHVjZUFjdGlvbihzdGFnZTogY29kZXBpcGVsaW5lLklTdGFnZSwgb3B0aW9uczogUHJvZHVjZUFjdGlvbk9wdGlvbnMpOiBDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5UmVzdWx0IHtcbiAgICBjb25zdCBwcm9qZWN0T3B0aW9ucyA9IG1lcmdlQ29kZUJ1aWxkT3B0aW9ucyhvcHRpb25zLmNvZGVCdWlsZERlZmF1bHRzLCB0aGlzLnByb3BzLnByb2plY3RPcHRpb25zKTtcblxuICAgIGlmICgoIXByb2plY3RPcHRpb25zLmJ1aWxkRW52aXJvbm1lbnQ/LnByaXZpbGVnZWQgfHwgcHJvamVjdE9wdGlvbnMudnBjID09PSB1bmRlZmluZWQpICYmXG4gICAgICAocHJvamVjdE9wdGlvbnMuZmlsZVN5c3RlbUxvY2F0aW9ucyAhPT0gdW5kZWZpbmVkICYmIHByb2plY3RPcHRpb25zLmZpbGVTeXN0ZW1Mb2NhdGlvbnMubGVuZ3RoICE9IDApKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NldHRpbmcgZmlsZVN5c3RlbUxvY2F0aW9ucyByZXF1aXJlcyBhIHZwYyB0byBiZSBzZXQgYW5kIHByaXZpbGVnZWQgdG8gYmUgc2V0IHRvIHRydWUuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5wdXRzID0gdGhpcy5wcm9wcy5pbnB1dHMgPz8gW107XG4gICAgY29uc3Qgb3V0cHV0cyA9IHRoaXMucHJvcHMub3V0cHV0cyA/PyBbXTtcblxuICAgIGNvbnN0IG1haW5JbnB1dCA9IGlucHV0cy5maW5kKHggPT4geC5kaXJlY3RvcnkgPT09ICcuJyk7XG4gICAgY29uc3QgZXh0cmFJbnB1dHMgPSBpbnB1dHMuZmlsdGVyKHggPT4geC5kaXJlY3RvcnkgIT09ICcuJyk7XG5cbiAgICBjb25zdCBpbnB1dEFydGlmYWN0ID0gbWFpbklucHV0XG4gICAgICA/IG9wdGlvbnMuYXJ0aWZhY3RzLnRvQ29kZVBpcGVsaW5lKG1haW5JbnB1dC5maWxlU2V0KVxuICAgICAgOiBvcHRpb25zLmZhbGxiYWNrQXJ0aWZhY3Q7XG4gICAgY29uc3QgZXh0cmFJbnB1dEFydGlmYWN0cyA9IGV4dHJhSW5wdXRzLm1hcCh4ID0+IG9wdGlvbnMuYXJ0aWZhY3RzLnRvQ29kZVBpcGVsaW5lKHguZmlsZVNldCkpO1xuICAgIGNvbnN0IG91dHB1dEFydGlmYWN0cyA9IG91dHB1dHMubWFwKHggPT4gb3B0aW9ucy5hcnRpZmFjdHMudG9Db2RlUGlwZWxpbmUoeC5maWxlU2V0KSk7XG5cbiAgICBpZiAoIWlucHV0QXJ0aWZhY3QpIHtcbiAgICAgIC8vIFRoaXMgc2hvdWxkIGFjdHVhbGx5IG5ldmVyIGhhcHBlbiBiZWNhdXNlIENvZGVCdWlsZCBwcm9qZWN0cyBzaG91bGRuJ3QgYmUgYWRkZWQgYmVmb3JlIHRoZVxuICAgICAgLy8gU291cmNlLCB3aGljaCBhbHdheXMgcHJvZHVjZXMgYXQgbGVhc3QgYW4gYXJ0aWZhY3QuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvZGVCdWlsZCBhY3Rpb24gJyR7dGhpcy5zdGVwSWR9JyByZXF1aXJlcyBhbiBpbnB1dCAoYW5kIHRoZSBwaXBlbGluZSBkb2Vzbid0IGhhdmUgYSBTb3VyY2UgdG8gZmFsbCBiYWNrIHRvKS4gQWRkIGFuIGlucHV0IG9yIGEgcGlwZWxpbmUgc291cmNlLmApO1xuICAgIH1cblxuICAgIGNvbnN0IGluc3RhbGxDb21tYW5kcyA9IFtcbiAgICAgIC4uLmdlbmVyYXRlSW5wdXRBcnRpZmFjdExpbmtDb21tYW5kcyhvcHRpb25zLmFydGlmYWN0cywgZXh0cmFJbnB1dHMpLFxuICAgICAgLi4udGhpcy5wcm9wcy5pbnN0YWxsQ29tbWFuZHMgPz8gW10sXG4gICAgXTtcblxuICAgIGNvbnN0IGJ1aWxkU3BlY0hlcmUgPSBjb2RlYnVpbGQuQnVpbGRTcGVjLmZyb21PYmplY3Qoe1xuICAgICAgdmVyc2lvbjogJzAuMicsXG4gICAgICBwaGFzZXM6IHtcbiAgICAgICAgaW5zdGFsbDogKGluc3RhbGxDb21tYW5kcy5sZW5ndGggPz8gMCkgPiAwID8geyBjb21tYW5kczogaW5zdGFsbENvbW1hbmRzIH0gOiB1bmRlZmluZWQsXG4gICAgICAgIGJ1aWxkOiB0aGlzLnByb3BzLmNvbW1hbmRzLmxlbmd0aCA+IDAgPyB7IGNvbW1hbmRzOiB0aGlzLnByb3BzLmNvbW1hbmRzIH0gOiB1bmRlZmluZWQsXG4gICAgICB9LFxuICAgICAgYXJ0aWZhY3RzOiBub0VtcHR5T2JqZWN0PGFueT4ocmVuZGVyQXJ0aWZhY3RzQnVpbGRTcGVjKG9wdGlvbnMuYXJ0aWZhY3RzLCB0aGlzLnByb3BzLm91dHB1dHMgPz8gW10pKSxcbiAgICB9KTtcblxuICAgIC8vIFBhcnRpdGlvbiBlbnZpcm9ubWVudCB2YXJpYWJsZXMgaW50byBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCBjYW4gZ28gb24gdGhlIHByb2plY3RcbiAgICAvLyBhbmQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgTVVTVCBnbyBpbiB0aGUgcGlwZWxpbmUgKHRob3NlIHRoYXQgcmVmZXJlbmNlIENvZGVQaXBlbGluZSB2YXJpYWJsZXMpXG4gICAgY29uc3QgZW52ID0gbm9VbmRlZmluZWQodGhpcy5wcm9wcy5lbnYgPz8ge30pO1xuXG4gICAgY29uc3QgW2FjdGlvbkVudnMsIHByb2plY3RFbnZzXSA9IHBhcnRpdGlvbihPYmplY3QuZW50cmllcyhlbnYgPz8ge30pLCAoWywgdl0pID0+IGNvbnRhaW5zUGlwZWxpbmVWYXJpYWJsZSh2KSk7XG5cbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IG1lcmdlQnVpbGRFbnZpcm9ubWVudHMoXG4gICAgICBwcm9qZWN0T3B0aW9ucz8uYnVpbGRFbnZpcm9ubWVudCA/PyB7fSxcbiAgICAgIHtcbiAgICAgICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IG5vRW1wdHlPYmplY3QobWFwVmFsdWVzKG1rZGljdChwcm9qZWN0RW52cyksIHZhbHVlID0+ICh7IHZhbHVlIH0pKSksXG4gICAgICB9KTtcblxuICAgIGNvbnN0IGZ1bGxCdWlsZFNwZWMgPSBwcm9qZWN0T3B0aW9ucz8ucGFydGlhbEJ1aWxkU3BlY1xuICAgICAgPyBjb2RlYnVpbGQubWVyZ2VCdWlsZFNwZWNzKHByb2plY3RPcHRpb25zLnBhcnRpYWxCdWlsZFNwZWMsIGJ1aWxkU3BlY0hlcmUpXG4gICAgICA6IGJ1aWxkU3BlY0hlcmU7XG5cbiAgICBjb25zdCBvc0Zyb21FbnZpcm9ubWVudCA9IGVudmlyb25tZW50LmJ1aWxkSW1hZ2UgJiYgZW52aXJvbm1lbnQuYnVpbGRJbWFnZSBpbnN0YW5jZW9mIGNvZGVidWlsZC5XaW5kb3dzQnVpbGRJbWFnZVxuICAgICAgPyBlYzIuT3BlcmF0aW5nU3lzdGVtVHlwZS5XSU5ET1dTXG4gICAgICA6IGVjMi5PcGVyYXRpbmdTeXN0ZW1UeXBlLkxJTlVYO1xuXG4gICAgY29uc3QgYWN0dWFsQnVpbGRTcGVjID0gZmlsdGVyQnVpbGRTcGVjQ29tbWFuZHMoZnVsbEJ1aWxkU3BlYywgb3NGcm9tRW52aXJvbm1lbnQpO1xuXG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLnByb3BzLnNjb3BlID8/IG9wdGlvbnMuc2NvcGU7XG5cbiAgICBsZXQgcHJvamVjdEJ1aWxkU3BlYztcbiAgICBpZiAodGhpcy5wcm9wcy5wYXNzQnVpbGRTcGVjVmlhQ2xvdWRBc3NlbWJseSkge1xuICAgICAgLy8gV3JpdGUgdG8gZGlzayBhbmQgcmVwbGFjZSB3aXRoIGEgcmVmZXJlbmNlXG4gICAgICBjb25zdCByZWxhdGl2ZVNwZWNGaWxlID0gYGJ1aWxkc3BlYy0ke05vZGUub2Yoc2NvcGUpLmFkZHJ9LSR7dGhpcy5jb25zdHJ1Y3RJZH0ueWFtbGA7XG4gICAgICBjb25zdCBhYnNTcGVjRmlsZSA9IHBhdGguam9pbihjbG91ZEFzc2VtYmx5QnVpbGRTcGVjRGlyKHNjb3BlKSwgcmVsYXRpdmVTcGVjRmlsZSk7XG5cbiAgICAgIC8vIFRoaXMgc2hvdWxkIHJlc29sdmUgdG8gYSBwdXJlIEpTT04gc3RyaW5nLiBJZiBpdCByZXNvbHZlcyB0byBhbiBvYmplY3QsIGl0J3MgYSBDRk5cbiAgICAgIC8vIGV4cHJlc3Npb24sIGFuZCB3ZSBjYW4ndCBzdXBwb3J0IHRoYXQgeWV0LiBNYXliZSBzb21lZGF5IGlmIHdlIHRoaW5rIHJlYWxseSBoYXJkIGFib3V0IGl0LlxuICAgICAgY29uc3QgZmlsZUNvbnRlbnRzID0gU3RhY2sub2Yoc2NvcGUpLnJlc29sdmUoYWN0dWFsQnVpbGRTcGVjLnRvQnVpbGRTcGVjKCkpO1xuXG4gICAgICBpZiAodHlwZW9mIGZpbGVDb250ZW50cyAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGlzIEJ1aWxkU3BlYyBjb250YWlucyBDbG91ZEZvcm1hdGlvbiByZWZlcmVuY2VzIGFuZCBpcyBzdXBwb3J0ZWQgYnkgcHVibGlzaEluUGFyYWxsZWw9ZmFsc2U6ICR7SlNPTi5zdHJpbmdpZnkoZmlsZUNvbnRlbnRzLCB1bmRlZmluZWQsIDIpfWApO1xuICAgICAgfVxuICAgICAgZnMud3JpdGVGaWxlU3luYyhhYnNTcGVjRmlsZSwgZmlsZUNvbnRlbnRzLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xuICAgICAgcHJvamVjdEJ1aWxkU3BlYyA9IGNvZGVidWlsZC5CdWlsZFNwZWMuZnJvbVNvdXJjZUZpbGVuYW1lKHJlbGF0aXZlU3BlY0ZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9qZWN0QnVpbGRTcGVjID0gYWN0dWFsQnVpbGRTcGVjO1xuICAgIH1cblxuICAgIC8vIEEgaGFzaCBvdmVyIHRoZSB2YWx1ZXMgdGhhdCBtYWtlIHRoZSBDb2RlQnVpbGQgUHJvamVjdCB1bmlxdWUgKGFuZCBuZWNlc3NhcnlcbiAgICAvLyB0byByZXN0YXJ0IHRoZSBwaXBlbGluZSBpZiBvbmUgb2YgdGhlbSBjaGFuZ2VzKS4gcHJvamVjdE5hbWUgaXMgbm90IG5lY2Vzc2FyeSB0byBpbmNsdWRlXG4gICAgLy8gaGVyZSBiZWNhdXNlIHRoZSBwaXBlbGluZSB3aWxsIGRlZmluaXRlbHkgcmVzdGFydCBpZiBwcm9qZWN0TmFtZSBjaGFuZ2VzLlxuICAgIC8vIChSZXNvbHZlIHRva2VucylcbiAgICBjb25zdCBwcm9qZWN0Q29uZmlnSGFzaCA9IGhhc2goU3RhY2sub2Yoc2NvcGUpLnJlc29sdmUoe1xuICAgICAgZW52aXJvbm1lbnQ6IHNlcmlhbGl6ZUJ1aWxkRW52aXJvbm1lbnQoZW52aXJvbm1lbnQpLFxuICAgICAgYnVpbGRTcGVjU3RyaW5nOiBhY3R1YWxCdWlsZFNwZWMudG9CdWlsZFNwZWMoKSxcbiAgICB9KSk7XG5cbiAgICBjb25zdCBhY3Rpb25OYW1lID0gb3B0aW9ucy5hY3Rpb25OYW1lID8/IHRoaXMuc3RlcElkO1xuXG4gICAgbGV0IHByb2plY3RTY29wZSA9IHNjb3BlO1xuICAgIGlmICh0aGlzLnByb3BzLmFkZGl0aW9uYWxDb25zdHJ1Y3RMZXZlbCA/PyB0cnVlKSB7XG4gICAgICBwcm9qZWN0U2NvcGUgPSBvYnRhaW5TY29wZShzY29wZSwgYWN0aW9uTmFtZSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2FmZVBpcGVsaW5lTmFtZSA9IFRva2VuLmlzVW5yZXNvbHZlZChvcHRpb25zLnBpcGVsaW5lLnBpcGVsaW5lLnBpcGVsaW5lTmFtZSlcbiAgICAgID8gYCR7U3RhY2sub2Yob3B0aW9ucy5waXBlbGluZSkuc3RhY2tOYW1lfS8ke05vZGUub2Yob3B0aW9ucy5waXBlbGluZS5waXBlbGluZSkuaWR9YFxuICAgICAgOiBvcHRpb25zLnBpcGVsaW5lLnBpcGVsaW5lLnBpcGVsaW5lTmFtZTtcblxuICAgIGNvbnN0IHByb2plY3QgPSBuZXcgY29kZWJ1aWxkLlBpcGVsaW5lUHJvamVjdChwcm9qZWN0U2NvcGUsIHRoaXMuY29uc3RydWN0SWQsIHtcbiAgICAgIHByb2plY3ROYW1lOiB0aGlzLnByb3BzLnByb2plY3ROYW1lLFxuICAgICAgZGVzY3JpcHRpb246IGBQaXBlbGluZSBzdGVwICR7c2FmZVBpcGVsaW5lTmFtZX0vJHtzdGFnZS5zdGFnZU5hbWV9LyR7YWN0aW9uTmFtZX1gLnN1YnN0cmluZygwLCAyNTUpLFxuICAgICAgZW52aXJvbm1lbnQsXG4gICAgICB2cGM6IHByb2plY3RPcHRpb25zLnZwYyxcbiAgICAgIHN1Ym5ldFNlbGVjdGlvbjogcHJvamVjdE9wdGlvbnMuc3VibmV0U2VsZWN0aW9uLFxuICAgICAgc2VjdXJpdHlHcm91cHM6IHByb2plY3RPcHRpb25zLnNlY3VyaXR5R3JvdXBzLFxuICAgICAgY2FjaGU6IHByb2plY3RPcHRpb25zLmNhY2hlLFxuICAgICAgYnVpbGRTcGVjOiBwcm9qZWN0QnVpbGRTcGVjLFxuICAgICAgcm9sZTogdGhpcy5wcm9wcy5yb2xlLFxuICAgICAgdGltZW91dDogcHJvamVjdE9wdGlvbnMudGltZW91dCxcbiAgICAgIGZpbGVTeXN0ZW1Mb2NhdGlvbnM6IHByb2plY3RPcHRpb25zLmZpbGVTeXN0ZW1Mb2NhdGlvbnMsXG4gICAgICBsb2dnaW5nOiBwcm9qZWN0T3B0aW9ucy5sb2dnaW5nLFxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMucHJvcHMuYWRkaXRpb25hbERlcGVuZGFibGUpIHtcbiAgICAgIHByb2plY3Qubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMucHJvcHMuYWRkaXRpb25hbERlcGVuZGFibGUpO1xuICAgIH1cblxuICAgIGlmIChwcm9qZWN0T3B0aW9ucy5yb2xlUG9saWN5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHByb2plY3RPcHRpb25zLnJvbGVQb2xpY3kuZm9yRWFjaChwb2xpY3lTdGF0ZW1lbnQgPT4ge1xuICAgICAgICBwcm9qZWN0LmFkZFRvUm9sZVBvbGljeShwb2xpY3lTdGF0ZW1lbnQpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhY2tPdXRwdXRFbnYgPSBtYXBWYWx1ZXModGhpcy5wcm9wcy5lbnZGcm9tQ2ZuT3V0cHV0cyA/PyB7fSwgb3V0cHV0UmVmID0+XG4gICAgICBvcHRpb25zLnN0YWNrT3V0cHV0c01hcC50b0NvZGVQaXBlbGluZShvdXRwdXRSZWYpLFxuICAgICk7XG5cbiAgICBjb25zdCBjb25maWdIYXNoRW52ID0gb3B0aW9ucy5iZWZvcmVTZWxmTXV0YXRpb25cbiAgICAgID8geyBfUFJPSkVDVF9DT05GSUdfSEFTSDogcHJvamVjdENvbmZpZ0hhc2ggfVxuICAgICAgOiB7fTtcblxuXG4gICAgLy8gU3RhcnQgYWxsIENvZGVCdWlsZCBwcm9qZWN0cyBmcm9tIGEgc2luZ2xlIChzaGFyZWQpIEFjdGlvbiBSb2xlLCBzbyB0aGF0IHdlIGRvbid0IGhhdmUgdG8gZ2VuZXJhdGUgYW4gQWN0aW9uIFJvbGUgZm9yIGVhY2hcbiAgICAvLyBpbmRpdmlkdWFsIENvZGVCdWlsZCBQcm9qZWN0IGFuZCBibG93IG91dCB0aGUgcGlwZWxpbmUgcG9saWN5IHNpemUgKGFuZCBwb3RlbnRpYWxseSAjIG9mIHJlc291cmNlcyBpbiB0aGUgc3RhY2spLlxuICAgIGNvbnN0IGFjdGlvblJvbGVDaWQgPSAnQ29kZUJ1aWxkQWN0aW9uUm9sZSc7XG4gICAgY29uc3QgYWN0aW9uUm9sZSA9IHRoaXMucHJvcHMuYWN0aW9uUm9sZVxuICAgICAgPz8gb3B0aW9ucy5waXBlbGluZS5ub2RlLnRyeUZpbmRDaGlsZChhY3Rpb25Sb2xlQ2lkKSBhcyBpYW0uSVJvbGVcbiAgICAgID8/IG5ldyBpYW0uUm9sZShvcHRpb25zLnBpcGVsaW5lLCBhY3Rpb25Sb2xlQ2lkLCB7XG4gICAgICAgIGFzc3VtZWRCeTogb3B0aW9ucy5waXBlbGluZS5waXBlbGluZS5yb2xlLFxuICAgICAgfSk7XG5cbiAgICBzdGFnZS5hZGRBY3Rpb24obmV3IGNvZGVwaXBlbGluZV9hY3Rpb25zLkNvZGVCdWlsZEFjdGlvbih7XG4gICAgICBhY3Rpb25OYW1lOiBhY3Rpb25OYW1lLFxuICAgICAgaW5wdXQ6IGlucHV0QXJ0aWZhY3QsXG4gICAgICBleHRyYUlucHV0czogZXh0cmFJbnB1dEFydGlmYWN0cyxcbiAgICAgIG91dHB1dHM6IG91dHB1dEFydGlmYWN0cyxcbiAgICAgIHByb2plY3QsXG4gICAgICBydW5PcmRlcjogb3B0aW9ucy5ydW5PcmRlcixcbiAgICAgIHZhcmlhYmxlc05hbWVzcGFjZTogb3B0aW9ucy52YXJpYWJsZXNOYW1lc3BhY2UsXG4gICAgICByb2xlOiBhY3Rpb25Sb2xlLFxuXG4gICAgICAvLyBJbmNsdXNpb24gb2YgdGhlIGhhc2ggaGVyZSB3aWxsIGxlYWQgdG8gdGhlIHBpcGVsaW5lIHN0cnVjdHVyZSBmb3IgYW55IGNoYW5nZXNcbiAgICAgIC8vIG1hZGUgdGhlIGNvbmZpZyBvZiB0aGUgdW5kZXJseWluZyBDb2RlQnVpbGQgUHJvamVjdC5cbiAgICAgIC8vIEhlbmNlLCB0aGUgcGlwZWxpbmUgd2lsbCBiZSByZXN0YXJ0ZWQuIFRoaXMgaXMgbmVjZXNzYXJ5IGlmIHRoZSB1c2Vyc1xuICAgICAgLy8gYWRkcyAoZm9yIGV4YW1wbGUpIGJ1aWxkIG9yIHRlc3QgY29tbWFuZHMgdG8gdGhlIGJ1aWxkc3BlYy5cbiAgICAgIGVudmlyb25tZW50VmFyaWFibGVzOiBub0VtcHR5T2JqZWN0KGNiRW52KHtcbiAgICAgICAgLi4ubWtkaWN0KGFjdGlvbkVudnMpLFxuICAgICAgICAuLi5jb25maWdIYXNoRW52LFxuICAgICAgICAuLi5zdGFja091dHB1dEVudixcbiAgICAgIH0pKSxcbiAgICB9KSk7XG5cbiAgICB0aGlzLl9wcm9qZWN0ID0gcHJvamVjdDtcblxuICAgIHJldHVybiB7IHJ1bk9yZGVyc0NvbnN1bWVkOiAxLCBwcm9qZWN0IH07XG4gIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBjb21tYW5kcyB0byBtb3ZlIGFkZGl0aW9uYWwgaW5wdXQgYXJ0aWZhY3RzIGludG8gdGhlIHJpZ2h0IHBsYWNlXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlSW5wdXRBcnRpZmFjdExpbmtDb21tYW5kcyhhcnRpZmFjdHM6IEFydGlmYWN0TWFwLCBpbnB1dHM6IEZpbGVTZXRMb2NhdGlvbltdKTogc3RyaW5nW10ge1xuICByZXR1cm4gaW5wdXRzLm1hcChpbnB1dCA9PiB7XG4gICAgY29uc3QgZnJhZ21lbnRzID0gW107XG5cbiAgICBmcmFnbWVudHMucHVzaChgWyAhIC1kIFwiJHtpbnB1dC5kaXJlY3Rvcnl9XCIgXSB8fCB7IGVjaG8gJ2FkZGl0aW9uYWxJbnB1dHM6IFwiJHtpbnB1dC5kaXJlY3Rvcnl9XCIgbXVzdCBub3QgZXhpc3QgeWV0LiBJZiB5b3Ugd2FudCB0byBtZXJnZSBtdWx0aXBsZSBhcnRpZmFjdHMsIHVzZSBhIFwiY3BcIiBjb21tYW5kLic7IGV4aXQgMTsgfWApO1xuXG4gICAgY29uc3QgcGFyZW50RGlyZWN0b3J5ID0gcGF0aC5kaXJuYW1lKGlucHV0LmRpcmVjdG9yeSk7XG4gICAgaWYgKCFbJy4nLCAnLi4nXS5pbmNsdWRlcyhwYXJlbnREaXJlY3RvcnkpKSB7XG4gICAgICBmcmFnbWVudHMucHVzaChgbWtkaXIgLXAgLS0gXCIke3BhcmVudERpcmVjdG9yeX1cImApO1xuICAgIH1cblxuICAgIGNvbnN0IGFydGlmYWN0ID0gYXJ0aWZhY3RzLnRvQ29kZVBpcGVsaW5lKGlucHV0LmZpbGVTZXQpO1xuXG4gICAgZnJhZ21lbnRzLnB1c2goYGxuIC1zIC0tIFwiJENPREVCVUlMRF9TUkNfRElSXyR7YXJ0aWZhY3QuYXJ0aWZhY3ROYW1lfVwiIFwiJHtpbnB1dC5kaXJlY3Rvcnl9XCJgKTtcblxuICAgIHJldHVybiBmcmFnbWVudHMuam9pbignICYmICcpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVuZGVyQXJ0aWZhY3RzQnVpbGRTcGVjKGFydGlmYWN0TWFwOiBBcnRpZmFjdE1hcCwgb3V0cHV0czogRmlsZVNldExvY2F0aW9uW10pIHtcbiAgLy8gc2F2ZSB0aGUgZ2VuZXJhdGVkIGZpbGVzIGluIHRoZSBvdXRwdXQgYXJ0aWZhY3RcbiAgLy8gVGhpcyBwYXJ0IG9mIHRoZSBidWlsZHNwZWMgaGFzIHRvIGxvb2sgY29tcGxldGVseSBkaWZmZXJlbnQgZGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmVcbiAgLy8gdXNpbmcgc2Vjb25kYXJ5IGFydGlmYWN0cyBvciBub3QuXG4gIGlmIChvdXRwdXRzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4ge307IH1cblxuICBpZiAob3V0cHV0cy5sZW5ndGggPT09IDEpIHtcbiAgICByZXR1cm4ge1xuICAgICAgJ2Jhc2UtZGlyZWN0b3J5Jzogb3V0cHV0c1swXS5kaXJlY3RvcnksXG4gICAgICAnZmlsZXMnOiAnKiovKicsXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IHNlY29uZGFyeTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICBmb3IgKGNvbnN0IG91dHB1dCBvZiBvdXRwdXRzKSB7XG4gICAgY29uc3QgYXJ0ID0gYXJ0aWZhY3RNYXAudG9Db2RlUGlwZWxpbmUob3V0cHV0LmZpbGVTZXQpO1xuXG4gICAgaWYgKCFhcnQuYXJ0aWZhY3ROYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IGdpdmUgdGhlIG91dHB1dCBhcnRpZmFjdCBhIG5hbWUnKTtcbiAgICB9XG4gICAgc2Vjb25kYXJ5W2FydC5hcnRpZmFjdE5hbWVdID0ge1xuICAgICAgJ2Jhc2UtZGlyZWN0b3J5Jzogb3V0cHV0LmRpcmVjdG9yeSxcbiAgICAgICdmaWxlcyc6ICcqKi8qJyxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHsgJ3NlY29uZGFyeS1hcnRpZmFjdHMnOiBzZWNvbmRhcnkgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlQ29kZUJ1aWxkT3B0aW9ucyguLi5vcHRzOiBBcnJheTxDb2RlQnVpbGRPcHRpb25zIHwgdW5kZWZpbmVkPikge1xuICBjb25zdCB4cyA9IFt7fSwgLi4ub3B0cy5maWx0ZXIoaXNEZWZpbmVkKV07XG4gIHdoaWxlICh4cy5sZW5ndGggPiAxKSB7XG4gICAgY29uc3QgW2EsIGJdID0geHMuc3BsaWNlKHhzLmxlbmd0aCAtIDIsIDIpO1xuICAgIHhzLnB1c2gobWVyZ2UyKGEsIGIpKTtcbiAgfVxuICByZXR1cm4geHNbMF07XG5cbiAgZnVuY3Rpb24gbWVyZ2UyKGE6IENvZGVCdWlsZE9wdGlvbnMsIGI6IENvZGVCdWlsZE9wdGlvbnMpOiBDb2RlQnVpbGRPcHRpb25zIHtcbiAgICByZXR1cm4ge1xuICAgICAgYnVpbGRFbnZpcm9ubWVudDogbWVyZ2VCdWlsZEVudmlyb25tZW50cyhhLmJ1aWxkRW52aXJvbm1lbnQsIGIuYnVpbGRFbnZpcm9ubWVudCksXG4gICAgICByb2xlUG9saWN5OiBkZWZpbmVkQXJyYXkoWy4uLmEucm9sZVBvbGljeSA/PyBbXSwgLi4uYi5yb2xlUG9saWN5ID8/IFtdXSksXG4gICAgICBzZWN1cml0eUdyb3VwczogZGVmaW5lZEFycmF5KFsuLi5hLnNlY3VyaXR5R3JvdXBzID8/IFtdLCAuLi5iLnNlY3VyaXR5R3JvdXBzID8/IFtdXSksXG4gICAgICBwYXJ0aWFsQnVpbGRTcGVjOiBtZXJnZUJ1aWxkU3BlY3MoYS5wYXJ0aWFsQnVpbGRTcGVjLCBiLnBhcnRpYWxCdWlsZFNwZWMpLFxuICAgICAgdnBjOiBiLnZwYyA/PyBhLnZwYyxcbiAgICAgIHN1Ym5ldFNlbGVjdGlvbjogYi5zdWJuZXRTZWxlY3Rpb24gPz8gYS5zdWJuZXRTZWxlY3Rpb24sXG4gICAgICB0aW1lb3V0OiBiLnRpbWVvdXQgPz8gYS50aW1lb3V0LFxuICAgICAgY2FjaGU6IGIuY2FjaGUgPz8gYS5jYWNoZSxcbiAgICAgIGZpbGVTeXN0ZW1Mb2NhdGlvbnM6IGRlZmluZWRBcnJheShbLi4uYS5maWxlU3lzdGVtTG9jYXRpb25zID8/IFtdLCAuLi5iLmZpbGVTeXN0ZW1Mb2NhdGlvbnMgPz8gW11dKSxcbiAgICAgIGxvZ2dpbmc6IGIubG9nZ2luZyA/PyBhLmxvZ2dpbmcsXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBtZXJnZUJ1aWxkRW52aXJvbm1lbnRzKGE6IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50LCBiPzogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQpOiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudDtcbmZ1bmN0aW9uIG1lcmdlQnVpbGRFbnZpcm9ubWVudHMoYTogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQgfCB1bmRlZmluZWQsIGI6IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50KTogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQ7XG5mdW5jdGlvbiBtZXJnZUJ1aWxkRW52aXJvbm1lbnRzKGE/OiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudCwgYj86IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50KTogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQgfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBtZXJnZUJ1aWxkRW52aXJvbm1lbnRzKGE/OiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudCwgYj86IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50KSB7XG4gIGlmICghYSB8fCAhYikgeyByZXR1cm4gYSA/PyBiOyB9XG5cbiAgcmV0dXJuIHtcbiAgICBidWlsZEltYWdlOiBiLmJ1aWxkSW1hZ2UgPz8gYS5idWlsZEltYWdlLFxuICAgIGNvbXB1dGVUeXBlOiBiLmNvbXB1dGVUeXBlID8/IGEuY29tcHV0ZVR5cGUsXG4gICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IHtcbiAgICAgIC4uLmEuZW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgICAuLi5iLmVudmlyb25tZW50VmFyaWFibGVzLFxuICAgIH0sXG4gICAgcHJpdmlsZWdlZDogYi5wcml2aWxlZ2VkID8/IGEucHJpdmlsZWdlZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gaXNEZWZpbmVkPEE+KHg6IEEgfCB1bmRlZmluZWQpOiB4IGlzIE5vbk51bGxhYmxlPEE+IHtcbiAgcmV0dXJuIHggIT09IHVuZGVmaW5lZDtcbn1cblxuLyoqXG4gKiBTZXJpYWxpemUgYSBidWlsZCBlbnZpcm9ubWVudCB0byBkYXRhIChnZXQgcmlkIG9mIGNvbnN0cnVjdHMgJiBvYmplY3RzKSwgc28gd2UgY2FuIEpTT04uc3RyaW5naWZ5IGl0XG4gKi9cbmZ1bmN0aW9uIHNlcmlhbGl6ZUJ1aWxkRW52aXJvbm1lbnQoZW52OiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudCkge1xuICByZXR1cm4ge1xuICAgIHByaXZpbGVnZWQ6IGVudi5wcml2aWxlZ2VkLFxuICAgIGVudmlyb25tZW50VmFyaWFibGVzOiBlbnYuZW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgdHlwZTogZW52LmJ1aWxkSW1hZ2U/LnR5cGUsXG4gICAgaW1hZ2VJZDogZW52LmJ1aWxkSW1hZ2U/LmltYWdlSWQsXG4gICAgY29tcHV0ZVR5cGU6IGVudi5jb21wdXRlVHlwZSxcbiAgICBpbWFnZVB1bGxQcmluY2lwYWxUeXBlOiBlbnYuYnVpbGRJbWFnZT8uaW1hZ2VQdWxsUHJpbmNpcGFsVHlwZSxcbiAgICBzZWNyZXRzTWFuYWdlckFybjogZW52LmJ1aWxkSW1hZ2U/LnNlY3JldHNNYW5hZ2VyQ3JlZGVudGlhbHM/LnNlY3JldEFybixcbiAgfTtcbn1cblxuLyoqXG4gKiBXaGV0aGVyIHRoZSBnaXZlbiBzdHJpbmcgY29udGFpbnMgYSByZWZlcmVuY2UgdG8gYSBDb2RlUGlwZWxpbmUgdmFyaWFibGVcbiAqL1xuZnVuY3Rpb24gY29udGFpbnNQaXBlbGluZVZhcmlhYmxlKHM6IHN0cmluZykge1xuICByZXR1cm4gISFzLm1hdGNoKC8jXFx7W159XStcXH0vKSB8fCBTdGVwT3V0cHV0LmZpbmRBbGwocykubGVuZ3RoID4gMDtcbn1cblxuLyoqXG4gKiBUdXJuIGEgY29sbGVjdGlvbiBpbnRvIGEgY29sbGVjdGlvbiBvZiBDb2RlUGlwZWxpbmUgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gKi9cbmZ1bmN0aW9uIGNiRW52KHhzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+KTogUmVjb3JkPHN0cmluZywgY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnRWYXJpYWJsZT4ge1xuICByZXR1cm4gbWtkaWN0KE9iamVjdC5lbnRyaWVzKHhzKVxuICAgIC5maWx0ZXIoKFssIHZdKSA9PiB2ICE9PSB1bmRlZmluZWQpXG4gICAgLm1hcCgoW2ssIHZdKSA9PiBbaywgeyB2YWx1ZTogdiB9XSBhcyBjb25zdCkpO1xufVxuXG5mdW5jdGlvbiBkZWZpbmVkQXJyYXk8QT4oeHM6IEFbXSk6IEFbXSB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB4cy5sZW5ndGggPiAwID8geHMgOiB1bmRlZmluZWQ7XG59XG5cbi8qKlxuICogSWYgbGluZXMgaW4gdGhlIGJ1aWxkc3BlYyBzdGFydCB3aXRoICchV0lORE9XUyEnIG9yICchTElOVVghJywgb25seSByZW5kZXIgdGhlbSBvbiB0aGF0IHBsYXRmb3JtLlxuICpcbiAqIFZlcnkgcHJpdmF0ZSBwcm90b2NvbCBmb3Igbm93LCBidXQgbWF5IGNvbWUgaW4gaGFuZHkgaW4gb3RoZXIgbGlicmFyaWVzIGFzIHdlbGwuXG4gKi9cbmZ1bmN0aW9uIGZpbHRlckJ1aWxkU3BlY0NvbW1hbmRzKGJ1aWxkU3BlYzogY29kZWJ1aWxkLkJ1aWxkU3BlYywgb3NUeXBlOiBlYzIuT3BlcmF0aW5nU3lzdGVtVHlwZSkge1xuICBpZiAoIWJ1aWxkU3BlYy5pc0ltbWVkaWF0ZSkgeyByZXR1cm4gYnVpbGRTcGVjOyB9XG4gIGNvbnN0IHNwZWMgPSAoYnVpbGRTcGVjIGFzIGFueSkuc3BlYztcblxuICBjb25zdCB3aW5UYWcgPSAnIVdJTkRPV1MhJztcbiAgY29uc3QgbGludXhUYWcgPSAnIUxJTlVYISc7XG4gIGNvbnN0IGV4cGVjdGVkVGFnID0gb3NUeXBlID09PSBlYzIuT3BlcmF0aW5nU3lzdGVtVHlwZS5XSU5ET1dTID8gd2luVGFnIDogbGludXhUYWc7XG5cbiAgcmV0dXJuIGNvZGVidWlsZC5CdWlsZFNwZWMuZnJvbU9iamVjdChyZWN1cnNlKHNwZWMpKTtcblxuICBmdW5jdGlvbiByZWN1cnNlKHg6IGFueSk6IGFueSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoeCkpIHtcbiAgICAgIGNvbnN0IHJldDogYW55W10gPSBbXTtcbiAgICAgIGZvciAoY29uc3QgZWwgb2YgeCkge1xuICAgICAgICBjb25zdCBbdGFnLCBwYXlsb2FkXSA9IGV4dHJhY3RUYWcoZWwpO1xuICAgICAgICBpZiAodGFnID09PSB1bmRlZmluZWQgfHwgdGFnID09PSBleHBlY3RlZFRhZykge1xuICAgICAgICAgIHJldC5wdXNoKHBheWxvYWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICBpZiAoeCAmJiB0eXBlb2YgeCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBtYXBWYWx1ZXMoeCwgcmVjdXJzZSk7XG4gICAgfVxuICAgIHJldHVybiB4O1xuICB9XG5cbiAgZnVuY3Rpb24gZXh0cmFjdFRhZyh4OiBhbnkpOiBbc3RyaW5nIHwgdW5kZWZpbmVkLCBhbnldIHtcbiAgICBpZiAodHlwZW9mIHggIT09ICdzdHJpbmcnKSB7IHJldHVybiBbdW5kZWZpbmVkLCB4XTsgfVxuICAgIGZvciAoY29uc3QgdGFnIG9mIFt3aW5UYWcsIGxpbnV4VGFnXSkge1xuICAgICAgaWYgKHguc3RhcnRzV2l0aCh0YWcpKSB7IHJldHVybiBbdGFnLCB4LnNsaWNlKHRhZy5sZW5ndGgpXTsgfVxuICAgIH1cbiAgICByZXR1cm4gW3VuZGVmaW5lZCwgeF07XG4gIH1cbn1cbiJdfQ==