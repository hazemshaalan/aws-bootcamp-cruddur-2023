"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CodeBuildStep = void 0;
const jsiiDeprecationWarnings = require("../../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const codebuild = require("../../../aws-codebuild");
const buildspecs_1 = require("./private/buildspecs");
const outputs_1 = require("./private/outputs");
const blueprint_1 = require("../blueprint");
/**
 * Run a script as a CodeBuild Project
 *
 * The BuildSpec must be available inline--it cannot reference a file
 * on disk. If your current build instructions are in a file like
 * `buildspec.yml` in your repository, extract them to a script
 * (say, `build.sh`) and invoke that script as part of the build:
 *
 * ```ts
 * new pipelines.CodeBuildStep('Synth', {
 *   commands: ['./build.sh'],
 * });
 * ```
 */
class CodeBuildStep extends blueprint_1.ShellStep {
    constructor(id, props) {
        super(id, props);
        this.exportedVariables = new Set();
        this.exportedVarsRendered = false;
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_pipelines_CodeBuildStepProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, CodeBuildStep);
            }
            throw error;
        }
        this.projectName = props.projectName;
        this.buildEnvironment = props.buildEnvironment;
        this._partialBuildSpec = props.partialBuildSpec;
        this.vpc = props.vpc;
        this.subnetSelection = props.subnetSelection;
        this.cache = props.cache;
        this.role = props.role;
        this.actionRole = props.actionRole;
        this.rolePolicyStatements = props.rolePolicyStatements;
        this.securityGroups = props.securityGroups;
        this.timeout = props.timeout;
        this.fileSystemLocations = props.fileSystemLocations;
        this.logging = props.logging;
    }
    /**
     * CodeBuild Project generated for the pipeline
     *
     * Will only be available after the pipeline has been built.
     */
    get project() {
        if (!this._project) {
            throw new Error('Call pipeline.buildPipeline() before reading this property');
        }
        return this._project;
    }
    /**
     * The CodeBuild Project's principal
     */
    get grantPrincipal() {
        return this.project.grantPrincipal;
    }
    /**
     * Additional configuration that can only be configured via BuildSpec
     *
     * Contains exported variables
     *
     * @default - Contains the exported variables
     */
    get partialBuildSpec() {
        this.exportedVarsRendered = true;
        const varsBuildSpec = this.exportedVariables.size > 0 ? codebuild.BuildSpec.fromObject({
            version: '0.2',
            env: {
                'exported-variables': Array.from(this.exportedVariables),
            },
        }) : undefined;
        return (0, buildspecs_1.mergeBuildSpecs)(varsBuildSpec, this._partialBuildSpec);
    }
    /**
     * Reference a CodePipeline variable defined by the CodeBuildStep.
     *
     * The variable must be set in the shell of the CodeBuild step when
     * it finishes its `post_build` phase.
     *
     * @param variableName the name of the variable for reference.
     * @example
     * // Access the output of one CodeBuildStep in another CodeBuildStep
     * declare const pipeline: pipelines.CodePipeline;
     *
     * const step1 = new pipelines.CodeBuildStep('Step1', {
     *   commands: ['export MY_VAR=hello'],
     * });
     *
     * const step2 = new pipelines.CodeBuildStep('Step2', {
     *   env: {
     *     IMPORTED_VAR: step1.exportedVariable('MY_VAR'),
     *   },
     *   commands: ['echo $IMPORTED_VAR'],
     * });
     */
    exportedVariable(variableName) {
        if (this.exportedVarsRendered && !this.exportedVariables.has(variableName)) {
            throw new Error('exportVariable(): Pipeline has already been produced, cannot call this function anymore');
        }
        this.exportedVariables.add(variableName);
        return (0, outputs_1.makeCodePipelineOutput)(this, variableName);
    }
    /**
     * Set the internal project value
     *
     * @internal
     */
    _setProject(project) {
        this._project = project;
    }
}
_a = JSII_RTTI_SYMBOL_1;
CodeBuildStep[_a] = { fqn: "aws-cdk-lib.pipelines.CodeBuildStep", version: "2.77.0" };
exports.CodeBuildStep = CodeBuildStep;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWJ1aWxkLXN0ZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2RlYnVpbGQtc3RlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBb0Q7QUFJcEQscURBQXVEO0FBQ3ZELCtDQUEyRDtBQUMzRCw0Q0FBeUQ7QUEySHpEOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxNQUFhLGFBQWMsU0FBUSxxQkFBUztJQStGMUMsWUFBWSxFQUFVLEVBQUUsS0FBeUI7UUFDL0MsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUpGLHNCQUFpQixHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDL0MseUJBQW9CLEdBQUcsS0FBSyxDQUFDOzs7Ozs7K0NBN0YxQixhQUFhOzs7O1FBa0d0QixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7UUFDckMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztRQUMvQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDO1FBQ2hELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUNyQixJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDN0MsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUM7UUFDbkMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztRQUN2RCxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUM7UUFDM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQzdCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUM7UUFDckQsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO0tBQzlCO0lBRUQ7Ozs7T0FJRztJQUNILElBQVcsT0FBTztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDREQUE0RCxDQUFDLENBQUM7U0FDL0U7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7S0FDdEI7SUFFRDs7T0FFRztJQUNILElBQVcsY0FBYztRQUN2QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDO0tBQ3BDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsSUFBVyxnQkFBZ0I7UUFDekIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztRQUVqQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7WUFDckYsT0FBTyxFQUFFLEtBQUs7WUFDZCxHQUFHLEVBQUU7Z0JBQ0gsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7YUFDekQ7U0FDRixDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUVmLE9BQU8sSUFBQSw0QkFBZSxFQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztLQUMvRDtJQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0FxQkc7SUFDSSxnQkFBZ0IsQ0FBQyxZQUFvQjtRQUMxQyxJQUFJLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDMUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5RkFBeUYsQ0FBQyxDQUFDO1NBQzVHO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV6QyxPQUFPLElBQUEsZ0NBQXNCLEVBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQ25EO0lBRUQ7Ozs7T0FJRztJQUNJLFdBQVcsQ0FBQyxPQUEyQjtRQUM1QyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztLQUN6Qjs7OztBQS9MVSxzQ0FBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNvZGVidWlsZCBmcm9tICcuLi8uLi8uLi9hd3MtY29kZWJ1aWxkJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICcuLi8uLi8uLi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICcuLi8uLi8uLi9hd3MtaWFtJztcbmltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBtZXJnZUJ1aWxkU3BlY3MgfSBmcm9tICcuL3ByaXZhdGUvYnVpbGRzcGVjcyc7XG5pbXBvcnQgeyBtYWtlQ29kZVBpcGVsaW5lT3V0cHV0IH0gZnJvbSAnLi9wcml2YXRlL291dHB1dHMnO1xuaW1wb3J0IHsgU2hlbGxTdGVwLCBTaGVsbFN0ZXBQcm9wcyB9IGZyb20gJy4uL2JsdWVwcmludCc7XG5cbi8qKlxuICogQ29uc3RydWN0aW9uIHByb3BzIGZvciBhIENvZGVCdWlsZFN0ZXBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb2RlQnVpbGRTdGVwUHJvcHMgZXh0ZW5kcyBTaGVsbFN0ZXBQcm9wcyB7XG4gIC8qKlxuICAgKiBOYW1lIGZvciB0aGUgZ2VuZXJhdGVkIENvZGVCdWlsZCBwcm9qZWN0XG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQXV0b21hdGljYWxseSBnZW5lcmF0ZWRcbiAgICovXG4gIHJlYWRvbmx5IHByb2plY3ROYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gdGhhdCBjYW4gb25seSBiZSBjb25maWd1cmVkIHZpYSBCdWlsZFNwZWNcbiAgICpcbiAgICogWW91IHNob3VsZCBub3QgdXNlIHRoaXMgdG8gc3BlY2lmeSBvdXRwdXQgYXJ0aWZhY3RzOyB0aG9zZVxuICAgKiBzaG91bGQgYmUgc3VwcGxpZWQgdmlhIHRoZSBvdGhlciBwcm9wZXJ0aWVzIG9mIHRoaXMgY2xhc3MsIG90aGVyd2lzZVxuICAgKiBDREsgUGlwZWxpbmVzIHdvbid0IGJlIGFibGUgdG8gaW5zcGVjdCB0aGUgYXJ0aWZhY3RzLlxuICAgKlxuICAgKiBTZXQgdGhlIGBjb21tYW5kc2AgdG8gYW4gZW1wdHkgYXJyYXkgaWYgeW91IHdhbnQgdG8gZnVsbHkgc3BlY2lmeVxuICAgKiB0aGUgQnVpbGRTcGVjIHVzaW5nIHRoaXMgZmllbGQuXG4gICAqXG4gICAqIFRoZSBCdWlsZFNwZWMgbXVzdCBiZSBhdmFpbGFibGUgaW5saW5lLS1pdCBjYW5ub3QgcmVmZXJlbmNlIGEgZmlsZVxuICAgKiBvbiBkaXNrLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEJ1aWxkU3BlYyBjb21wbGV0ZWx5IGRlcml2ZWQgZnJvbSBvdGhlciBwcm9wZXJ0aWVzXG4gICAqL1xuICByZWFkb25seSBwYXJ0aWFsQnVpbGRTcGVjPzogY29kZWJ1aWxkLkJ1aWxkU3BlYztcblxuICAvKipcbiAgICogVGhlIFZQQyB3aGVyZSB0byBleGVjdXRlIHRoZSBTaW1wbGVTeW50aC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyBWUENcbiAgICovXG4gIHJlYWRvbmx5IHZwYz86IGVjMi5JVnBjO1xuXG4gIC8qKlxuICAgKiBXaGljaCBzdWJuZXRzIHRvIHVzZS5cbiAgICpcbiAgICogT25seSB1c2VkIGlmICd2cGMnIGlzIHN1cHBsaWVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEFsbCBwcml2YXRlIHN1Ym5ldHMuXG4gICAqL1xuICByZWFkb25seSBzdWJuZXRTZWxlY3Rpb24/OiBlYzIuU3VibmV0U2VsZWN0aW9uO1xuXG4gIC8qKlxuICAgKiBDYWNoaW5nIHN0cmF0ZWd5IHRvIHVzZS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyBjYWNoZVxuICAgKi9cbiAgcmVhZG9ubHkgY2FjaGU/OiBjb2RlYnVpbGQuQ2FjaGU7XG5cbiAgLyoqXG4gICAqIFBvbGljeSBzdGF0ZW1lbnRzIHRvIGFkZCB0byByb2xlIHVzZWQgZHVyaW5nIHRoZSBzeW50aFxuICAgKlxuICAgKiBDYW4gYmUgdXNlZCB0byBhZGQgYWNjZXMgdG8gYSBDb2RlQXJ0aWZhY3QgcmVwb3NpdG9yeSBldGMuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gcG9saWN5IHN0YXRlbWVudHMgYWRkZWQgdG8gQ29kZUJ1aWxkIFByb2plY3QgUm9sZVxuICAgKi9cbiAgcmVhZG9ubHkgcm9sZVBvbGljeVN0YXRlbWVudHM/OiBpYW0uUG9saWN5U3RhdGVtZW50W107XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBleGVjdXRpb24gcm9sZSB0byBiZSB1c2VkIGZvciB0aGUgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBBIHJvbGUgaXMgYXV0b21hdGljYWxseSBjcmVhdGVkXG4gICAqL1xuICByZWFkb25seSByb2xlPzogaWFtLklSb2xlO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gZXhlY3V0aW9uIHJvbGUgdG8gYmUgdXNlZCBmb3IgdGhlIENvZGUgQnVpbGQgQWN0aW9uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQSByb2xlIGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlZFxuICAgKi9cbiAgcmVhZG9ubHkgYWN0aW9uUm9sZT86IGlhbS5JUm9sZTtcblxuICAvKipcbiAgICogQ2hhbmdlcyB0byBlbnZpcm9ubWVudFxuICAgKlxuICAgKiBUaGlzIGVudmlyb25tZW50IHdpbGwgYmUgY29tYmluZWQgd2l0aCB0aGUgcGlwZWxpbmUncyBkZWZhdWx0XG4gICAqIGVudmlyb25tZW50LlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFVzZSB0aGUgcGlwZWxpbmUncyBkZWZhdWx0IGJ1aWxkIGVudmlyb25tZW50XG4gICAqL1xuICByZWFkb25seSBidWlsZEVudmlyb25tZW50PzogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQ7XG5cbiAgLyoqXG4gICAqIFdoaWNoIHNlY3VyaXR5IGdyb3VwIHRvIGFzc29jaWF0ZSB3aXRoIHRoZSBzY3JpcHQncyBwcm9qZWN0IG5ldHdvcmsgaW50ZXJmYWNlcy5cbiAgICogSWYgbm8gc2VjdXJpdHkgZ3JvdXAgaXMgaWRlbnRpZmllZCwgb25lIHdpbGwgYmUgY3JlYXRlZCBhdXRvbWF0aWNhbGx5LlxuICAgKlxuICAgKiBPbmx5IHVzZWQgaWYgJ3ZwYycgaXMgc3VwcGxpZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gU2VjdXJpdHkgZ3JvdXAgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQuXG4gICAqL1xuICByZWFkb25seSBzZWN1cml0eUdyb3Vwcz86IGVjMi5JU2VjdXJpdHlHcm91cFtdO1xuXG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIG1pbnV0ZXMgYWZ0ZXIgd2hpY2ggQVdTIENvZGVCdWlsZCBzdG9wcyB0aGUgYnVpbGQgaWYgaXQnc1xuICAgKiBub3QgY29tcGxldGUuIEZvciB2YWxpZCB2YWx1ZXMsIHNlZSB0aGUgdGltZW91dEluTWludXRlcyBmaWVsZCBpbiB0aGUgQVdTXG4gICAqIENvZGVCdWlsZCBVc2VyIEd1aWRlLlxuICAgKlxuICAgKiBAZGVmYXVsdCBEdXJhdGlvbi5ob3VycygxKVxuICAgKi9cbiAgcmVhZG9ubHkgdGltZW91dD86IER1cmF0aW9uO1xuXG4gIC8qKlxuICAgKiBQcm9qZWN0RmlsZVN5c3RlbUxvY2F0aW9uIG9iamVjdHMgZm9yIENvZGVCdWlsZCBidWlsZCBwcm9qZWN0cy5cbiAgICpcbiAgICogQSBQcm9qZWN0RmlsZVN5c3RlbUxvY2F0aW9uIG9iamVjdCBzcGVjaWZpZXMgdGhlIGlkZW50aWZpZXIsIGxvY2F0aW9uLCBtb3VudE9wdGlvbnMsIG1vdW50UG9pbnQsXG4gICAqIGFuZCB0eXBlIG9mIGEgZmlsZSBzeXN0ZW0gY3JlYXRlZCB1c2luZyBBbWF6b24gRWxhc3RpYyBGaWxlIFN5c3RlbS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBubyBmaWxlIHN5c3RlbSBsb2NhdGlvbnNcbiAgICovXG4gIHJlYWRvbmx5IGZpbGVTeXN0ZW1Mb2NhdGlvbnM/OiBjb2RlYnVpbGQuSUZpbGVTeXN0ZW1Mb2NhdGlvbltdO1xuXG4gIC8qKlxuICAgKiBJbmZvcm1hdGlvbiBhYm91dCBsb2dzIGZvciBDb2RlQnVpbGQgcHJvamVjdHMuIEEgQ29kZUJ1aWxkIHByb2plY3QgY2FuIGNyZWF0ZSBsb2dzIGluIEFtYXpvbiBDbG91ZFdhdGNoIExvZ3MsIGFuIFMzIGJ1Y2tldCwgb3IgYm90aC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBubyBsb2cgY29uZmlndXJhdGlvbiBpcyBzZXRcbiAgICovXG4gIHJlYWRvbmx5IGxvZ2dpbmc/OiBjb2RlYnVpbGQuTG9nZ2luZ09wdGlvbnM7XG59XG5cbi8qKlxuICogUnVuIGEgc2NyaXB0IGFzIGEgQ29kZUJ1aWxkIFByb2plY3RcbiAqXG4gKiBUaGUgQnVpbGRTcGVjIG11c3QgYmUgYXZhaWxhYmxlIGlubGluZS0taXQgY2Fubm90IHJlZmVyZW5jZSBhIGZpbGVcbiAqIG9uIGRpc2suIElmIHlvdXIgY3VycmVudCBidWlsZCBpbnN0cnVjdGlvbnMgYXJlIGluIGEgZmlsZSBsaWtlXG4gKiBgYnVpbGRzcGVjLnltbGAgaW4geW91ciByZXBvc2l0b3J5LCBleHRyYWN0IHRoZW0gdG8gYSBzY3JpcHRcbiAqIChzYXksIGBidWlsZC5zaGApIGFuZCBpbnZva2UgdGhhdCBzY3JpcHQgYXMgcGFydCBvZiB0aGUgYnVpbGQ6XG4gKlxuICogYGBgdHNcbiAqIG5ldyBwaXBlbGluZXMuQ29kZUJ1aWxkU3RlcCgnU3ludGgnLCB7XG4gKiAgIGNvbW1hbmRzOiBbJy4vYnVpbGQuc2gnXSxcbiAqIH0pO1xuICogYGBgXG4gKi9cbmV4cG9ydCBjbGFzcyBDb2RlQnVpbGRTdGVwIGV4dGVuZHMgU2hlbGxTdGVwIHtcbiAgLyoqXG4gICAqIE5hbWUgZm9yIHRoZSBnZW5lcmF0ZWQgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB2YWx1ZSBzcGVjaWZpZWQgYXQgY29uc3RydWN0aW9uIHRpbWUsIHVzZSBkZWZhdWx0c1xuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHByb2plY3ROYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIHdoZXJlIHRvIGV4ZWN1dGUgdGhlIFNpbXBsZVN5bnRoLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdnBjPzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFdoaWNoIHN1Ym5ldHMgdG8gdXNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc3VibmV0U2VsZWN0aW9uPzogZWMyLlN1Ym5ldFNlbGVjdGlvbjtcblxuICAvKipcbiAgICogQ2FjaGluZyBzdHJhdGVneSB0byB1c2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gY2FjaGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjYWNoZT86IGNvZGVidWlsZC5DYWNoZTtcblxuICAvKipcbiAgICogUG9saWN5IHN0YXRlbWVudHMgdG8gYWRkIHRvIHJvbGUgdXNlZCBkdXJpbmcgdGhlIHN5bnRoXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByb2xlUG9saWN5U3RhdGVtZW50cz86IGlhbS5Qb2xpY3lTdGF0ZW1lbnRbXTtcblxuICAvKipcbiAgICogQ3VzdG9tIGV4ZWN1dGlvbiByb2xlIHRvIGJlIHVzZWQgZm9yIHRoZSBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcm9sZT86IGlhbS5JUm9sZTtcblxuICAvKipcbiAgICogQ3VzdG9tIGV4ZWN1dGlvbiByb2xlIHRvIGJlIHVzZWQgZm9yIHRoZSBDb2RlIEJ1aWxkIEFjdGlvblxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEEgcm9sZSBpcyBhdXRvbWF0aWNhbGx5IGNyZWF0ZWRcbiAgICovXG4gIHJlYWRvbmx5IGFjdGlvblJvbGU/OiBpYW0uSVJvbGU7XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGVudmlyb25tZW50XG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHJlYWRvbmx5IGJ1aWxkRW52aXJvbm1lbnQ/OiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudDtcblxuICAvKipcbiAgICogV2hpY2ggc2VjdXJpdHkgZ3JvdXAgdG8gYXNzb2NpYXRlIHdpdGggdGhlIHNjcmlwdCdzIHByb2plY3QgbmV0d29yayBpbnRlcmZhY2VzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICByZWFkb25seSBzZWN1cml0eUdyb3Vwcz86IGVjMi5JU2VjdXJpdHlHcm91cFtdO1xuXG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIG1pbnV0ZXMgYWZ0ZXIgd2hpY2ggQVdTIENvZGVCdWlsZCBzdG9wcyB0aGUgYnVpbGQgaWYgaXQnc1xuICAgKiBub3QgY29tcGxldGUuIEZvciB2YWxpZCB2YWx1ZXMsIHNlZSB0aGUgdGltZW91dEluTWludXRlcyBmaWVsZCBpbiB0aGUgQVdTXG4gICAqIENvZGVCdWlsZCBVc2VyIEd1aWRlLlxuICAgKlxuICAgKiBAZGVmYXVsdCBEdXJhdGlvbi5ob3VycygxKVxuICAgKi9cbiAgcmVhZG9ubHkgdGltZW91dD86IER1cmF0aW9uO1xuXG4gIC8qKlxuICAgKiBQcm9qZWN0RmlsZVN5c3RlbUxvY2F0aW9uIG9iamVjdHMgZm9yIENvZGVCdWlsZCBidWlsZCBwcm9qZWN0cy5cbiAgICpcbiAgICogQSBQcm9qZWN0RmlsZVN5c3RlbUxvY2F0aW9uIG9iamVjdCBzcGVjaWZpZXMgdGhlIGlkZW50aWZpZXIsIGxvY2F0aW9uLCBtb3VudE9wdGlvbnMsIG1vdW50UG9pbnQsXG4gICAqIGFuZCB0eXBlIG9mIGEgZmlsZSBzeXN0ZW0gY3JlYXRlZCB1c2luZyBBbWF6b24gRWxhc3RpYyBGaWxlIFN5c3RlbS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBubyBmaWxlIHN5c3RlbSBsb2NhdGlvbnNcbiAgICovXG4gIHJlYWRvbmx5IGZpbGVTeXN0ZW1Mb2NhdGlvbnM/OiBjb2RlYnVpbGQuSUZpbGVTeXN0ZW1Mb2NhdGlvbltdO1xuXG4gIC8qKlxuICAgKiBJbmZvcm1hdGlvbiBhYm91dCBsb2dzIGZvciBDb2RlQnVpbGQgcHJvamVjdHMuIEEgQ29kZUJ1aWxkZSBwcm9qZWN0IGNhbiBjcmVhdGUgbG9ncyBpbiBBbWF6b24gQ2xvdWRXYXRjaCBMb2dzLCBhbiBTMyBidWNrZXQsIG9yIGJvdGguXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gbm8gbG9nIGNvbmZpZ3VyYXRpb24gaXMgc2V0XG4gICAqL1xuICByZWFkb25seSBsb2dnaW5nPzogY29kZWJ1aWxkLkxvZ2dpbmdPcHRpb25zO1xuXG4gIHByaXZhdGUgX3Byb2plY3Q/OiBjb2RlYnVpbGQuSVByb2plY3Q7XG4gIHByaXZhdGUgX3BhcnRpYWxCdWlsZFNwZWM/OiBjb2RlYnVpbGQuQnVpbGRTcGVjO1xuICBwcml2YXRlIHJlYWRvbmx5IGV4cG9ydGVkVmFyaWFibGVzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIHByaXZhdGUgZXhwb3J0ZWRWYXJzUmVuZGVyZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBwcm9wczogQ29kZUJ1aWxkU3RlcFByb3BzKSB7XG4gICAgc3VwZXIoaWQsIHByb3BzKTtcblxuICAgIHRoaXMucHJvamVjdE5hbWUgPSBwcm9wcy5wcm9qZWN0TmFtZTtcbiAgICB0aGlzLmJ1aWxkRW52aXJvbm1lbnQgPSBwcm9wcy5idWlsZEVudmlyb25tZW50O1xuICAgIHRoaXMuX3BhcnRpYWxCdWlsZFNwZWMgPSBwcm9wcy5wYXJ0aWFsQnVpbGRTcGVjO1xuICAgIHRoaXMudnBjID0gcHJvcHMudnBjO1xuICAgIHRoaXMuc3VibmV0U2VsZWN0aW9uID0gcHJvcHMuc3VibmV0U2VsZWN0aW9uO1xuICAgIHRoaXMuY2FjaGUgPSBwcm9wcy5jYWNoZTtcbiAgICB0aGlzLnJvbGUgPSBwcm9wcy5yb2xlO1xuICAgIHRoaXMuYWN0aW9uUm9sZSA9IHByb3BzLmFjdGlvblJvbGU7XG4gICAgdGhpcy5yb2xlUG9saWN5U3RhdGVtZW50cyA9IHByb3BzLnJvbGVQb2xpY3lTdGF0ZW1lbnRzO1xuICAgIHRoaXMuc2VjdXJpdHlHcm91cHMgPSBwcm9wcy5zZWN1cml0eUdyb3VwcztcbiAgICB0aGlzLnRpbWVvdXQgPSBwcm9wcy50aW1lb3V0O1xuICAgIHRoaXMuZmlsZVN5c3RlbUxvY2F0aW9ucyA9IHByb3BzLmZpbGVTeXN0ZW1Mb2NhdGlvbnM7XG4gICAgdGhpcy5sb2dnaW5nID0gcHJvcHMubG9nZ2luZztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb2RlQnVpbGQgUHJvamVjdCBnZW5lcmF0ZWQgZm9yIHRoZSBwaXBlbGluZVxuICAgKlxuICAgKiBXaWxsIG9ubHkgYmUgYXZhaWxhYmxlIGFmdGVyIHRoZSBwaXBlbGluZSBoYXMgYmVlbiBidWlsdC5cbiAgICovXG4gIHB1YmxpYyBnZXQgcHJvamVjdCgpOiBjb2RlYnVpbGQuSVByb2plY3Qge1xuICAgIGlmICghdGhpcy5fcHJvamVjdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWxsIHBpcGVsaW5lLmJ1aWxkUGlwZWxpbmUoKSBiZWZvcmUgcmVhZGluZyB0aGlzIHByb3BlcnR5Jyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9wcm9qZWN0O1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBDb2RlQnVpbGQgUHJvamVjdCdzIHByaW5jaXBhbFxuICAgKi9cbiAgcHVibGljIGdldCBncmFudFByaW5jaXBhbCgpOiBpYW0uSVByaW5jaXBhbCB7XG4gICAgcmV0dXJuIHRoaXMucHJvamVjdC5ncmFudFByaW5jaXBhbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gdGhhdCBjYW4gb25seSBiZSBjb25maWd1cmVkIHZpYSBCdWlsZFNwZWNcbiAgICpcbiAgICogQ29udGFpbnMgZXhwb3J0ZWQgdmFyaWFibGVzXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQ29udGFpbnMgdGhlIGV4cG9ydGVkIHZhcmlhYmxlc1xuICAgKi9cbiAgcHVibGljIGdldCBwYXJ0aWFsQnVpbGRTcGVjKCk6IGNvZGVidWlsZC5CdWlsZFNwZWMgfCB1bmRlZmluZWQge1xuICAgIHRoaXMuZXhwb3J0ZWRWYXJzUmVuZGVyZWQgPSB0cnVlO1xuXG4gICAgY29uc3QgdmFyc0J1aWxkU3BlYyA9IHRoaXMuZXhwb3J0ZWRWYXJpYWJsZXMuc2l6ZSA+IDAgPyBjb2RlYnVpbGQuQnVpbGRTcGVjLmZyb21PYmplY3Qoe1xuICAgICAgdmVyc2lvbjogJzAuMicsXG4gICAgICBlbnY6IHtcbiAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IEFycmF5LmZyb20odGhpcy5leHBvcnRlZFZhcmlhYmxlcyksXG4gICAgICB9LFxuICAgIH0pIDogdW5kZWZpbmVkO1xuXG4gICAgcmV0dXJuIG1lcmdlQnVpbGRTcGVjcyh2YXJzQnVpbGRTcGVjLCB0aGlzLl9wYXJ0aWFsQnVpbGRTcGVjKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZlcmVuY2UgYSBDb2RlUGlwZWxpbmUgdmFyaWFibGUgZGVmaW5lZCBieSB0aGUgQ29kZUJ1aWxkU3RlcC5cbiAgICpcbiAgICogVGhlIHZhcmlhYmxlIG11c3QgYmUgc2V0IGluIHRoZSBzaGVsbCBvZiB0aGUgQ29kZUJ1aWxkIHN0ZXAgd2hlblxuICAgKiBpdCBmaW5pc2hlcyBpdHMgYHBvc3RfYnVpbGRgIHBoYXNlLlxuICAgKlxuICAgKiBAcGFyYW0gdmFyaWFibGVOYW1lIHRoZSBuYW1lIG9mIHRoZSB2YXJpYWJsZSBmb3IgcmVmZXJlbmNlLlxuICAgKiBAZXhhbXBsZVxuICAgKiAvLyBBY2Nlc3MgdGhlIG91dHB1dCBvZiBvbmUgQ29kZUJ1aWxkU3RlcCBpbiBhbm90aGVyIENvZGVCdWlsZFN0ZXBcbiAgICogZGVjbGFyZSBjb25zdCBwaXBlbGluZTogcGlwZWxpbmVzLkNvZGVQaXBlbGluZTtcbiAgICpcbiAgICogY29uc3Qgc3RlcDEgPSBuZXcgcGlwZWxpbmVzLkNvZGVCdWlsZFN0ZXAoJ1N0ZXAxJywge1xuICAgKiAgIGNvbW1hbmRzOiBbJ2V4cG9ydCBNWV9WQVI9aGVsbG8nXSxcbiAgICogfSk7XG4gICAqXG4gICAqIGNvbnN0IHN0ZXAyID0gbmV3IHBpcGVsaW5lcy5Db2RlQnVpbGRTdGVwKCdTdGVwMicsIHtcbiAgICogICBlbnY6IHtcbiAgICogICAgIElNUE9SVEVEX1ZBUjogc3RlcDEuZXhwb3J0ZWRWYXJpYWJsZSgnTVlfVkFSJyksXG4gICAqICAgfSxcbiAgICogICBjb21tYW5kczogWydlY2hvICRJTVBPUlRFRF9WQVInXSxcbiAgICogfSk7XG4gICAqL1xuICBwdWJsaWMgZXhwb3J0ZWRWYXJpYWJsZSh2YXJpYWJsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuZXhwb3J0ZWRWYXJzUmVuZGVyZWQgJiYgIXRoaXMuZXhwb3J0ZWRWYXJpYWJsZXMuaGFzKHZhcmlhYmxlTmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZXhwb3J0VmFyaWFibGUoKTogUGlwZWxpbmUgaGFzIGFscmVhZHkgYmVlbiBwcm9kdWNlZCwgY2Fubm90IGNhbGwgdGhpcyBmdW5jdGlvbiBhbnltb3JlJyk7XG4gICAgfVxuXG4gICAgdGhpcy5leHBvcnRlZFZhcmlhYmxlcy5hZGQodmFyaWFibGVOYW1lKTtcblxuICAgIHJldHVybiBtYWtlQ29kZVBpcGVsaW5lT3V0cHV0KHRoaXMsIHZhcmlhYmxlTmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBpbnRlcm5hbCBwcm9qZWN0IHZhbHVlXG4gICAqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9zZXRQcm9qZWN0KHByb2plY3Q6IGNvZGVidWlsZC5JUHJvamVjdCkge1xuICAgIHRoaXMuX3Byb2plY3QgPSBwcm9qZWN0O1xuICB9XG59XG4iXX0=