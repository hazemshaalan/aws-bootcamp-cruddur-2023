"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BackupVault = exports.BackupVaultEvents = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const iam = require("../../aws-iam");
const core_1 = require("../../core");
const backup_generated_1 = require("./backup.generated");
/**
 * Backup vault events. Some events are no longer supported and will not return
 * statuses or notifications.
 *
 * @see https://docs.aws.amazon.com/aws-backup/latest/devguide/API_PutBackupVaultNotifications.html#API_PutBackupVaultNotifications_RequestBody
 */
var BackupVaultEvents;
(function (BackupVaultEvents) {
    /** BACKUP_JOB_STARTED */
    BackupVaultEvents["BACKUP_JOB_STARTED"] = "BACKUP_JOB_STARTED";
    /** BACKUP_JOB_COMPLETED */
    BackupVaultEvents["BACKUP_JOB_COMPLETED"] = "BACKUP_JOB_COMPLETED";
    /** BACKUP_JOB_SUCCESSFUL */
    BackupVaultEvents["BACKUP_JOB_SUCCESSFUL"] = "BACKUP_JOB_SUCCESSFUL";
    /** BACKUP_JOB_FAILED */
    BackupVaultEvents["BACKUP_JOB_FAILED"] = "BACKUP_JOB_FAILED";
    /** BACKUP_JOB_EXPIRED */
    BackupVaultEvents["BACKUP_JOB_EXPIRED"] = "BACKUP_JOB_EXPIRED";
    /** RESTORE_JOB_STARTED */
    BackupVaultEvents["RESTORE_JOB_STARTED"] = "RESTORE_JOB_STARTED";
    /** RESTORE_JOB_COMPLETED */
    BackupVaultEvents["RESTORE_JOB_COMPLETED"] = "RESTORE_JOB_COMPLETED";
    /** RESTORE_JOB_SUCCESSFUL */
    BackupVaultEvents["RESTORE_JOB_SUCCESSFUL"] = "RESTORE_JOB_SUCCESSFUL";
    /** RESTORE_JOB_FAILED */
    BackupVaultEvents["RESTORE_JOB_FAILED"] = "RESTORE_JOB_FAILED";
    /** COPY_JOB_STARTED */
    BackupVaultEvents["COPY_JOB_STARTED"] = "COPY_JOB_STARTED";
    /** COPY_JOB_SUCCESSFUL */
    BackupVaultEvents["COPY_JOB_SUCCESSFUL"] = "COPY_JOB_SUCCESSFUL";
    /** COPY_JOB_FAILED */
    BackupVaultEvents["COPY_JOB_FAILED"] = "COPY_JOB_FAILED";
    /** RECOVERY_POINT_MODIFIED */
    BackupVaultEvents["RECOVERY_POINT_MODIFIED"] = "RECOVERY_POINT_MODIFIED";
    /** BACKUP_PLAN_CREATED */
    BackupVaultEvents["BACKUP_PLAN_CREATED"] = "BACKUP_PLAN_CREATED";
    /** BACKUP_PLAN_MODIFIED */
    BackupVaultEvents["BACKUP_PLAN_MODIFIED"] = "BACKUP_PLAN_MODIFIED";
    /** S3_BACKUP_OBJECT_FAILED */
    BackupVaultEvents["S3_BACKUP_OBJECT_FAILED"] = "S3_BACKUP_OBJECT_FAILED";
    /** BACKUP_PLAN_MODIFIED */
    BackupVaultEvents["S3_RESTORE_OBJECT_FAILED"] = "S3_RESTORE_OBJECT_FAILED";
})(BackupVaultEvents = exports.BackupVaultEvents || (exports.BackupVaultEvents = {}));
class BackupVaultBase extends core_1.Resource {
    /**
     * Grant the actions defined in actions to the given grantee
     * on this Backup Vault resource.
     *
     * @param grantee Principal to grant right to
     * @param actions The actions to grant
     */
    grant(grantee, ...actions) {
        for (const action of actions) {
            if (action.indexOf('*') >= 0) {
                throw new Error("AWS Backup access policies don't support a wildcard in the Action key.");
            }
        }
        return iam.Grant.addToPrincipal({
            grantee: grantee,
            actions: actions,
            resourceArns: [this.backupVaultArn],
        });
    }
}
/**
 * A backup vault
 */
class BackupVault extends BackupVaultBase {
    /**
     * Import an existing backup vault by name
     */
    static fromBackupVaultName(scope, id, backupVaultName) {
        const backupVaultArn = core_1.Stack.of(scope).formatArn({
            service: 'backup',
            resource: 'backup-vault',
            resourceName: backupVaultName,
            arnFormat: core_1.ArnFormat.COLON_RESOURCE_NAME,
        });
        return BackupVault.fromBackupVaultArn(scope, id, backupVaultArn);
    }
    /**
     * Import an existing backup vault by arn
     */
    static fromBackupVaultArn(scope, id, backupVaultArn) {
        const parsedArn = core_1.Stack.of(scope).splitArn(backupVaultArn, core_1.ArnFormat.COLON_RESOURCE_NAME);
        if (parsedArn.arnFormat !== core_1.ArnFormat.COLON_RESOURCE_NAME) {
            throw new Error(`Backup Vault Arn ${backupVaultArn} has the wrong format, expected ${core_1.ArnFormat.COLON_RESOURCE_NAME}.`);
        }
        if (!parsedArn.resourceName) {
            throw new Error(`Backup Vault Arn ${backupVaultArn} does not have a resource name.`);
        }
        class Import extends BackupVaultBase {
            constructor() {
                super(...arguments);
                this.backupVaultName = parsedArn.resourceName;
                this.backupVaultArn = backupVaultArn;
            }
        }
        return new Import(scope, id, {
            account: parsedArn.account,
            region: parsedArn.region,
        });
    }
    constructor(scope, id, props = {}) {
        super(scope, id);
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_backup_BackupVaultProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, BackupVault);
            }
            throw error;
        }
        if (props.backupVaultName && !/^[a-zA-Z0-9\-_]{2,50}$/.test(props.backupVaultName)) {
            throw new Error('Expected vault name to match pattern `^[a-zA-Z0-9\-_]{2,50}$`');
        }
        let notifications;
        if (props.notificationTopic) {
            notifications = {
                backupVaultEvents: props.notificationEvents || Object.values(BackupVaultEvents),
                snsTopicArn: props.notificationTopic.topicArn,
            };
            props.notificationTopic.grantPublish(new iam.ServicePrincipal('backup.amazonaws.com'));
        }
        this.accessPolicy = props.accessPolicy ?? new iam.PolicyDocument();
        if (props.blockRecoveryPointDeletion) {
            this.blockRecoveryPointDeletion();
        }
        const vault = new backup_generated_1.CfnBackupVault(this, 'Resource', {
            backupVaultName: props.backupVaultName || this.uniqueVaultName(),
            accessPolicy: core_1.Lazy.any({ produce: () => this.accessPolicy.toJSON() }),
            encryptionKeyArn: props.encryptionKey && props.encryptionKey.keyArn,
            notifications,
            lockConfiguration: renderLockConfiguration(props.lockConfiguration),
        });
        vault.applyRemovalPolicy(props.removalPolicy);
        this.backupVaultName = vault.attrBackupVaultName;
        this.backupVaultArn = vault.attrBackupVaultArn;
    }
    /**
     * Adds a statement to the vault access policy
     */
    addToAccessPolicy(statement) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_iam_PolicyStatement(statement);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addToAccessPolicy);
            }
            throw error;
        }
        this.accessPolicy.addStatements(statement);
    }
    /**
     * Adds a statement to the vault access policy that prevents anyone
     * from deleting a recovery point.
     */
    blockRecoveryPointDeletion() {
        this.addToAccessPolicy(new iam.PolicyStatement({
            effect: iam.Effect.DENY,
            actions: [
                'backup:DeleteRecoveryPoint',
                'backup:UpdateRecoveryPointLifecycle',
            ],
            principals: [new iam.AnyPrincipal()],
            resources: ['*'],
        }));
    }
    uniqueVaultName() {
        // Max length of 50 chars, get the last 50 chars
        const id = core_1.Names.uniqueId(this);
        return id.substring(Math.max(id.length - 50, 0), id.length);
    }
}
_a = JSII_RTTI_SYMBOL_1;
BackupVault[_a] = { fqn: "aws-cdk-lib.aws_backup.BackupVault", version: "2.77.0" };
exports.BackupVault = BackupVault;
function renderLockConfiguration(config) {
    if (!config) {
        return undefined;
    }
    if (config.changeableFor && config.changeableFor.toHours() < 72) {
        throw new Error(`AWS Backup enforces a 72-hour cooling-off period before Vault Lock takes effect and becomes immutable, got ${config.changeableFor.toHours()} hours`);
    }
    if (config.maxRetention) {
        if (config.maxRetention.toDays() > 36500) {
            throw new Error(`The longest maximum retention period you can specify is 36500 days, got ${config.maxRetention.toDays()} days`);
        }
        if (config.maxRetention.toDays() <= config.minRetention.toDays()) {
            throw new Error(`The maximum retention period (${config.maxRetention.toDays()} days) must be greater than the minimum retention period (${config.minRetention.toDays()} days)`);
        }
    }
    if (config.minRetention.toHours() < 24) {
        throw new Error(`The shortest minimum retention period you can specify is 1 day, got ${config.minRetention.toHours()} hours`);
    }
    return {
        minRetentionDays: config.minRetention.toDays(),
        maxRetentionDays: config.maxRetention?.toDays(),
        changeableForDays: config.changeableFor?.toDays(),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmF1bHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2YXVsdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxxQ0FBcUM7QUFHckMscUNBQXlHO0FBRXpHLHlEQUFvRDtBQW1HcEQ7Ozs7O0dBS0c7QUFDSCxJQUFZLGlCQW1DWDtBQW5DRCxXQUFZLGlCQUFpQjtJQUMzQix5QkFBeUI7SUFDekIsOERBQXlDLENBQUE7SUFDekMsMkJBQTJCO0lBQzNCLGtFQUE2QyxDQUFBO0lBQzdDLDRCQUE0QjtJQUM1QixvRUFBK0MsQ0FBQTtJQUMvQyx3QkFBd0I7SUFDeEIsNERBQXVDLENBQUE7SUFDdkMseUJBQXlCO0lBQ3pCLDhEQUF5QyxDQUFBO0lBQ3pDLDBCQUEwQjtJQUMxQixnRUFBMkMsQ0FBQTtJQUMzQyw0QkFBNEI7SUFDNUIsb0VBQStDLENBQUE7SUFDL0MsNkJBQTZCO0lBQzdCLHNFQUFpRCxDQUFBO0lBQ2pELHlCQUF5QjtJQUN6Qiw4REFBeUMsQ0FBQTtJQUN6Qyx1QkFBdUI7SUFDdkIsMERBQXFDLENBQUE7SUFDckMsMEJBQTBCO0lBQzFCLGdFQUEyQyxDQUFBO0lBQzNDLHNCQUFzQjtJQUN0Qix3REFBbUMsQ0FBQTtJQUNuQyw4QkFBOEI7SUFDOUIsd0VBQW1ELENBQUE7SUFDbkQsMEJBQTBCO0lBQzFCLGdFQUEyQyxDQUFBO0lBQzNDLDJCQUEyQjtJQUMzQixrRUFBNkMsQ0FBQTtJQUM3Qyw4QkFBOEI7SUFDOUIsd0VBQW1ELENBQUE7SUFDbkQsMkJBQTJCO0lBQzNCLDBFQUFxRCxDQUFBO0FBQ3ZELENBQUMsRUFuQ1csaUJBQWlCLEdBQWpCLHlCQUFpQixLQUFqQix5QkFBaUIsUUFtQzVCO0FBbURELE1BQWUsZUFBZ0IsU0FBUSxlQUFRO0lBSTdDOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxPQUF1QixFQUFFLEdBQUcsT0FBaUI7UUFDeEQsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPLEVBQUU7WUFDNUIsSUFBSSxN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QVksQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDakw7S0FDRjtJQUVELElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1RUFBdUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDL0g7SUFFRCxPQUFPO1FBQ0wsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUU7UUFDOUMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUU7UUFDL0MsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUU7S0FDbEQsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBrbXMgZnJvbSAnLi4vLi4vYXdzLWttcyc7XG5pbXBvcnQgKiBhcyBzbnMgZnJvbSAnLi4vLi4vYXdzLXNucyc7XG5pbXBvcnQgeyBBcm5Gb3JtYXQsIER1cmF0aW9uLCBJUmVzb3VyY2UsIExhenksIE5hbWVzLCBSZW1vdmFsUG9saWN5LCBSZXNvdXJjZSwgU3RhY2sgfSBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQ2ZuQmFja3VwVmF1bHQgfSBmcm9tICcuL2JhY2t1cC5nZW5lcmF0ZWQnO1xuXG4vKipcbiAqIEEgYmFja3VwIHZhdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUJhY2t1cFZhdWx0IGV4dGVuZHMgSVJlc291cmNlIHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIGEgbG9naWNhbCBjb250YWluZXIgd2hlcmUgYmFja3VwcyBhcmUgc3RvcmVkLlxuICAgKlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBiYWNrdXBWYXVsdE5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgYmFja3VwIHZhdWx0LlxuICAgKlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBiYWNrdXBWYXVsdEFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBHcmFudCB0aGUgYWN0aW9ucyBkZWZpbmVkIGluIGFjdGlvbnMgdG8gdGhlIGdpdmVuIGdyYW50ZWVcbiAgICogb24gdGhpcyBiYWNrdXAgdmF1bHQuXG4gICAqL1xuICBncmFudChncmFudGVlOiBpYW0uSUdyYW50YWJsZSwgLi4uYWN0aW9uczogc3RyaW5nW10pOiBpYW0uR3JhbnQ7XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgYSBCYWNrdXBWYXVsdFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEJhY2t1cFZhdWx0UHJvcHMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgYSBsb2dpY2FsIGNvbnRhaW5lciB3aGVyZSBiYWNrdXBzIGFyZSBzdG9yZWQuIEJhY2t1cCB2YXVsdHNcbiAgICogYXJlIGlkZW50aWZpZWQgYnkgbmFtZXMgdGhhdCBhcmUgdW5pcXVlIHRvIHRoZSBhY2NvdW50IHVzZWQgdG8gY3JlYXRlXG4gICAqIHRoZW0gYW5kIHRoZSBBV1MgUmVnaW9uIHdoZXJlIHRoZXkgYXJlIGNyZWF0ZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQSBDREsgZ2VuZXJhdGVkIG5hbWVcbiAgICovXG4gIHJlYWRvbmx5IGJhY2t1cFZhdWx0TmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogQSByZXNvdXJjZS1iYXNlZCBwb2xpY3kgdGhhdCBpcyB1c2VkIHRvIG1hbmFnZSBhY2Nlc3MgcGVybWlzc2lvbnMgb24gdGhlXG4gICAqIGJhY2t1cCB2YXVsdC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBhY2Nlc3MgaXMgbm90IHJlc3RyaWN0ZWRcbiAgICovXG4gIHJlYWRvbmx5IGFjY2Vzc1BvbGljeT86IGlhbS5Qb2xpY3lEb2N1bWVudDtcblxuICAvKipcbiAgICogVGhlIHNlcnZlci1zaWRlIGVuY3J5cHRpb24ga2V5IHRvIHVzZSB0byBwcm90ZWN0IHlvdXIgYmFja3Vwcy5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBhbiBBbWF6b24gbWFuYWdlZCBLTVMga2V5XG4gICAqL1xuICByZWFkb25seSBlbmNyeXB0aW9uS2V5Pzoga21zLklLZXk7XG5cbiAgLyoqXG4gICAqIEEgU05TIHRvcGljIHRvIHNlbmQgdmF1bHQgZXZlbnRzIHRvLlxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3MtYmFja3VwL2xhdGVzdC9kZXZndWlkZS9zbnMtbm90aWZpY2F0aW9ucy5odG1sXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gbm8gbm90aWZpY2F0aW9uc1xuICAgKi9cbiAgcmVhZG9ubHkgbm90aWZpY2F0aW9uVG9waWM/OiBzbnMuSVRvcGljXG5cbiAgLyoqXG4gICAqIFRoZSB2YXVsdCBldmVudHMgdG8gc2VuZC5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYXdzLWJhY2t1cC9sYXRlc3QvZGV2Z3VpZGUvc25zLW5vdGlmaWNhdGlvbnMuaHRtbFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIGFsbCB2YXVsdCBldmVudHMgaWYgYG5vdGlmaWNhdGlvblRvcGljYCBpcyBkZWZpbmVkXG4gICAqL1xuICByZWFkb25seSBub3RpZmljYXRpb25FdmVudHM/OiBCYWNrdXBWYXVsdEV2ZW50c1tdO1xuXG4gIC8qKlxuICAgKiBUaGUgcmVtb3ZhbCBwb2xpY3kgdG8gYXBwbHkgdG8gdGhlIHZhdWx0LiBOb3RlIHRoYXQgcmVtb3ZpbmcgYSB2YXVsdFxuICAgKiB0aGF0IGNvbnRhaW5zIHJlY292ZXJ5IHBvaW50cyB3aWxsIGZhaWwuXG4gICAqXG4gICAqIEBkZWZhdWx0IFJlbW92YWxQb2xpY3kuUkVUQUlOXG4gICAqL1xuICByZWFkb25seSByZW1vdmFsUG9saWN5PzogUmVtb3ZhbFBvbGljeTtcblxuICAvKipcbiAgICogV2hldGhlciB0byBhZGQgc3RhdGVtZW50cyB0byB0aGUgdmF1bHQgYWNjZXNzIHBvbGljeSB0aGF0IHByZXZlbnRzIGFueW9uZVxuICAgKiBmcm9tIGRlbGV0aW5nIGEgcmVjb3ZlcnkgcG9pbnQuXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBibG9ja1JlY292ZXJ5UG9pbnREZWxldGlvbj86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyYXRpb24gZm9yIEFXUyBCYWNrdXAgVmF1bHQgTG9ja1xuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3MtYmFja3VwL2xhdGVzdC9kZXZndWlkZS92YXVsdC1sb2NrLmh0bWxcbiAgICpcbiAgICogQGRlZmF1bHQgLSBBV1MgQmFja3VwIFZhdWx0IExvY2sgaXMgZGlzYWJsZWRcbiAgICovXG4gIHJlYWRvbmx5IGxvY2tDb25maWd1cmF0aW9uPzogTG9ja0NvbmZpZ3VyYXRpb247XG59XG5cbi8qKlxuICogQmFja3VwIHZhdWx0IGV2ZW50cy4gU29tZSBldmVudHMgYXJlIG5vIGxvbmdlciBzdXBwb3J0ZWQgYW5kIHdpbGwgbm90IHJldHVyblxuICogc3RhdHVzZXMgb3Igbm90aWZpY2F0aW9ucy5cbiAqXG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3MtYmFja3VwL2xhdGVzdC9kZXZndWlkZS9BUElfUHV0QmFja3VwVmF1bHROb3RpZmljYXRpb25zLmh0bWwjQVBJX1B1dEJhY2t1cFZhdWx0Tm90aWZpY2F0aW9uc19SZXF1ZXN0Qm9keVxuICovXG5leHBvcnQgZW51bSBCYWNrdXBWYXVsdEV2ZW50cyB7XG4gIC8qKiBCQUNLVVBfSk9CX1NUQVJURUQgKi9cbiAgQkFDS1VQX0pPQl9TVEFSVEVEID0gJ0JBQ0tVUF9KT0JfU1RBUlRFRCcsXG4gIC8qKiBCQUNLVVBfSk9CX0NPTVBMRVRFRCAqL1xuICBCQUNLVVBfSk9CX0NPTVBMRVRFRCA9ICdCQUNLVVBfSk9CX0NPTVBMRVRFRCcsXG4gIC8qKiBCQUNLVVBfSk9CX1NVQ0NFU1NGVUwgKi9cbiAgQkFDS1VQX0pPQl9TVUNDRVNTRlVMID0gJ0JBQ0tVUF9KT0JfU1VDQ0VTU0ZVTCcsXG4gIC8qKiBCQUNLVVBfSk9CX0ZBSUxFRCAqL1xuICBCQUNLVVBfSk9CX0ZBSUxFRCA9ICdCQUNLVVBfSk9CX0ZBSUxFRCcsXG4gIC8qKiBCQUNLVVBfSk9CX0VYUElSRUQgKi9cbiAgQkFDS1VQX0pPQl9FWFBJUkVEID0gJ0JBQ0tVUF9KT0JfRVhQSVJFRCcsXG4gIC8qKiBSRVNUT1JFX0pPQl9TVEFSVEVEICovXG4gIFJFU1RPUkVfSk9CX1NUQVJURUQgPSAnUkVTVE9SRV9KT0JfU1RBUlRFRCcsXG4gIC8qKiBSRVNUT1JFX0pPQl9DT01QTEVURUQgKi9cbiAgUkVTVE9SRV9KT0JfQ09NUExFVEVEID0gJ1JFU1RPUkVfSk9CX0NPTVBMRVRFRCcsXG4gIC8qKiBSRVNUT1JFX0pPQl9TVUNDRVNTRlVMICovXG4gIFJFU1RPUkVfSk9CX1NVQ0NFU1NGVUwgPSAnUkVTVE9SRV9KT0JfU1VDQ0VTU0ZVTCcsXG4gIC8qKiBSRVNUT1JFX0pPQl9GQUlMRUQgKi9cbiAgUkVTVE9SRV9KT0JfRkFJTEVEID0gJ1JFU1RPUkVfSk9CX0ZBSUxFRCcsXG4gIC8qKiBDT1BZX0pPQl9TVEFSVEVEICovXG4gIENPUFlfSk9CX1NUQVJURUQgPSAnQ09QWV9KT0JfU1RBUlRFRCcsXG4gIC8qKiBDT1BZX0pPQl9TVUNDRVNTRlVMICovXG4gIENPUFlfSk9CX1NVQ0NFU1NGVUwgPSAnQ09QWV9KT0JfU1VDQ0VTU0ZVTCcsXG4gIC8qKiBDT1BZX0pPQl9GQUlMRUQgKi9cbiAgQ09QWV9KT0JfRkFJTEVEID0gJ0NPUFlfSk9CX0ZBSUxFRCcsXG4gIC8qKiBSRUNPVkVSWV9QT0lOVF9NT0RJRklFRCAqL1xuICBSRUNPVkVSWV9QT0lOVF9NT0RJRklFRCA9ICdSRUNPVkVSWV9QT0lOVF9NT0RJRklFRCcsXG4gIC8qKiBCQUNLVVBfUExBTl9DUkVBVEVEICovXG4gIEJBQ0tVUF9QTEFOX0NSRUFURUQgPSAnQkFDS1VQX1BMQU5fQ1JFQVRFRCcsXG4gIC8qKiBCQUNLVVBfUExBTl9NT0RJRklFRCAqL1xuICBCQUNLVVBfUExBTl9NT0RJRklFRCA9ICdCQUNLVVBfUExBTl9NT0RJRklFRCcsXG4gIC8qKiBTM19CQUNLVVBfT0JKRUNUX0ZBSUxFRCAqL1xuICBTM19CQUNLVVBfT0JKRUNUX0ZBSUxFRCA9ICdTM19CQUNLVVBfT0JKRUNUX0ZBSUxFRCcsXG4gIC8qKiBCQUNLVVBfUExBTl9NT0RJRklFRCAqL1xuICBTM19SRVNUT1JFX09CSkVDVF9GQUlMRUQgPSAnUzNfUkVTVE9SRV9PQkpFQ1RfRkFJTEVEJyxcbn1cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIGZvciBBV1MgQmFja3VwIFZhdWx0IExvY2tcbiAqXG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3MtYmFja3VwL2xhdGVzdC9kZXZndWlkZS92YXVsdC1sb2NrLmh0bWxcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2NrQ29uZmlndXJhdGlvbiB7XG4gIC8qKlxuICAgKiBUaGUgbWluaW11bSByZXRlbnRpb24gcGVyaW9kIHRoYXQgdGhlIHZhdWx0IHJldGFpbnMgaXRzIHJlY292ZXJ5IHBvaW50cy5cbiAgICpcbiAgICogSWYgdGhpcyBwYXJhbWV0ZXIgaXMgc3BlY2lmaWVkLCBhbnkgYmFja3VwIG9yIGNvcHkgam9iIHRvIHRoZSB2YXVsdCBtdXN0XG4gICAqIGhhdmUgYSBsaWZlY3ljbGUgcG9saWN5IHdpdGggYSByZXRlbnRpb24gcGVyaW9kIGVxdWFsIHRvIG9yIGxvbmdlciB0aGFuXG4gICAqIHRoZSBtaW5pbXVtIHJldGVudGlvbiBwZXJpb2QuIElmIHRoZSBqb2IncyByZXRlbnRpb24gcGVyaW9kIGlzIHNob3J0ZXIgdGhhblxuICAgKiB0aGF0IG1pbmltdW0gcmV0ZW50aW9uIHBlcmlvZCwgdGhlbiB0aGUgdmF1bHQgZmFpbHMgdGhhdCBiYWNrdXAgb3IgY29weSBqb2IsXG4gICAqIGFuZCB5b3Ugc2hvdWxkIGVpdGhlciBtb2RpZnkgeW91ciBsaWZlY3ljbGUgc2V0dGluZ3Mgb3IgdXNlIGEgZGlmZmVyZW50XG4gICAqIHZhdWx0LiBSZWNvdmVyeSBwb2ludHMgYWxyZWFkeSBzYXZlZCBpbiB0aGUgdmF1bHQgcHJpb3IgdG8gVmF1bHQgTG9jayBhcmVcbiAgICogbm90IGFmZmVjdGVkLlxuICAgKi9cbiAgcmVhZG9ubHkgbWluUmV0ZW50aW9uOiBEdXJhdGlvbjtcblxuICAvKipcbiAgICogVGhlIG1heGltdW0gcmV0ZW50aW9uIHBlcmlvZCB0aGF0IHRoZSB2YXVsdCByZXRhaW5zIGl0cyByZWNvdmVyeSBwb2ludHMuXG4gICAqXG4gICAqIElmIHRoaXMgcGFyYW1ldGVyIGlzIHNwZWNpZmllZCwgYW55IGJhY2t1cCBvciBjb3B5IGpvYiB0byB0aGUgdmF1bHQgbXVzdFxuICAgKiBoYXZlIGEgbGlmZWN5Y2xlIHBvbGljeSB3aXRoIGEgcmV0ZW50aW9uIHBlcmlvZCBlcXVhbCB0byBvciBzaG9ydGVyIHRoYW5cbiAgICogdGhlIG1heGltdW0gcmV0ZW50aW9uIHBlcmlvZC4gSWYgdGhlIGpvYidzIHJldGVudGlvbiBwZXJpb2QgaXMgbG9uZ2VyIHRoYW5cbiAgICogdGhhdCBtYXhpbXVtIHJldGVudGlvbiBwZXJpb2QsIHRoZW4gdGhlIHZhdWx0IGZhaWxzIHRoZSBiYWNrdXAgb3IgY29weSBqb2IsXG4gICAqIGFuZCB5b3Ugc2hvdWxkIGVpdGhlciBtb2RpZnkgeW91ciBsaWZlY3ljbGUgc2V0dGluZ3Mgb3IgdXNlIGEgZGlmZmVyZW50XG4gICAqIHZhdWx0LiBSZWNvdmVyeSBwb2ludHMgYWxyZWFkeSBzYXZlZCBpbiB0aGUgdmF1bHQgcHJpb3IgdG8gVmF1bHQgTG9jayBhcmVcbiAgICogbm90IGFmZmVjdGVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFZhdWx0IExvY2sgZG9lcyBub3QgZW5mb3JjZSBhIG1heGltdW0gcmV0ZW50aW9uIHBlcmlvZFxuICAgKi9cbiAgcmVhZG9ubHkgbWF4UmV0ZW50aW9uPzogRHVyYXRpb247XG5cbiAgLyoqXG4gICAqIFRoZSBkdXJhdGlvbiBiZWZvcmUgdGhlIGxvY2sgZGF0ZS5cbiAgICpcbiAgICogQVdTIEJhY2t1cCBlbmZvcmNlcyBhIDcyLWhvdXIgY29vbGluZy1vZmYgcGVyaW9kIGJlZm9yZSBWYXVsdCBMb2NrIHRha2VzXG4gICAqIGVmZmVjdCBhbmQgYmVjb21lcyBpbW11dGFibGUuXG4gICAqXG4gICAqIEJlZm9yZSB0aGUgbG9jayBkYXRlLCB5b3UgY2FuIGRlbGV0ZSBWYXVsdCBMb2NrIGZyb20gdGhlIHZhdWx0IG9yIGNoYW5nZVxuICAgKiB0aGUgVmF1bHQgTG9jayBjb25maWd1cmF0aW9uLiBPbiBhbmQgYWZ0ZXIgdGhlIGxvY2sgZGF0ZSwgdGhlIFZhdWx0IExvY2tcbiAgICogYmVjb21lcyBpbW11dGFibGUgYW5kIGNhbm5vdCBiZSBjaGFuZ2VkIG9yIGRlbGV0ZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gVmF1bHQgTG9jayBjYW4gYmUgZGVsZXRlZCBvciBjaGFuZ2VkIGF0IGFueSB0aW1lXG4gICAqL1xuICByZWFkb25seSBjaGFuZ2VhYmxlRm9yPzogRHVyYXRpb247XG59XG5cbmFic3RyYWN0IGNsYXNzIEJhY2t1cFZhdWx0QmFzZSBleHRlbmRzIFJlc291cmNlIGltcGxlbWVudHMgSUJhY2t1cFZhdWx0IHtcbiAgcHVibGljIGFic3RyYWN0IHJlYWRvbmx5IGJhY2t1cFZhdWx0TmFtZTogc3RyaW5nO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkgYmFja3VwVmF1bHRBcm46IHN0cmluZztcblxuICAvKipcbiAgICogR3JhbnQgdGhlIGFjdGlvbnMgZGVmaW5lZCBpbiBhY3Rpb25zIHRvIHRoZSBnaXZlbiBncmFudGVlXG4gICAqIG9uIHRoaXMgQmFja3VwIFZhdWx0IHJlc291cmNlLlxuICAgKlxuICAgKiBAcGFyYW0gZ3JhbnRlZSBQcmluY2lwYWwgdG8gZ3JhbnQgcmlnaHQgdG9cbiAgICogQHBhcmFtIGFjdGlvbnMgVGhlIGFjdGlvbnMgdG8gZ3JhbnRcbiAgICovXG4gIHB1YmxpYyBncmFudChncmFudGVlOiBpYW0uSUdyYW50YWJsZSwgLi4uYWN0aW9uczogc3RyaW5nW10pOiBpYW0uR3JhbnQge1xuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHtcbiAgICAgIGlmIChhY3Rpb24uaW5kZXhPZignKicpID49IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQVdTIEJhY2t1cCBhY2Nlc3MgcG9saWNpZXMgZG9uJ3Qgc3VwcG9ydCBhIHdpbGRjYXJkIGluIHRoZSBBY3Rpb24ga2V5LlwiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaWFtLkdyYW50LmFkZFRvUHJpbmNpcGFsKHtcbiAgICAgIGdyYW50ZWU6IGdyYW50ZWUsXG4gICAgICBhY3Rpb25zOiBhY3Rpb25zLFxuICAgICAgcmVzb3VyY2VBcm5zOiBbdGhpcy5iYWNrdXBWYXVsdEFybl0sXG4gICAgfSk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEEgYmFja3VwIHZhdWx0XG4gKi9cbmV4cG9ydCBjbGFzcyBCYWNrdXBWYXVsdCBleHRlbmRzIEJhY2t1cFZhdWx0QmFzZSB7XG4gIC8qKlxuICAgKiBJbXBvcnQgYW4gZXhpc3RpbmcgYmFja3VwIHZhdWx0IGJ5IG5hbWVcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUJhY2t1cFZhdWx0TmFtZShzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBiYWNrdXBWYXVsdE5hbWU6IHN0cmluZyk6IElCYWNrdXBWYXVsdCB7XG4gICAgY29uc3QgYmFja3VwVmF1bHRBcm4gPSBTdGFjay5vZihzY29wZSkuZm9ybWF0QXJuKHtcbiAgICAgIHNlcnZpY2U6ICdiYWNrdXAnLFxuICAgICAgcmVzb3VyY2U6ICdiYWNrdXAtdmF1bHQnLFxuICAgICAgcmVzb3VyY2VOYW1lOiBiYWNrdXBWYXVsdE5hbWUsXG4gICAgICBhcm5Gb3JtYXQ6IEFybkZvcm1hdC5DT0xPTl9SRVNPVVJDRV9OQU1FLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIEJhY2t1cFZhdWx0LmZyb21CYWNrdXBWYXVsdEFybihzY29wZSwgaWQsIGJhY2t1cFZhdWx0QXJuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbXBvcnQgYW4gZXhpc3RpbmcgYmFja3VwIHZhdWx0IGJ5IGFyblxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tQmFja3VwVmF1bHRBcm4oc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYmFja3VwVmF1bHRBcm46IHN0cmluZyk6IElCYWNrdXBWYXVsdCB7XG4gICAgY29uc3QgcGFyc2VkQXJuID0gU3RhY2sub2Yoc2NvcGUpLnNwbGl0QXJuKGJhY2t1cFZhdWx0QXJuLCBBcm5Gb3JtYXQuQ09MT05fUkVTT1VSQ0VfTkFNRSk7XG5cbiAgICBpZiAocGFyc2VkQXJuLmFybkZvcm1hdCAhPT0gQXJuRm9ybWF0LkNPTE9OX1JFU09VUkNFX05BTUUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQmFja3VwIFZhdWx0IEFybiAke2JhY2t1cFZhdWx0QXJufSBoYXMgdGhlIHdyb25nIGZvcm1hdCwgZXhwZWN0ZWQgJHtBcm5Gb3JtYXQuQ09MT05fUkVTT1VSQ0VfTkFNRX0uYCk7XG4gICAgfVxuICAgIGlmICghcGFyc2VkQXJuLnJlc291cmNlTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBCYWNrdXAgVmF1bHQgQXJuICR7YmFja3VwVmF1bHRBcm59IGRvZXMgbm90IGhhdmUgYSByZXNvdXJjZSBuYW1lLmApO1xuICAgIH1cblxuICAgIGNsYXNzIEltcG9ydCBleHRlbmRzIEJhY2t1cFZhdWx0QmFzZSB7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgYmFja3VwVmF1bHROYW1lID0gcGFyc2VkQXJuLnJlc291cmNlTmFtZSE7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgYmFja3VwVmF1bHRBcm4gPSBiYWNrdXBWYXVsdEFybjtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEltcG9ydChzY29wZSwgaWQsIHtcbiAgICAgIGFjY291bnQ6IHBhcnNlZEFybi5hY2NvdW50LFxuICAgICAgcmVnaW9uOiBwYXJzZWRBcm4ucmVnaW9uLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IGJhY2t1cFZhdWx0TmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgYmFja3VwVmF1bHRBcm46IHN0cmluZztcblxuICBwcml2YXRlIHJlYWRvbmx5IGFjY2Vzc1BvbGljeTogaWFtLlBvbGljeURvY3VtZW50O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBCYWNrdXBWYXVsdFByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgaWYgKHByb3BzLmJhY2t1cFZhdWx0TmFtZSAmJiAhL15bYS16QS1aMC05XFwtX117Miw1MH0kLy50ZXN0KHByb3BzLmJhY2t1cFZhdWx0TmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgdmF1bHQgbmFtZSB0byBtYXRjaCBwYXR0ZXJuIGBeW2EtekEtWjAtOVxcLV9dezIsNTB9JGAnKTtcbiAgICB9XG5cbiAgICBsZXQgbm90aWZpY2F0aW9uczogQ2ZuQmFja3VwVmF1bHQuTm90aWZpY2F0aW9uT2JqZWN0VHlwZVByb3BlcnR5IHwgdW5kZWZpbmVkO1xuICAgIGlmIChwcm9wcy5ub3RpZmljYXRpb25Ub3BpYykge1xuICAgICAgbm90aWZpY2F0aW9ucyA9IHtcbiAgICAgICAgYmFja3VwVmF1bHRFdmVudHM6IHByb3BzLm5vdGlmaWNhdGlvbkV2ZW50cyB8fCBPYmplY3QudmFsdWVzKEJhY2t1cFZhdWx0RXZlbnRzKSxcbiAgICAgICAgc25zVG9waWNBcm46IHByb3BzLm5vdGlmaWNhdGlvblRvcGljLnRvcGljQXJuLFxuICAgICAgfTtcbiAgICAgIHByb3BzLm5vdGlmaWNhdGlvblRvcGljLmdyYW50UHVibGlzaChuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2JhY2t1cC5hbWF6b25hd3MuY29tJykpO1xuICAgIH1cblxuICAgIHRoaXMuYWNjZXNzUG9saWN5ID0gcHJvcHMuYWNjZXNzUG9saWN5ID8/IG5ldyBpYW0uUG9saWN5RG9jdW1lbnQoKTtcbiAgICBpZiAocHJvcHMuYmxvY2tSZWNvdmVyeVBvaW50RGVsZXRpb24pIHtcbiAgICAgIHRoaXMuYmxvY2tSZWNvdmVyeVBvaW50RGVsZXRpb24oKTtcbiAgICB9XG5cbiAgICBjb25zdCB2YXVsdCA9IG5ldyBDZm5CYWNrdXBWYXVsdCh0aGlzLCAnUmVzb3VyY2UnLCB7XG4gICAgICBiYWNrdXBWYXVsdE5hbWU6IHByb3BzLmJhY2t1cFZhdWx0TmFtZSB8fCB0aGlzLnVuaXF1ZVZhdWx0TmFtZSgpLFxuICAgICAgYWNjZXNzUG9saWN5OiBMYXp5LmFueSh7IHByb2R1Y2U6ICgpID0+IHRoaXMuYWNjZXNzUG9saWN5LnRvSlNPTigpIH0pLFxuICAgICAgZW5jcnlwdGlvbktleUFybjogcHJvcHMuZW5jcnlwdGlvbktleSAmJiBwcm9wcy5lbmNyeXB0aW9uS2V5LmtleUFybixcbiAgICAgIG5vdGlmaWNhdGlvbnMsXG4gICAgICBsb2NrQ29uZmlndXJhdGlvbjogcmVuZGVyTG9ja0NvbmZpZ3VyYXRpb24ocHJvcHMubG9ja0NvbmZpZ3VyYXRpb24pLFxuICAgIH0pO1xuICAgIHZhdWx0LmFwcGx5UmVtb3ZhbFBvbGljeShwcm9wcy5yZW1vdmFsUG9saWN5KTtcblxuICAgIHRoaXMuYmFja3VwVmF1bHROYW1lID0gdmF1bHQuYXR0ckJhY2t1cFZhdWx0TmFtZTtcbiAgICB0aGlzLmJhY2t1cFZhdWx0QXJuID0gdmF1bHQuYXR0ckJhY2t1cFZhdWx0QXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdGF0ZW1lbnQgdG8gdGhlIHZhdWx0IGFjY2VzcyBwb2xpY3lcbiAgICovXG4gIHB1YmxpYyBhZGRUb0FjY2Vzc1BvbGljeShzdGF0ZW1lbnQ6IGlhbS5Qb2xpY3lTdGF0ZW1lbnQpIHtcbiAgICB0aGlzLmFjY2Vzc1BvbGljeS5hZGRTdGF0ZW1lbnRzKHN0YXRlbWVudCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0YXRlbWVudCB0byB0aGUgdmF1bHQgYWNjZXNzIHBvbGljeSB0aGF0IHByZXZlbnRzIGFueW9uZVxuICAgKiBmcm9tIGRlbGV0aW5nIGEgcmVjb3ZlcnkgcG9pbnQuXG4gICAqL1xuICBwdWJsaWMgYmxvY2tSZWNvdmVyeVBvaW50RGVsZXRpb24oKSB7XG4gICAgdGhpcy5hZGRUb0FjY2Vzc1BvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuREVOWSxcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgJ2JhY2t1cDpEZWxldGVSZWNvdmVyeVBvaW50JyxcbiAgICAgICAgJ2JhY2t1cDpVcGRhdGVSZWNvdmVyeVBvaW50TGlmZWN5Y2xlJyxcbiAgICAgIF0sXG4gICAgICBwcmluY2lwYWxzOiBbbmV3IGlhbS5BbnlQcmluY2lwYWwoKV0sXG4gICAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgdW5pcXVlVmF1bHROYW1lKCkge1xuICAgIC8vIE1heCBsZW5ndGggb2YgNTAgY2hhcnMsIGdldCB0aGUgbGFzdCA1MCBjaGFyc1xuICAgIGNvbnN0IGlkID0gTmFtZXMudW5pcXVlSWQodGhpcyk7XG4gICAgcmV0dXJuIGlkLnN1YnN0cmluZyhNYXRoLm1heChpZC5sZW5ndGggLSA1MCwgMCksIGlkLmxlbmd0aCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyTG9ja0NvbmZpZ3VyYXRpb24oY29uZmlnPzogTG9ja0NvbmZpZ3VyYXRpb24pOiBDZm5CYWNrdXBWYXVsdC5Mb2NrQ29uZmlndXJhdGlvblR5cGVQcm9wZXJ0eSB8IHVuZGVmaW5lZCB7XG4gIGlmICghY29uZmlnKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGlmIChjb25maWcuY2hhbmdlYWJsZUZvciAmJiBjb25maWcuY2hhbmdlYWJsZUZvci50b0hvdXJzKCkgPCA3Mikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQVdTIEJhY2t1cCBlbmZvcmNlcyBhIDcyLWhvdXIgY29vbGluZy1vZmYgcGVyaW9kIGJlZm9yZSBWYXVsdCBMb2NrIHRha2VzIGVmZmVjdCBhbmQgYmVjb21lcyBpbW11dGFibGUsIGdvdCAke2NvbmZpZy5jaGFuZ2VhYmxlRm9yLnRvSG91cnMoKX0gaG91cnNgKTtcbiAgfVxuXG4gIGlmIChjb25maWcubWF4UmV0ZW50aW9uKSB7XG4gICAgaWYgKGNvbmZpZy5tYXhSZXRlbnRpb24udG9EYXlzKCkgPiAzNjUwMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbG9uZ2VzdCBtYXhpbXVtIHJldGVudGlvbiBwZXJpb2QgeW91IGNhbiBzcGVjaWZ5IGlzIDM2NTAwIGRheXMsIGdvdCAke2NvbmZpZy5tYXhSZXRlbnRpb24udG9EYXlzKCl9IGRheXNgKTtcbiAgICB9XG4gICAgaWYgKGNvbmZpZy5tYXhSZXRlbnRpb24udG9EYXlzKCkgPD0gY29uZmlnLm1pblJldGVudGlvbi50b0RheXMoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbWF4aW11bSByZXRlbnRpb24gcGVyaW9kICgke2NvbmZpZy5tYXhSZXRlbnRpb24udG9EYXlzKCl9IGRheXMpIG11c3QgYmUgZ3JlYXRlciB0aGFuIHRoZSBtaW5pbXVtIHJldGVudGlvbiBwZXJpb2QgKCR7Y29uZmlnLm1pblJldGVudGlvbi50b0RheXMoKX0gZGF5cylgKTtcbiAgICB9XG4gIH1cblxuICBpZiAoY29uZmlnLm1pblJldGVudGlvbi50b0hvdXJzKCkgPCAyNCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNob3J0ZXN0IG1pbmltdW0gcmV0ZW50aW9uIHBlcmlvZCB5b3UgY2FuIHNwZWNpZnkgaXMgMSBkYXksIGdvdCAke2NvbmZpZy5taW5SZXRlbnRpb24udG9Ib3VycygpfSBob3Vyc2ApO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBtaW5SZXRlbnRpb25EYXlzOiBjb25maWcubWluUmV0ZW50aW9uLnRvRGF5cygpLFxuICAgIG1heFJldGVudGlvbkRheXM6IGNvbmZpZy5tYXhSZXRlbnRpb24/LnRvRGF5cygpLFxuICAgIGNoYW5nZWFibGVGb3JEYXlzOiBjb25maWcuY2hhbmdlYWJsZUZvcj8udG9EYXlzKCksXG4gIH07XG59XG4iXX0=